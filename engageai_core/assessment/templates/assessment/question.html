{% extends 'base.html' %}
{% load static %}

{% block title %}–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ | EngageAI{% endblock title %}

{% block css %}
<link href="{% static 'css/index.css' %}" rel="stylesheet">
<link href="{% static 'css/assessment.css' %}" rel="stylesheet">
<link href="{% static 'css/users/user.css' %}" rel="stylesheet">
<link href="{% static 'css/users/auth.css' %}" rel="stylesheet">
{% endblock css %}


{% block content %}
<section class="test">
    <div class="test__container container">
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="test__progress">
            <div class="test-progress">
                <div class="test-progress__header">
                    <h2 class="test-progress__title">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è CEFR</h2>
                    <div class="test-progress__stats">
                        <span class="test-progress__current">–í–æ–ø—Ä–æ—Å {{ question_number|default:1 }}</span>
                        <span class="test-progress__total">–∏–∑ {{ total_questions|default:20 }}</span>
                    </div>
                </div>
                
                <div class="test-progress__bar">
                    <div class="test-progress__fill" 
                         style="width: {% widthratio question_number|default:1 total_questions|default:20 100 %}%">
                    </div>
                </div>
                
                <div class="test-progress__hint">
                    üéØ –¢–µ—Å—Ç –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ -->
        <div class="test__question card">
            <div class="question">
                <div class="question__header">
                    <div class="question__type">
                        {% if question.options %}
                            <span class="question-type-badge">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç</span>
                        {% else %}
                            <span class="question-type-badge">–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç</span>
                        {% endif %}
                    </div>
                    <div class="question__timer" id="question-timer">
                        <span class="timer__icon">‚è±Ô∏è</span>
                        <span class="timer__text">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 2 –º–∏–Ω—É—Ç—ã</span>
                    </div>
                </div>

                <div class="question__content">
                    {% if text_content %}
                      <div class="reading-passage">
                        <div class="reading-passage__header">
                          <h4 class="reading-passage__title">–¢–µ–∫—Å—Ç:</h4>
                        </div>
                        <div class="reading-passage__content">
                          {{ text_content|linebreaks }}
                        </div>
                      </div>
                      
                      <div class="reading-question">
                        <div class="reading-question__header">
                          <h4 class="reading-question__title">–í–æ–ø—Ä–æ—Å:</h4>
                        </div>
                        <h3 class="question__text">{{ question_content }}</h3>
                      </div>
                    {% else %}
                      <h3 class="question__text">{{ question.question_text }}</h3>
                    {% endif %}
                    
                    {% if question.instruction %}
                    <div class="question__instruction">
                        <div class="instruction__icon">üí°</div>
                        <div class="instruction__text">{{ question.instruction }}</div>
                    </div>
                    {% endif %}
                    {{ question }}
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
                <div class="question__form">
                    {% if question.options %}
                        <!-- –í–æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ -->
                        <form method="post" action="{% url 'assessment:question_view' session.id %}" class="options-form">
                            {% csrf_token %}
                            {{ form.session_id }}
                            {{ form.question_instance_id }}
                            
                            <div class="options-grid">
                                {% for opt in question.options %}
                                    <label class="option-card">
                                        <input type="radio" name="answer_text" value="{{ opt }}" required class="option-card__input">
                                        <div class="option-card__content">
                                            <div class="option-card__text">{{ opt }}</div>
                                            <div class="option-card__check"></div>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                            
                            <div class="question__actions">
                                <button type="submit" class="btn btn_primary btn_lg question__submit">
                                    <span class="btn__icon">üöÄ</span>
                                    –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å -->
                        <form method="post" action="{% url 'assessment:question_view' session.id %}" class="text-form">
                            {% csrf_token %}
                            {{ form.session_id }}
                            {{ form.question_instance_id }}
                            
                            <div class="text-answer">
                                <div class="form-field">
                                    <label for="{{ form.answer_text.id_for_label }}" class="form-field__label">
                                        –í–∞—à –æ—Ç–≤–µ—Ç
                                    </label>
                                    <div class="input-wrapper">
                                        {{ form.answer_text }}
                                    </div>
                                    {% if form.answer_text.errors %}
                                    <div class="form-field__errors">
                                        {{ form.answer_text.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="question__actions">
                                <button type="submit" class="btn btn_primary btn_lg question__submit">
                                    <span class="btn__icon">üìù</span>
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                                </button>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="test__sidebar">
            <div class="test-info card">
                <h4 class="test-info__title">–û —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h4>
                <div class="test-info__content">
                    <div class="info-item">
                        <div class="info-item__icon">üéØ</div>
                        <div class="info-item__content">
                            <strong>–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç</strong>
                            <p>–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤ –º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤</p>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-item__icon">üìä</div>
                        <div class="info-item__content">
                            <strong>4 –Ω–∞–≤—ã–∫–∞</strong>
                            <p>–¢–µ—Å—Ç–∏—Ä—É–µ–º –≥—Ä–∞–º–º–∞—Ç–∏–∫—É, —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å, –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–∏—Å—å–º–æ</p>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-item__icon">‚è±Ô∏è</div>
                        <div class="info-item__content">
                            <strong>15-20 –º–∏–Ω—É—Ç</strong>
                            <p>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ–≥–æ —Ç–µ—Å—Ç–∞</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="test-tips card">
                <h4 class="test-tips__title">–°–æ–≤–µ—Ç—ã</h4>
                <ul class="test-tips__list">
                    <li class="test-tips__item">‚úÖ –û—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ, –Ω–µ —É–≥–∞–¥—ã–≤–∞–π—Ç–µ</li>
                    <li class="test-tips__item">‚úÖ –ù–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ—Å—å –¥–æ–ª–≥–æ –Ω–∞ –æ–¥–Ω–æ–º –≤–æ–ø—Ä–æ—Å–µ</li>
                    <li class="test-tips__item">‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è</li>
                    <li class="test-tips__item">‚úÖ –†–∞—Å—Å–ª–∞–±—å—Ç–µ—Å—å - —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç üòä</li>
                </ul>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –¢–∞–π–º–µ—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    let timeSpent = 0;
    const timerElement = document.getElementById('question-timer');
    
    if (timerElement) {
        setInterval(function() {
            timeSpent++;
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            // timerElement.querySelector('.timer__text').textContent = 
            //     `–í—Ä–µ–º—è: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
    const optionCards = document.querySelectorAll('.option-card');
    optionCards.forEach(card => {
        card.addEventListener('click', function() {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            optionCards.forEach(c => c.classList.remove('option-card--selected'));
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            this.classList.add('option-card--selected');
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫—É
            this.querySelector('.option-card__input').checked = true;
        });
    });
    
    // –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    const textAnswer = document.querySelector('.text-answer textarea');
    if (textAnswer) {
        textAnswer.focus();
    }
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const forms = document.querySelectorAll('.options-form, .text-form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('.question__submit');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="btn__icon">‚è≥</span>–û—Ç–ø—Ä–∞–≤–∫–∞...';
            }
        });
    });
});
</script>
{% endblock script %}