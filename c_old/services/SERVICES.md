# curriculum.services — Application services
Этот документ описывает **application‑слой** модуля `curriculum`.
Services:
- координируют поток обучения
- работают поверх domain‑моделей
- НЕ хранят состояние
- НЕ принимают UI / LLM‑решений
Их задача — **соединить доменные факты в корректный flow**.

**Ключевой принцип:** каждый сервис имеет строго определенную ответственность и работает с доменными объектами, не нарушая их инварианты. Сервисы не взаимодействуют напрямую с UI или внешними API, они обеспечивают чистую бизнес-логику.

---
## 1. Роль services в архитектуре
`services` — это **application layer**, а не domain и не infrastructure.
Они:
- получают входные данные (response, enrollment, context)
- вызывают доменные операции
- сохраняют результаты (через models)
- возвращают структурированный результат
❗ Services не должны:
- держать состояние между вызовами
- напрямую обращаться к LLM
- формировать UI‑ответы

Сервисы инкапсулируют бизнес-логику и обеспечивают четкое разделение ответственности между слоями архитектуры.

---
## 2. Общий flow (service‑level)
LearningService
↓
AssessmentService
↓
SkillUpdateService
↓
DecisionService
↓
TransitionRecorder

Дополнительно:
- `CurriculumQuery` используется для чтения структуры
- `ProgressionService` управляет выбором следующего шага

Последовательность сервисов отражает логический поток обработки одного шага обучения, где каждый сервис выполняет свою узкоспециализированную задачу.

---
## 3. Основные сервисы
### LearningService
**Роль:**
- основной entrypoint обучающего процесса
- связывает response → assessment → decision
**Типичный вход:**
- enrollment
- student_response
**Типичный выход:**
- decision_code
- next_lesson / task
- explanation (через explainability)

LearningService координирует все этапы обучения, но не принимает решений и не хранит состояние, что обеспечивает масштабируемость и тестируемость.

### AssessmentService
**Роль:**
- оценка StudentResponse
**Гарантии:**
- всегда создаёт Assessment
- Assessment неизменяем

AssessmentService инкапсулирует логику оценки ответов студентов, используя различные адаптеры в зависимости от типа задания, и гарантирует создание неизменяемого факта оценки.

### SkillUpdateService
**Роль:**
- координация обновления навыков
**Что делает:**
- создаёт SkillSnapshot
- вызывает SkillTrajectoryUpdater
**Важно:**
- не содержит формул
- делегирует расчёты специализированным компонентам

Сервис обновления навыков отвечает за сохранение текущего состояния студента и координацию с другими компонентами по обновлению траекторий навыков.

### SkillTrajectoryUpdater
**Роль:**
- обновление SkillTrajectory
**Использует:**
- Assessment
- SkillSnapshot
**Гарантии:**
- один trajectory на (student, skill)

SkillTrajectoryUpdater вычисляет агрегированные метрики прогресса (тренды, стабильность), используя историю снимков навыков студента для каждого конкретного умения.

### DecisionService
**Роль:**
- выбор следующего шага обучения
**Вход:**
- Assessment
- SkillTrajectory
- context
**Выход:**
- decision_code
❗ DecisionService не знает, как выполняется переход.

Сервис принятия решений анализирует состояние студента и результаты оценки, чтобы определить оптимальный следующий шаг в обучении, сохраняя при этом чистоту доменных объектов.

### ProgressionService
**Роль:**
- интерпретация decision_code
- выбор следующего Lesson / Task

ProgressionService преобразует абстрактное решение системы в конкретные действия по управлению прогрессом обучения, обновляя состояние зачисления студента.

### TransitionRecorder
**Роль:**
- запись LessonTransition
**Гарантии:**
- LessonTransition immutable
- запись происходит один раз

TransitionRecorder фиксирует все детали перехода в обучении как неизменяемый факт, что обеспечивает аудит и объяснимость системы.

---
## 4. Вспомогательные сервисы
### CurriculumQuery
**Роль:**
- чтение структуры курса
Используется:
- LearningService
- ProgressionService

CurriculumQuery предоставляет read-only доступ к учебному контенту с инкапсуляцией бизнес-правил выбора последовательности уроков и заданий.

### EnrollmentService
**Роль:**
- управление зачислениями студентов
- расчет общего прогресса по курсу

EnrollmentService инкапсулирует логику работы с зачислениями студентов, включая создание новых зачислений и расчет общего прогресса в курсе.

### ExplainabilityService
**Роль:**
- формирование объяснений для студентов и преподавателей
- анализ траекторий навыков

ExplainabilityService преобразует технические метрики и решения системы в понятные объяснения для разных аудиторий, сохраняя при этом прозрачность алгоритмов.

---
## 5. Взаимодействие с explainability
Services:
- НЕ формируют объяснения
- передают факты в explainability слой
Explainability:
- читает LessonTransition
- читает Assessment / SkillSnapshot
- возвращает dict

Объяснимость полностью отделена от основной бизнес-логики и реализована как отдельный слой, что позволяет гибко настраивать объяснения под разные аудитории без изменения основного кода.

---
## 6. Инварианты
- Services stateless
- Один сервис — одна ответственность
- Нет циклических вызовов
- Нет сохранения состояния между шагами
- Все доменные объекты неизменяемы после создания

Эти инварианты обеспечивают предсказуемость поведения системы и упрощают отладку и тестирование.

---
## 8. TODO / точки развития
- Policy‑based DecisionService
- Replay flow на основе LessonTransition
- Simulation / what‑if режим
- Интеграция с внешними системами через события
- Batch-обработка для масштабирования
- Поддержка multi-tenant архитектуры
- Версионирование схем контента заданий

Эти направления развития направлены на улучшение масштабируемости, объяснимости и расширение функциональности системы.