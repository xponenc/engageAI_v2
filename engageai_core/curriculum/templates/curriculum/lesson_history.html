{% extends 'extended/assistant_layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Ä–æ–∫–∞ ‚Äî {{ lesson.title }}{% endblock %}

{% block assistant_css %}
<link href="{% static 'css/learning-session.css' %}" rel="stylesheet">
<link href="{% static 'css/course-history.css' %}" rel="stylesheet">
<link href="{% static 'css/lesson-history.css' %}" rel="stylesheet">
{% endblock %}

{% block assistant_content %}
<div class="lesson-history">
    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav class="lesson-history__breadcrumbs breadcrumbs">
        <a href="#" class="breadcrumbs__link">–ì–ª–∞–≤–Ω–∞—è</a>
        <span class="breadcrumbs__separator">/</span>
        <a href="#" class="breadcrumbs__link">{{ lesson.course.title }}</a>
        <span class="breadcrumbs__separator">/</span>
        <span class="breadcrumbs__current">{{ lesson.title }}</span>
    </nav>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞ -->
    <header class="lesson-history__header header">
        <h1 class="header__title">{{ lesson.title }}</h1>
        <div class="header__meta">
            <span class="header__course">{{ lesson.course.title }}</span>
            <span class="header__duration">
                <svg class="header__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13.5v6l5 2.5-1 2-6-3V7h2z" fill="currentColor"/>
                </svg>
                {{ lesson.duration_minutes }} –º–∏–Ω
            </span>
            <span class="header__level">
                <svg class="header__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2"/>
                </svg>
                CEFR {{ lesson.required_cefr }}
            </span>
        </div>
        <div class="header__skills">
            {% for skill in lesson.skill_focus %}
                <span class="header__skill-badge skill-badge skill-badge--{{ skill }}">
                    {{ skill|capfirst }}
                </span>
            {% endfor %}
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="lesson-history__content content">
        {% if lesson_assessment %}
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±—â–µ–π –æ—Ü–µ–Ω–∫–∏ -->
        <section class="content__section assessment-overview">
            <h2 class="assessment-overview__title">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Ä–æ–∫–∞ {% widthratio lesson_assessment.overall_score 1 100|default:0 %}%</h2>
            
            <div class="assessment-overview__score-card score-card">
                <div class="score-card__circle">
                    <div class="score-card__percentage" style="--score: {% widthratio lesson_assessment.overall_score 1 100|default:0 %}%">
                        <span>{% widthratio lesson_assessment.overall_score 1 100|default:0 %}%</span>
                    </div>
                </div>
                <div class="score-card__details">
                    <div class="score-card__status status-badge status-badge--{{ lesson_assessment.status|lower }}">
                        {% if lesson_assessment.status == 'COMPLETED' %}
                            ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                        {% elif lesson_assessment.status == 'PENDING' %}
                            ‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ—Ü–µ–Ω–∫–∏
                        {% elif lesson_assessment.status == 'ERROR' %}
                            ‚ùå –û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏
                        {% endif %}
                    </div>
                    <div class="score-card__stats">
                        <div class="score-card__stat">
                            <span class="score-card__stat-label">–ó–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                            <span class="score-card__stat-value">
                                {{ completed_tasks_count }}/{{ total_tasks_count }}
                            </span>
                        </div>
                        <div class="score-card__stat">
                            <span class="score-card__stat-label">–í—Ä–µ–º—è –∑–∞–Ω—è—Ç–∏—è</span>
                            <span class="score-card__stat-value">
                                {{ lesson_duration }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        {% endif %}
        <!-- –°–µ–∫—Ü–∏—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –Ω–∞–≤—ã–∫–æ–≤ -->
        {% if skill_comparisons %}
        <div class="skills-comparison _mb">
            <h4 class="skills-comparison__title">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–∞–≤—ã–∫–∞–º</h4>
            <div class="skills-comparison__grid">
                {% for skill in skill_comparisons %}
                <div class="skill-comparison-item">
                    <div class="skill-comparison-item__header">
                        <span class="skill-comparison-item__name">{{ skill.name }}</span>
                        <span class="skill-comparison-item__delta 
                            {% if skill.delta_positive %}skill-comparison-item__delta--positive
                            {% else %}skill-comparison-item__delta--negative{% endif %}">
                            {{ skill.delta_formatted }}
                        </span>
                    </div>
                    <div class="skill-comparison-item__bars">
                        <div class="skill-bar">
                            <span class="skill-bar__label">–ù–∞—á–∞–ª–æ</span>
                            <div class="skill-bar__progress">
                                <div class="skill-bar__fill skill-bar__fill--initial" 
                                    style="width: {% widthratio skill.initial 1 100 %}%">
                                </div>
                            </div>
                        </div>
                        <div class="skill-bar">
                            <span class="skill-bar__label">–°–µ–π—á–∞—Å</span>
                            <div class="skill-bar__progress">
                                <div class="skill-bar__fill skill-bar__fill--current" 
                                    style="width: {% widthratio skill.current 1 100 %}%">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <!-- –†–∞–¥–∞—Ä-—á–∞—Ä—Ç –Ω–∞–≤—ã–∫–æ–≤ -->
        {% if skill_snapshot %}
        <section class="content__section skills-radar _mb">
            <h2 class="skills-radar__title">–í–∞—à —É—Ä–æ–≤–µ–Ω—å –Ω–∞–≤—ã–∫–æ–≤</h2>
            
            <div class="skills-radar__chart">
                <canvas id="skillsRadarChart" height="300"></canvas>
            </div>
            
            {% if previous_skill_snapshot %}
            <div class="skills-radar__legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(99, 102, 241, 0.8);"></span>
                    <span>–ü–æ—Å–ª–µ —É—Ä–æ–∫–∞</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: rgba(245, 158, 11, 0.8);"></span>
                    <span>–î–æ —É—Ä–æ–∫–∞</span>
                </div>
            </div>
            {% endif %}
        </section>
        {% endif %}
        <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ (–¥–µ–ª—å—Ç–∞) -->
        {% if skill_delta %}
        <div class="assessment-overview__delta skill-delta _mb">
            <h3 class="skill-delta__title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –ø–æ—Å–ª–µ —É—Ä–æ–∫–∞</h3>
            <div class="skill-delta__grid">
                {% for skill_name, delta_value in skill_delta.deltas.items %}
                    {% if skill_name != 'overall' %}
                        <div class="skill-delta__item">
                            <span class="skill-delta__skill">{{ skill_name|capfirst }}</span>
                            <span class="skill-delta__value 
                                {% if delta_value > 0 %}skill-delta__value--positive
                                {% elif delta_value < 0 %}skill-delta__value--negative{% endif %}">
                                {% if delta_value > 0 %}+{% endif %}{{ delta_value|floatformat:2 }}
                            </span>
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="skill-delta__item skill-delta__item--overall">
                    <span class="skill-delta__skill">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span class="skill-delta__value 
                        {% if skill_delta.deltas.overall > 0 %}skill-delta__value--positive
                        {% elif skill_delta.deltas.overall < 0 %}skill-delta__value--negative{% endif %}">
                        {% if skill_delta.deltas.overall > 0 %}+{% endif %}{{ skill_delta.deltas.overall|floatformat:2 }}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- –£—á–µ–±–Ω—ã–µ —Ü–µ–ª–∏ -->
        {% if lesson.learning_objectives.all %}
        <section class="content__section learning-objectives">
            <h2 class="learning-objectives__title">–£—á–µ–±–Ω—ã–µ —Ü–µ–ª–∏ —É—Ä–æ–∫–∞</h2>
            <div class="learning-objectives__list">
                {% for objective in lesson.learning_objectives.all %}
                    <div class="learning-objective">
                        <span class="learning-objective__id">{{ objective.identifier }}</span>
                        <p class="learning-objective__name">{{ objective.name }}</p>
                    </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {% if lesson.content or lesson.content_ru %}
            <section class="lesson-theory-tabs">
                <!-- TAB NAVIGATION -->
                <div class="lesson-theory-tabs__nav">
                    {% if lesson.content %}
                        <button 
                            type="button" 
                            class="lesson-theory-tabs__tab lesson-theory-tabs__tab--active" 
                            data-tab="en">
                            Lesson Theory
                        </button>
                    {% endif %}
                    
                    {% if lesson.content_ru %}
                        <button 
                            type="button" 
                            class="lesson-theory-tabs__tab" 
                            data-tab="ru">
                            –¢–µ–æ—Ä–∏—è —É—Ä–æ–∫–∞
                        </button>
                    {% endif %}

                    <button
                        class="btn btn_reset btn_round btn_round-small chat-action-trigger lesson-theory-tabs__question"
                        data-context-type="Lesson"
                        data-context-id="{{ lesson.id }}"
                        data-context-prefix="–ü–æ—è—Å–Ω–∏ –º–Ω–µ —ç—Ç–æ—Ç —É—Ä–æ–∫"
                        title="–í–æ–ø—Ä–æ—Å –ø–æ —É—Ä–æ–∫—É"
                        aria-label="–í–æ–ø—Ä–æ—Å –ø–æ —É—Ä–æ–∫—É"
                    >
                        <span class="btn__icon">?</span>
                    </button>
                </div>

                <!-- TAB CONTENT -->
                <div class="lesson-theory-tabs__content">
                    {% if lesson.content %}
                        <div id="tab-en" class="lesson-theory-tabs__panel lesson-theory-tabs__panel--active word-helper">
                            {{ lesson.content|safe }}
                        </div>
                    {% endif %}
                    
                    {% if lesson.content_ru %}
                        <div id="tab-ru" class="lesson-theory-tabs__panel word-helper">
                            {{ lesson.content_ru|safe }}
                        </div>
                    {% endif %}
                </div>
            </section>
        {% endif %}

        <!-- –†–µ–∑—é–º–µ –æ—Ç AI -->
        {% if lesson_assessment.llm_summary or lesson_assessment.llm_recommendations %}
        <section class="content__section ai-summary">
            <h2 class="ai-summary__title">
                <svg class="ai-summary__icon" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                –ê–Ω–∞–ª–∏–∑ –æ—Ç AI-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞
            </h2>
            
            {% if lesson_assessment.llm_summary %}
            <div class="ai-summary__box">
                <h3 class="ai-summary__subtitle">–†–µ–∑—é–º–µ</h3>
                <p class="ai-summary__text">{{ lesson_assessment.llm_summary }}</p>
            </div>
            {% endif %}
            
            {% if lesson_assessment.llm_recommendations %}
            <div class="ai-summary__box ai-summary__box--recommendations">
                <h3 class="ai-summary__subtitle">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <div class="ai-summary__recommendations">
                    {{ lesson_assessment.llm_recommendations }}
                </div>
            </div>
            {% endif %}
        </section>
        {% endif %}

        {% if tasks %}
            <!-- –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏–π -->
            <section class="content__section tasks-details">
                <h2 class="tasks-details__title">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏–π</h2>
                <p class="tasks-details__subtitle">
                    –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ completed_tasks_count }}/{{ total_tasks_count }} –∑–∞–¥–∞–Ω–∏–π
                </p>

                <div class="tasks-details__list">
                    {% for task in tasks %}
                    <div class="task-card{% if task.student_responses_for_enrollment %} task-card--completed{% else %} task-card--pending{% endif %}">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞–Ω–∏—è -->
                        <div class="task-card__header">
                            <div class="task-card__info">
                                <span class="task-card__type task-type task-type--{{ task.task_type }}">
                                    {{ task.get_task_type_display }}
                                </span>
                                <span class="task-card__format">
                                    {{ task.get_response_format_display }}
                                </span>
                            </div>
                            <div class="task-card__status">
                                {% if task.student_responses_for_enrollment %}
                                    {% with response=task.student_responses_for_enrollment.0 assessment=task.student_responses_for_enrollment.0.assessment %}
                                        {% if assessment %}
                                            {% if assessment.is_correct != None %}
                                                {% if assessment.is_correct %}
                                                    <span class="status-indicator status-indicator--correct" title="–ü—Ä–∞–≤–∏–ª—å–Ω–æ">‚úì</span>
                                                {% else %}
                                                    <span class="status-indicator status-indicator--incorrect" title="–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ">‚úó</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="status-indicator status-indicator--partial" title="–ß–∞—Å—Ç–∏—á–Ω–æ">~</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-indicator status-indicator--pending" title="–û–∂–∏–¥–∞–µ—Ç –æ—Ü–µ–Ω–∫–∏">?</span>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <span class="status-indicator status-indicator--locked" title="–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ">üîí</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–¥–∞–Ω–∏—è -->
                        <div class="task-card__content">
                            <h3 class="task-card__title">{{ task.content.prompt }}</h3>
                            
                            <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                            {% if task.content.options %}
                            <div class="task-card__options options-list">
                                <div class="options-list__header">
                                    <span class="options-list__label">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:</span>
                                </div>
                                <ul class="options-list__items">
                                    {% for option in task.content.options %}
                                    <li class="options-list__item 
                                        {% if forloop.counter0 in task.content.correct_indices or forloop.counter0 == task.content.correct_idx %}options-list__item--correct{% endif %}">
                                        <span class="options-list__marker">
                                            {{ forloop.counter }}.
                                        </span>
                                        <span class="options-list__text">{{ option }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                            {% if task.content.explanation %}
                            <div class="task-card__explanation explanation-box">
                                <div class="explanation-box__header">
                                    <svg class="explanation-box__icon" width="20" height="20" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                                    </svg>
                                    <span class="explanation-box__title">–ü–æ—è—Å–Ω–µ–Ω–∏–µ</span>
                                </div>
                                <div class="explanation-box__content">
                                    {{ task.content.explanation }}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- –û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                        {% if task.student_responses_for_enrollment %}
                            {% with response=task.student_responses_for_enrollment.0 assessment=task.student_responses_for_enrollment.0.assessment %}
                            <div class="task-card__response student-response">
                                <div class="student-response__header">
                                    <span class="student-response__label">–í–∞—à –æ—Ç–≤–µ—Ç:</span>
                                    <span class="student-response__submitted">
                                        <svg class="student-response__icon" width="16" height="16" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13.5v6l5 2.5-1 2-6-3V7h2z"/>
                                        </svg>
                                        {{ response.submitted_at|date:"d.m.Y H:i" }}
                                    </span>
                                </div>
                                <div class="student-response__content">
                                    {% if response.response_text %}
                                        <p>{{ response.response_text }}</p>
                                    {% elif response.transcript %}
                                        <p>{{ response.transcript }}</p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- –û—Ü–µ–Ω–∫–∞ –∑–∞–¥–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                            {% if assessment %}
                            <div class="task-card__assessment assessment-result">
                                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                                <div class="assessment-result__score score-badge">
                                    <span class="score-badge__label">–û—Ü–µ–Ω–∫–∞:</span>
                                    <span class="score-badge__value" style="--score: {% widthratio assessment.score 1 100 %}">
                                        {% widthratio assessment.score 1 100 %}%
                                    </span>
                                </div>

                                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                                {% if assessment.feedback %}
                                <div class="assessment-result__feedback feedback-box">
                                    <div class="feedback-box__header">
                                        <span class="feedback-box__label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span>
                                    </div>
                                    <div class="feedback-box__content">
                                        {{ assessment.feedback }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if assessment.structured_feedback.summary %}
                                    {% with advice=assessment.structured_feedback.summary.advice %}
                                        {% if advice %}
                                        <div class="task-card__advice advice-box">
                                            <div class="advice-box__header">
                                                <svg class="advice-box__icon" width="20" height="20" viewBox="0 0 24 24">
                                                    <path fill="currentColor" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13.5v6l5 2.5-1 2-6-3V7h2z"/>
                                                </svg>
                                                <span class="advice-box__title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</span>
                                            </div>
                                            <ul class="advice-box__list">
                                                {% for item in advice %}
                                                <li class="advice-box__item">{{ item }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}

                                <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
                                {% if assessment.structured_feedback %}
                                <div class="assessment-result__detailed detailed-analysis">
                                    <div class="detailed-analysis__header">
                                        <span class="detailed-analysis__label">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–°–õ–£–ñ–ï–ë–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø):</span>
                                    </div>
                                    <div class="detailed-analysis__content">
                                        {% for key, value in assessment.structured_feedback.items %}
                                            <div class="detailed-analysis__skill skill-analysis">
                                                <div class="skill-analysis__header">
                                                    <span class="skill-analysis__name">{{ key }}</span>
                                                </div>
                                                {% include 'widgets/_json_recursive.html' with data=value level=0 %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="task-card__placeholder task-placeholder">
                                <svg class="task-placeholder__icon" width="48" height="48" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-8 14H7v-2h4v2zm0-4H7v-2h4v2zm0-4H7V7h4v2zm6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/>
                                </svg>
                                <p class="task-placeholder__text">–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>
        {% endif %}

        
    </main>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <footer class="lesson-history__actions actions-bar">
        <a href="{% url 'curriculum:learning_session' enrollment.pk %}" class="actions-bar__btn actions-bar__btn--primary">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
        </a>
        <a href="#" class="actions-bar__btn actions-bar__btn--secondary">
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–∫
        </a>
        <a href="{% url 'curriculum:course_history' enrollment.course.pk %}" class="actions-bar__btn actions-bar__btn--outline">
            –ö –∫—É—Ä—Å—É
        </a>
    </footer>
</div>
{% endblock %}



{% block assistant_script %}

{% comment %} <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> {% endcomment %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart.js plugins (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>

 // ======================
    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ß–ê–†–¢: –†–ê–î–ê–† –ü–û –ù–ê–í–´–ö–ê–ú 
    // ======================
    {% if skill_snapshot %}
        const radarCtx = document.getElementById('skillsRadarChart')?.getContext('2d');
        if (radarCtx) {
            // –ó–∞—â–∏—Ç–∞: –∑–Ω–∞—á–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0.0‚Äì1.0
            const normalize = (value) => Math.max(0, Math.min(1, parseFloat(value) || 0));

            const skillLabels = {{ skill_labels|safe }};
            const skillsData = {{ skill_snapshot.skills|safe }};
            const initialSnapshot = {% if initial_skill_snapshot %}{{ initial_skill_snapshot.skills|safe }}{% else %}null{% endif %};
            console.log('skillLabels:', skillLabels);
            console.log('skillsData:', skillsData)
            console.log('initialSnapshot:', initialSnapshot)
            const getSkillValue = (source, label) =>
                source?.[label.toLowerCase()] ?? 0;

            const currentData = skillLabels.map(label => {
                const value = getSkillValue(skillsData, label);
                const normalized = normalize(value);
                return normalized;
            });
            
            const initialData = initialSnapshot
                ? skillLabels.map(label => {
                    const value = getSkillValue(initialSnapshot, label);
                    const normalized = normalize(value);
                    return normalized;
                })
                : null;

            console.log('currentData:', currentData);
            console.log('initialData:', initialData);

            const datasets = [{
                label: '–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å',
                data: currentData,
                fill: false,
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                pointBorderColor: '#fff',
                pointRadius: 5,
                tension: 0.3
            }];
            
            if (initialData) {
                datasets.push({
                    label: '–ù–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å',
                    data: initialData,
                    fill: false,
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    pointBackgroundColor: 'rgba(245, 158, 11, 1)',
                    pointRadius: 4,
                    tension: 0.3,
                    order: 1,
                });
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
            const textColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--color-text')
                .trim();
            
            const radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: skillLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            backgroundColor: 'rgba(31, 41, 55, 0.9)',
                            titleFont: {
                                size: 12,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 11
                            },
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const datasetLabel = context.dataset.label || '';
                                    const skillValue = context.parsed.r.toFixed(1);
                                    return `${datasetLabel}: ${skillValue}`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            pointLabels: {
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                color: textColor
                            },
                            ticks: {
                                display: true,
                                stepSize: 25,
                                suggestedMin: 0,
                                suggestedMax: 100,
                                color: textColor,
                                backdropColor: 'transparent',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
    {% endif %}
    </script>
{% endblock %}
