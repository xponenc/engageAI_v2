{% extends 'extended/assistant_layout.html' %}
{% load static %}
{% load skill_filters %}

{% block title %}{{ course.title }} ‚Äî –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å{% endblock %}


{% block assistant_css %}
<link href="{% static 'css/course-history.css' %}" rel="stylesheet">
{% endblock %}


{% block assistant_content %}
<div class="course-history">
    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav class="course-history__breadcrumbs breadcrumbs">
        <a href="#" class="breadcrumbs__link">–ì–ª–∞–≤–Ω–∞—è</a>
        <span class="breadcrumbs__separator">/</span>
        <span class="breadcrumbs__current">{{ course.title }}</span>
    </nav>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫—É—Ä—Å–∞ -->
    <header class="course-history__header header">
        <div class="header__top">
            <h1 class="header__title">{{ course.title }}</h1>
            <div class="header__path-type path-type-badge path-type-badge--{{ learning_path.path_type|lower }}">
                {% if learning_path.path_type == 'LINEAR' %}
                    üìè –õ–∏–Ω–µ–π–Ω—ã–π –ø—É—Ç—å
                {% elif learning_path.path_type == 'ADAPTIVE' %}
                    üß† –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å
                {% elif learning_path.path_type == 'PERSONALIZED' %}
                    ‚ú® –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å
                {% endif %}
            </div>
        </div>

        <p class="header__description">{{ course.description }}</p>

        <div class="header__tags">
            {% for tag in course.professional_tags.all %}
                <span class="header__tag tag-badge">{{ tag.name }}</span>
            {% endfor %}
        </div>

        {% if learning_path.metadata.generated_by %}
            <div class="header__generated-by">
                <svg class="header__icon" width="16" height="16" viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {{ learning_path.metadata.generated_by }}
            </div>
        {% endif %}
    </header>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∫—É—Ä—Å–∞ -->
    <section class="course-history__progress progress-overview">
        <div class="progress-overview__header">
            <h2 class="progress-overview__title">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</h2>
            <div class="progress-overview__stats">
                <div class="progress-overview__stat">
                    <span class="progress-overview__stat-value">{{ progress.completed_lessons }}</span>
                    <span class="progress-overview__stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ</span>
                </div>
                <div class="progress-overview__stat">
                    <span class="progress-overview__stat-value">{{ progress.total_lessons }}</span>
                    <span class="progress-overview__stat-label">–í—Å–µ–≥–æ</span>
                </div>
                {% if progress.current_lesson_number %}
                    <div class="progress-overview__stat">
                        <span class="progress-overview__stat-value">{{ progress.current_lesson_number }}</span>
                        <span class="progress-overview__stat-label">–¢–µ–∫—É—â–∏–π</span>
                    </div>
                {% endif %}
            </div>
        </div>

        {% comment %} <!-- –ö—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å (Doughnut) -->
        <div class="progress-overview__circle">
            <div class="progress-chart">
                <canvas id="progressDoughnutChart" width="200" height="200"></canvas>
                <div class="progress-chart__center">
                    <div class="progress-chart__percentage" id="doughnutPercentage">
                        {{ progress.percentage|default:0 }}%
                    </div>
                    <div class="progress-chart__label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                </div>
            </div>
        </div>

        <!-- –õ–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å (Bar) -->
        <div class="progress-overview__bar">
            <div class="progress-bar-chart">
                <canvas id="progressBarChart" height="40"></canvas>
            </div>
        </div>

        <!-- –†–∞–¥–∞—Ä-—á–∞—Ä—Ç –ø–æ –Ω–∞–≤—ã–∫–∞–º -->
        {% if skill_snapshot %}
        <div class="progress-overview__skills-radar">
            <div class="skills-radar">
                <div class="skills-radar__header">
                    <h3 class="skills-radar__title">–í–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –Ω–∞–≤—ã–∫–æ–≤</h3>
                    {% if skill_snapshot.timestamp %}
                    <span class="skills-radar__updated">
                        –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ skill_snapshot.timestamp|date:"d.m.Y H:i" }}
                    </span>
                    {% endif %}
                </div>
                
                <div class="skills-radar__chart">
                    <canvas id="skillsRadarChart" height="300"></canvas>
                </div>
                
                <div class="skills-radar__legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: rgba(99, 102, 241, 0.8);"></span>
                        <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                    </div>
                    {% if initial_snapshot %}
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: rgba(245, 158, 11, 0.8);"></span>
                        <span>–ù–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %} {% endcomment %}

        <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ —á–∞—Ä—Ç–æ–≤ -->
        <div class="progress-charts-group">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ö—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å -->
            <div class="progress-charts-group__column progress-charts-group__column--main">
                <!-- –ö—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å (Doughnut) -->
                <div class="progress-chart-card">
                    <div class="progress-chart-card__header">
                        <h3 class="progress-chart-card__title">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫—É—Ä—Å–∞</h3>
                        <div class="progress-chart-card__stats">
                            <span class="progress-chart-card__stat">
                                <span class="progress-chart-card__stat-value">{{ progress.completed_lessons }}</span>
                                <span class="progress-chart-card__stat-label">/</span>
                                <span class="progress-chart-card__stat-total">{{ progress.total_lessons }}</span>
                            </span>
                            <span class="progress-chart-card__stat-label">—É—Ä–æ–∫–æ–≤</span>
                        </div>
                    </div>
                    <div class="progress-chart-card__body">
                        <div class="progress-chart">
                            <canvas id="progressDoughnutChart" width="200" height="200"></canvas>
                            <div class="progress-chart__center">
                                <div class="progress-chart__percentage" id="doughnutPercentage">
                                    {{ progress.percentage|default:0 }}%
                                </div>
                                <div class="progress-chart__label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –õ–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å (Bar) -->
                <div class="progress-chart-card">
                    <div class="progress-chart-card__header">
                        <h3 class="progress-chart-card__title">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–∏–ø–∞–º</h3>
                    </div>
                    <div class="progress-chart-card__body">
                        <div class="progress-bar-chart">
                            <canvas id="progressBarChart" height="60"></canvas>
                        </div>
                        <div class="progress-bar-chart__legend">
                            <div class="legend-row">
                                <span class="legend-color legend-color--completed"></span>
                                <span class="legend-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                            </div>
                            <div class="legend-row">
                                <span class="legend-color legend-color--remaining"></span>
                                <span class="legend-label">–û—Å—Ç–∞–ª–æ—Å—å</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–∞–¥–∞—Ä –Ω–∞–≤—ã–∫–æ–≤ -->
            {% if skill_snapshot %}
            <div class="progress-charts-group__column progress-charts-group__column--skills">
                <div class="progress-chart-card progress-chart-card--highlight">
                    <div class="progress-chart-card__header">
                        <h3 class="progress-chart-card__title">–£—Ä–æ–≤–µ–Ω—å –Ω–∞–≤—ã–∫–æ–≤</h3>
                        {% if skill_snapshot.timestamp %}
                        <span class="progress-chart-card__updated">
                            –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ skill_snapshot.timestamp|date:"d.m.Y" }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="progress-chart-card__body">
                        <div class="skills-radar-chart">
                            <canvas id="skillsRadarChart" height="320"></canvas>
                        </div>
                    </div>
                    <div class="progress-chart-card__footer">
                        <div class="skills-radar__legend">
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: rgba(99, 102, 241, 0.8);"></span>
                                <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                            </div>
                            {% if initial_snapshot %}
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: rgba(245, 158, 11, 0.8);"></span>
                                <span>–ù–∞—á–∞–ª—å–Ω—ã–π</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>


        {% if skill_comparisons %}
        <div class="skills-comparison">
            <h4 class="skills-comparison__title">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–∞–≤—ã–∫–∞–º</h4>
            <div class="skills-comparison__grid">
                {% for skill in skill_comparisons %}
                <div class="skill-comparison-item">
                    <div class="skill-comparison-item__header">
                        <span class="skill-comparison-item__name">{{ skill.name }}</span>
                        <span class="skill-comparison-item__delta 
                            {% if skill.delta_positive %}skill-comparison-item__delta--positive
                            {% else %}skill-comparison-item__delta--negative{% endif %}">
                            {{ skill.delta_formatted }}
                        </span>
                    </div>
                    <div class="skill-comparison-item__bars">
                        <div class="skill-bar">
                            <span class="skill-bar__label">–ù–∞—á–∞–ª–æ</span>
                            <div class="skill-bar__progress">
                                <div class="skill-bar__fill skill-bar__fill--initial" 
                                    style="width: {% widthratio skill.initial 1 100 %}%">
                                </div>
                            </div>
                        </div>
                        <div class="skill-bar">
                            <span class="skill-bar__label">–°–µ–π—á–∞—Å</span>
                            <div class="skill-bar__progress">
                                <div class="skill-bar__fill skill-bar__fill--current" 
                                    style="width: {% widthratio skill.current 1 100 %}%">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º -->
        <div class="progress-overview__types">
            <div class="progress-types">
                <div class="progress-types__item">
                    <span class="progress-types__icon">üìö</span>
                    <div class="progress-types__info">
                        <span class="progress-types__count">{{ core_stats.completed }}/{{ core_stats.total }}</span>
                        <span class="progress-types__label">–û—Å–Ω–æ–≤–Ω—ã–µ —É—Ä–æ–∫–∏</span>
                    </div>
                </div>
                {% if remedial_stats.total > 0 %}
                <div class="progress-types__item">
                    <span class="progress-types__icon">üîÑ</span>
                    <div class="progress-types__info">
                        <span class="progress-types__count">{{ remedial_stats.completed }}/{{ remedial_stats.total }}</span>
                        <span class="progress-types__label">–ü–æ–≤—Ç–æ—Ä—ã</span>
                    </div>
                </div>
                {% endif %}
                {% if diagnostic_stats.total > 0 %}
                <div class="progress-types__item">
                    <span class="progress-types__icon">üîç</span>
                    <div class="progress-types__info">
                        <span class="progress-types__count">{{ diagnostic_stats.completed }}/{{ diagnostic_stats.total }}</span>
                        <span class="progress-types__label">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        {% if current_node %}
        <div class="progress-overview__actions">
            <a href="{% url 'curriculum:learning_session' enrollment.pk %}" 
                class="btn btn--primary btn--large">
                {% if current_node.status == 'in_progress' %}
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Ä–æ–∫
                {% else %}
                    –ù–∞—á–∞—Ç—å —É—Ä–æ–∫
                {% endif %}
                ‚Üí
            </a>
            {% if next_node and next_node.status == 'recommended' %}
            <a href="#" class="btn btn--secondary">
                –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: {{ next_node.title|truncatechars:30 }}
            </a>
            {% endif %}
        </div>
        {% endif %}
    </section>

    <!-- –°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ -->
    <section class="course-history__lessons lessons-list">
        <div class="lessons-list__header">
            <h2 class="lessons-list__title">–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω</h2>
            <div class="lessons-list__controls">
                <button class="lessons-list__filter active" data-filter="all">
                    –í—Å–µ ({{ nodes|length }})
                </button>
                <button class="lessons-list__filter" data-filter="core">
                    –û—Å–Ω–æ–≤–Ω—ã–µ ({{ core_stats.total }})
                </button>
                {% if remedial_stats.total > 0 %}
                <button class="lessons-list__filter" data-filter="remedial">
                    –ü–æ–≤—Ç–æ—Ä—ã ({{ remedial_stats.total }})
                </button>
                {% endif %}
                {% if diagnostic_stats.total > 0 %}
                <button class="lessons-list__filter" data-filter="diagnostic">
                    –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ({{ diagnostic_stats.total }})
                </button>
                {% endif %}
            </div>
        </div>

        <div class="lessons-list__grid">
            {% for node in nodes %}
            <div class="lesson-card lesson-card--{{ node.status }} lesson-card--{{ node.type }}"
                    data-type="{{ node.type }}"
                    data-status="{{ node.status }}">
                
                <!-- –°—Ç–∞—Ç—É—Å –∏ —Ç–∏–ø -->
                <div class="lesson-card__header">
                    <div class="lesson-card__status status-badge status-badge--{{ node.status }}">
                        {% if node.status == 'completed' %}
                            ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                        {% elif node.status == 'in_progress' %}
                            üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ
                        {% elif node.status == 'locked' %}
                            üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
                        {% elif node.status == 'skipped' %}
                            ‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ
                        {% elif node.status == 'recommended' %}
                            üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
                        {% endif %}
                    </div>
                    <div class="lesson-card__type type-badge type-badge--{{ node.type }}">
                        {% if node.type == 'core' %}
                            üìö –û—Å–Ω–æ–≤–Ω–æ–π
                        {% elif node.type == 'remedial' %}
                            üîÑ –ü–æ–≤—Ç–æ—Ä
                        {% elif node.type == 'diagnostic' %}
                            üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                        {% elif node.type == 'practice' %}
                            üí™ –ü—Ä–∞–∫—Ç–∏–∫–∞
                        {% endif %}
                    </div>
                </div>

                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="lesson-card__content">
                    <h3 class="lesson-card__title">
                        {% if node.type == 'core' %}
                            –£—Ä–æ–∫ {{ forloop.counter }}
                        {% else %}
                            {{ node.type|capfirst }}
                        {% endif %}
                        : {{ node.title }}
                    </h3>
                    
                    {% if node.lesson_id %}
                        {% with lesson=node.lesson %}
                            <p class="lesson-card__description">
                                {{ lesson.description|truncatechars:120 }}
                            </p>
                            
                            <!-- –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É—Ä–æ–∫–∞ -->
                            <div class="lesson-card__meta">
                                <span class="lesson-card__meta-item">
                                    <svg class="lesson-card__meta-icon" width="16" height="16" viewBox="0 0 24 24">
                                        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13.5v6l5 2.5-1 2-6-3V7h2z" fill="currentColor"/>
                                    </svg>
                                    {{ lesson.duration_minutes }} –º–∏–Ω
                                </span>
                                <span class="lesson-card__meta-item">
                                    <svg class="lesson-card__meta-icon" width="16" height="16" viewBox="0 0 24 24">
                                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/>
                                    </svg>
                                    CEFR {{ lesson.required_cefr }}
                                </span>
                                <div class="lesson-card__skills">
                                    {% for skill in lesson.skill_focus %}
                                        <span class="lesson-card__skill skill-tag skill-tag--{{ skill }}">
                                            {{ skill }}
                                        </span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endwith %}
                    {% else %}
                        <p class="lesson-card__description">
                            {{ node.metadata.description|default:"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π" }}
                        </p>
                    {% endif %}
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤ -->
                {% if node.status == 'completed' and node.lesson_id %}
                    {% with assessment=node.assessment_result %}
                        <div class="lesson-card__results">
                            <div class="lesson-card__score">
                                <span class="lesson-card__score-label">–û—Ü–µ–Ω–∫–∞:</span>
                                <span class="lesson-card__score-value">
                                    {% widthratio assessment.overall_score 1 100 %}%
                                </span>
                            </div>
                            
                            {% if assessment.completed_at %}
                                <div class="lesson-card__date">
                                    <svg class="lesson-card__date-icon" width="16" height="16" viewBox="0 0 24 24">
                                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" fill="currentColor"/>
                                    </svg>
                                    {{ assessment.completed_at|date:"d.m.Y" }}
                                </div>
                            {% endif %}

                            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–∞–≤—ã–∫–∞–º -->
                            {% comment %} {% if assessment.structured_feedback %}
                                <div class="lesson-card__skills-progress">
                                    {% for skill_name, skill_data in assessment.structured_feedback.items %}
                                        {% if forloop.counter0 < 3 %}
                                            <div class="skill-progress-bar">
                                                <div class="skill-progress-bar__label">
                                                    {{ skill_name|capfirst }}
                                                </div>
                                                <div class="skill-progress-bar__progress">
                                                    <div class="skill-progress-bar__fill" 
                                                            style="width: {{ skill_data.score|floatformat:0 }}%">
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %} {% endcomment %}

                            <a href="{% url 'curriculum:lesson_history' node.lesson_id %}" 
                                class="lesson-card__details-link">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí
                            </a>
                        </div>
                    {% endwith %}
                {% endif %}

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="lesson-card__actions">
                    {% if node.status == 'in_progress' and node.lesson_id %}
                        <a href="{% url 'curriculum:learning_session' enrollment.id %}" 
                            class="btn btn--primary btn--small">
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                        </a>
                    {% elif node.status == 'locked' %}
                        <button class="btn btn--disabled btn--small" disabled>
                            –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                        </button>
                        <span class="lesson-card__locked-hint">
                            {% if node.prerequisites %}
                                –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç—å: {{ node.prerequisites|length }} —É—Ä–æ–∫–æ–≤
                            {% else %}
                                –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫
                            {% endif %}
                        </span>
                    {% elif node.status == 'completed' and node.lesson_id %}
                        <a href="{% url 'curriculum:lesson_history' node.lesson_id %}" 
                            class="btn btn--outline btn--small">
                            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                        </a>
                    {% elif node.status == 'recommended' and node.lesson_id %}
                        <a href="{% url 'curriculum:learning_session' enrollment.id %}" 
                            class="btn btn--secondary btn--small">
                            –ù–∞—á–∞—Ç—å
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- –£—á–µ–±–Ω—ã–µ —Ü–µ–ª–∏ –∫—É—Ä—Å–∞ -->
    {% if course.learning_objectives.all %}
    <section class="course-history__objectives learning-objectives">
        <h2 class="learning-objectives__title">–£—á–µ–±–Ω—ã–µ —Ü–µ–ª–∏ –∫—É—Ä—Å–∞</h2>
        <div class="learning-objectives__grid">
            {% for objective in course.learning_objectives.all %}
                <div class="learning-objective">
                    <span class="learning-objective__id">{{ objective.identifier }}</span>
                    <p class="learning-objective__name">{{ objective.name }}</p>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <footer class="course-history__actions actions-bar">
        <a href="{% url 'curriculum:learning_session' enrollment.pk %}" class="actions-bar__btn actions-bar__btn--primary">
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é
        </a>
        <a href="#" class="actions-bar__btn actions-bar__btn--outline">
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—Å–∞
        </a>
    </footer>
</div>
{% endblock %}


{% block assistant_script %}

{% comment %} <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> {% endcomment %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart.js plugins (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.lessons-list__filter');
    const lessonCards = document.querySelectorAll('.lesson-card');

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
            lessonCards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                } else {
                    const cardType = card.dataset.type;
                    card.style.display = (cardType === filter) ? 'block' : 'none';
                }
            });
        });
    });

    // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ç–µ–∫—É—â–µ–º—É —É—Ä–æ–∫—É
    const currentLessonCard = document.querySelector('.lesson-card--in_progress');
    if (currentLessonCard) {
        setTimeout(() => {
            currentLessonCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            currentLessonCard.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.5)';
            setTimeout(() => {
                currentLessonCard.style.boxShadow = '';
            }, 2000);
        }, 500);
    }

    // ======================
    // –ö–†–£–ì–û–í–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê (Doughnut)
    // ======================
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    const textColor = getComputedStyle(document.documentElement)
    .getPropertyValue('--color-text')
    .trim();


    const doughnutCtx = document.getElementById('progressDoughnutChart').getContext('2d');
    
    const progressPercentage = {{ progress.percentage|default:0 }};
    const remainingPercentage = 100 - progressPercentage;
    
    const doughnutChart = new Chart(doughnutCtx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [progressPercentage, remainingPercentage],
                backgroundColor: [
                    'rgba(99, 102, 241, 1)',      // –ó–∞–≤–µ—Ä—à–µ–Ω–æ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç)
                    'rgba(229, 231, 235, 0.3)'     // –û—Å—Ç–∞–ª–æ—Å—å (—Å–≤–µ—Ç–ª—ã–π —Å–µ—Ä—ã–π)
                ],
                borderWidth: 0,
                cutout: '75%',  // –¢–æ–ª—â–∏–Ω–∞ –∫–æ–ª—å—Ü–∞
                borderRadius: 4,
                spacing: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false  // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–µ–≥–µ–Ω–¥—É
                },
                tooltip: {
                    enabled: false  // –û—Ç–∫–ª—é—á–∞–µ–º —Ç—É–ª—Ç–∏–ø—ã
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1000,
                easing: 'easeOutQuart',
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø—Ä–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
                onComplete: function(animation) {
                    const percentageEl = document.getElementById('doughnutPercentage');
                    if (percentageEl) {
                        percentageEl.textContent = progressPercentage + '%';
                    }
                }
            },
            cutout: '75%'
        }
    });

    // ======================
    // –õ–ò–ù–ï–ô–ù–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê (Bar)
    // ======================
    const barCtx = document.getElementById('progressBarChart').getContext('2d');
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –¥–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ —á–∞—Ä—Ç–∞
    const coreCompleted = {{ core_stats.completed|default:0 }};
    const coreTotal = {{ core_stats.total|default:1 }};
    const remedialCompleted = {{ remedial_stats.completed|default:0 }};
    const remedialTotal = {{ remedial_stats.total|default:0 }};
    const diagnosticCompleted = {{ diagnostic_stats.completed|default:0 }};
    const diagnosticTotal = {{ diagnostic_stats.total|default:0 }};
    
    const progressBarChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['–û—Å–Ω–æ–≤–Ω—ã–µ', '–ü–æ–≤—Ç–æ—Ä—ã', '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞'],
            datasets: [
                {
                    label: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                    data: [coreCompleted, remedialCompleted, diagnosticCompleted],
                    backgroundColor: [
                        'rgba(99, 102, 241, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(59, 130, 246, 0.8)'
                    ],
                    borderColor: [
                        'rgba(99, 102, 241, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(59, 130, 246, 1)'
                    ],
                    borderWidth: 1,
                    borderRadius: 4,
                    borderSkipped: false
                },
                {
                    label: '–û—Å—Ç–∞–ª–æ—Å—å',
                    data: [
                        coreTotal - coreCompleted,
                        remedialTotal - remedialCompleted,
                        diagnosticTotal - diagnosticCompleted
                    ],
                    backgroundColor: 'rgba(229, 231, 235, 0.3)',
                    borderColor: 'rgba(229, 231, 235, 0.5)',
                    borderWidth: 1,
                    borderRadius: 4,
                    borderSkipped: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –±–∞—Ä—ã
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(31, 41, 55, 0.9)',
                    titleFont: {
                        size: 12,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 11
                    },
                    padding: 10,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            const datasetLabel = context.dataset.label || '';
                            const value = context.parsed.x || 0;
                            return `${datasetLabel}: ${value}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    beginAtZero: true,
                    max: Math.max(coreTotal, remedialTotal, diagnosticTotal) || 10,
                    grid: {
                        display: false
                    },
                    ticks: {
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            weight: '500'
                        },
                        color: textColor
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            barPercentage: 0.7,
            categoryPercentage: 0.9
        }
    });

    // ======================
    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ß–ê–†–¢: –†–ê–î–ê–† –ü–û –ù–ê–í–´–ö–ê–ú 
    // ======================
    {% if skill_snapshot %}
        const radarCtx = document.getElementById('skillsRadarChart')?.getContext('2d');
        if (radarCtx) {
            // –ó–∞—â–∏—Ç–∞: –∑–Ω–∞—á–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0.0‚Äì1.0
            const normalize = (value) => Math.max(0, Math.min(1, parseFloat(value) || 0));

            const skillLabels = {{ skill_labels|safe }};
            const skillsData = {{ skill_snapshot.skills|safe }};
            const initialSnapshot = {% if initial_skill_snapshot %}{{ initial_skill_snapshot.skills|safe }}{% else %}null{% endif %};
            console.log('skillLabels:', skillLabels);
            console.log('skillsData:', skillsData)
            console.log('initialSnapshot:', initialSnapshot)
            const getSkillValue = (source, label) =>
                source?.[label.toLowerCase()] ?? 0;

            const currentData = skillLabels.map(label => {
                const value = getSkillValue(skillsData, label);
                const normalized = normalize(value);
                return normalized;
            });
            
            const initialData = initialSnapshot
                ? skillLabels.map(label => {
                    const value = getSkillValue(initialSnapshot, label);
                    const normalized = normalize(value);
                    return normalized;
                })
                : null;

            console.log('currentData:', currentData);
            console.log('initialData:', initialData);

            const datasets = [{
                label: '–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å',
                data: currentData,
                fill: false,
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                pointBorderColor: '#fff',
                pointRadius: 5,
                tension: 0.3
            }];
            
            if (initialData) {
                datasets.push({
                    label: '–ù–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å',
                    data: initialData,
                    fill: false,
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 3,
                    borderDash: [5, 5],
                    pointBackgroundColor: 'rgba(245, 158, 11, 1)',
                    pointRadius: 4,
                    tension: 0.3,
                    order: 1,
                });
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –∏–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
            const textColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--color-text')
                .trim();
            
            const radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: skillLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            backgroundColor: 'rgba(31, 41, 55, 0.9)',
                            titleFont: {
                                size: 12,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 11
                            },
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const datasetLabel = context.dataset.label || '';
                                    const skillValue = context.parsed.r.toFixed(1);
                                    return `${datasetLabel}: ${skillValue}`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            pointLabels: {
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                color: textColor
                            },
                            ticks: {
                                display: true,
                                stepSize: 25,
                                suggestedMin: 0,
                                suggestedMax: 100,
                                color: textColor,
                                backdropColor: 'transparent',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
    {% endif %}

    // ======================
    // –ê–ù–ò–ú–ê–¶–ò–Ø –ü–†–ò –ü–†–û–ö–†–£–¢–ö–ï (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    // ======================
    function animateChartsOnScroll() {
        const chartsSection = document.querySelector('.progress-overview');
        if (!chartsSection) return;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // –ß–∞—Ä—Ç—ã —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                    setTimeout(() => {
                        doughnutChart.update('active');
                        progressBarChart.update('active');
                    }, 100);
                    
                    observer.unobserve(entry.target);
                }
            });
        }, {
            threshold: 0.1
        });

        observer.observe(chartsSection);
    }

    animateChartsOnScroll();
});
</script>
{% endblock %}
