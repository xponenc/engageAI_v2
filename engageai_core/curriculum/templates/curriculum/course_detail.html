{% extends 'extended/assistant_layout.html' %}
{% load static %}

{% block title %}{{ course.title }}{% endblock %}

{% block assistant_css %}
<link rel="stylesheet" href="{% static 'css/course-detail.css' %}">
{% endblock %}

{% block assistant_content %}
<section class="course-detail">
    <div class="course-detail__container container">
        <main class="course-detail__main">
            <header class="course-header">
                <h2 class="course-header__title">{{ course.title }}</h2>
                {% if course.learning_objectives.exists %}
                    <div class="course-header__objectives">
                        <h4>–¶–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è</h4>
                        <ul>
                            {% for objective in course.learning_objectives.all %}
                                <li>‚úî {{ objective.name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                <p class="course-header__description">
                    {{ course.description }}
                </p>


                <div class="course-header__meta">
                    <span>üìö {{ course.ordered_lessons|length }} —É—Ä–æ–∫–æ–≤</span>
                    <span>‚è± ~{{ course.estimated_duration }} –º–∏–Ω</span>
                    <span>üéØ –£—Ä–æ–≤–µ–Ω—å:
                        {{ course.get_target_cefr_from_display }}
                        ‚Äì
                        {{ course.get_target_cefr_to_display }}</span>
                </div>
            </header>

            <section class="course-progress card">
                {% if enrollment %}
                    <div class="course-info__progress">
                        <h4>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</h4>
                        <div class="progress-card">
                            <div class="progress-card__title">–ü—Ä–æ–≥—Ä–µ—Å—Å –∫—É—Ä—Å–∞</div>
                            <div class="progress-bar">
                                <div class="progress-bar__value" style="width: {{ progress_details.progress_percent|floatformat:0 }}%"></div>
                            </div>
                            <div class="progress-card__percent">
                                {{ progress_details.progress_percent|floatformat:0 }} %
                            </div>
                        </div>
                        <small>
                            –¢–µ–∫—É—â–∏–π —É—Ä–æ–∫:
                            {{ current_lesson.title|truncatechars:30 }}
                        </small>
                    </div>

                    <a href="{% url 'curriculum:learning_session' enrollment.id %}"
                        class="btn btn_primary course-progress__action">
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
                    </a>
                    <a href="{% url 'curriculum:course_history' enrollment.id %}"
                        class="btn btn_primary course-progress__action">
                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                    </a>
                {% else %}
                    <button class="btn btn_success course-progress__action enroll-btn"
                        data-course-id="{{ course.id }}"
                        data-url="{% url 'curriculum:enroll_course' course.id %}">
                        –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å
                    </button>
                {% endif %}
            </section>

            <!-- –£—Ä–æ–∫–∏ -->
            <section class="course-lessons">
                <h2 class="course-lessons__title">–£—Ä–æ–∫–∏ –∫—É—Ä—Å–∞</h2>

                {% for lesson in course.ordered_lessons %}
                    <article class="lesson-item">
                        <header class="lesson-item__header">
                            <h3 class="lesson-item__title">
                                {{ lesson.order }}. {{ lesson.title }}
                            </h3>
                            <span class="lesson-item__duration">
                                {{ lesson.duration_minutes }} –º–∏–Ω
                            </span>
                        </header>

                        <p class="lesson-item__description">
                            {{ lesson.description|truncatechars:120 }}
                        </p>

                        <div class="lesson-item__meta">
                            <span>üåç {{ lesson.get_required_cefr_display }}</span>

                            {% if lesson.skill_focus %}
                                <span>üß†
                                    {% for skill in lesson.skill_focus %}
                                        {{ skill }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </span>
                            {% endif %}
                        </div>
                    </article>
                {% empty %}
                    <div class="course-lessons__empty">
                        –í —ç—Ç–æ–º –∫—É—Ä—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤
                    </div>
                {% endfor %}
            </section>
        </main>
    </div>
</section>
{% endblock %}


{% block assistant_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const enrollButtons = document.querySelectorAll('.enroll-btn');

    enrollButtons.forEach(button => {
        button.addEventListener('click', function() {
            const enrollUrl = button.dataset.url; // URL –¥–ª—è POST
            if (!enrollUrl) return;

            // –°–æ–∑–¥–∞—ë–º —Å–ø–∏–Ω–Ω–µ—Ä
            const spinner = document.createElement('span');
            spinner.className = 'button-spinner';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            const originalText = button.textContent;
            button.textContent = '';
            button.appendChild(spinner);
            button.appendChild(document.createTextNode('–ó–∞–ø–∏—Å—å...'));
            button.disabled = true;

            fetch(enrollUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –æ—Ç –±—ç–∫–∞
                    throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
                return data;
            })
            .then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    location.reload();
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å:', error);
                button.disabled = false;
                button.textContent = originalText;
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫—É—Ä—Å: ' + error.message);
            });
        });
    });
});
</script>
{% endblock assistant_script %}

