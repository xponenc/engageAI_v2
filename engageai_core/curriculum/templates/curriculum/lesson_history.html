{% extends 'extended/assistant_layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Ä–æ–∫–∞ ‚Äî {{ lesson.title }}{% endblock %}

{% block assistant_css %}
<link href="{% static 'css/learning-session.css' %}" rel="stylesheet">
<link href="{% static 'css/lesson-history.css' %}" rel="stylesheet">
{% endblock %}

{% block assistant_content %}
<div class="lesson-history">
    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav class="lesson-history__breadcrumbs breadcrumbs">
        <a href="#" class="breadcrumbs__link">–ì–ª–∞–≤–Ω–∞—è</a>
        <span class="breadcrumbs__separator">/</span>
        <a href="#" class="breadcrumbs__link">{{ lesson.course.title }}</a>
        <span class="breadcrumbs__separator">/</span>
        <span class="breadcrumbs__current">{{ lesson.title }}</span>
    </nav>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞ -->
    <header class="lesson-history__header header">
        <h1 class="header__title">{{ lesson.title }}</h1>
        <div class="header__meta">
            <span class="header__course">{{ lesson.course.title }}</span>
            <span class="header__duration">
                <svg class="header__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13.5v6l5 2.5-1 2-6-3V7h2z" fill="currentColor"/>
                </svg>
                {{ lesson.duration_minutes }} –º–∏–Ω
            </span>
            <span class="header__level">
                <svg class="header__icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2"/>
                </svg>
                CEFR {{ lesson.required_cefr }}
            </span>
        </div>
        <div class="header__skills">
            {% for skill in lesson.skill_focus %}
                <span class="header__skill-badge skill-badge skill-badge--{{ skill }}">
                    {{ skill|capfirst }}
                </span>
            {% endfor %}
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="lesson-history__content content">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±—â–µ–π –æ—Ü–µ–Ω–∫–∏ -->
        <section class="content__section assessment-overview">
            <h2 class="assessment-overview__title">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Ä–æ–∫–∞</h2>
            
            <div class="assessment-overview__score-card score-card">
                <div class="score-card__circle">
                    <div class="score-card__percentage" style="--score: {{ lesson_assessment.overall_score|default:0 }}">
                        {{ lesson_assessment.overall_score|default:0|floatformat:0 }}%
                    </div>
                </div>
                <div class="score-card__details">
                    <div class="score-card__status status-badge status-badge--{{ lesson_assessment.status|lower }}">
                        {% if lesson_assessment.status == 'COMPLETED' %}
                            ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                        {% elif lesson_assessment.status == 'PENDING' %}
                            ‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ—Ü–µ–Ω–∫–∏
                        {% elif lesson_assessment.status == 'ERROR' %}
                            ‚ùå –û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏
                        {% endif %}
                    </div>
                    <div class="score-card__stats">
                        <div class="score-card__stat">
                            <span class="score-card__stat-label">–ó–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                            <span class="score-card__stat-value">
                                {{ completed_tasks_count }}/{{ total_tasks_count }}
                            </span>
                        </div>
                        <div class="score-card__stat">
                            <span class="score-card__stat-label">–í—Ä–µ–º—è –∑–∞–Ω—è—Ç–∏—è</span>
                            <span class="score-card__stat-value">
                                {% if lesson_assessment.completed_at and lesson_assessment.started_at %}
                                    {{ lesson_assessment.completed_at|timesince:lesson_assessment.started_at }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–∞–≤—ã–∫–∞–º -->
            <div class="assessment-overview__skills skills-progress">
                <h3 class="skills-progress__title">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–∞–≤—ã–∫–∞–º</h3>
                
                {% for skill_name, skill_data in lesson_assessment.structured_feedback.items %}
                <div class="skills-progress__skill skill-bar">
                    <div class="skill-bar__header">
                        <span class="skill-bar__name">{{ skill_name|capfirst }}</span>
                        <span class="skill-bar__score">{{ skill_data.score|floatformat:0 }}%</span>
                    </div>
                    <div class="skill-bar__progress">
                        <div class="skill-bar__fill" style="width: {{ skill_data.score|floatformat:0 }}%">
                            {% if skill_data.confidence %}
                                <span class="skill-bar__confidence">
                                    (¬±{{ skill_data.confidence|floatformat:0 }}%)
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    {% if skill_data.evidence %}
                        <div class="skill-bar__evidence">
                            <ul class="skill-bar__evidence-list">
                                {% for evidence in skill_data.evidence %}
                                    <li class="skill-bar__evidence-item">‚Ä¢ {{ evidence }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ (–¥–µ–ª—å—Ç–∞) -->
            {% if skill_delta %}
            <div class="assessment-overview__delta skill-delta">
                <h3 class="skill-delta__title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –ø–æ—Å–ª–µ —É—Ä–æ–∫–∞</h3>
                <div class="skill-delta__grid">
                    {% for skill_name, delta_value in skill_delta.deltas.items %}
                        {% if skill_name != 'overall' %}
                            <div class="skill-delta__item">
                                <span class="skill-delta__skill">{{ skill_name|capfirst }}</span>
                                <span class="skill-delta__value 
                                    {% if delta_value > 0 %}skill-delta__value--positive
                                    {% elif delta_value < 0 %}skill-delta__value--negative{% endif %}">
                                    {% if delta_value > 0 %}+{% endif %}{{ delta_value|floatformat:2 }}
                                </span>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div class="skill-delta__item skill-delta__item--overall">
                        <span class="skill-delta__skill">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span class="skill-delta__value 
                            {% if skill_delta.deltas.overall > 0 %}skill-delta__value--positive
                            {% elif skill_delta.deltas.overall < 0 %}skill-delta__value--negative{% endif %}">
                            {% if skill_delta.deltas.overall > 0 %}+{% endif %}{{ skill_delta.deltas.overall|floatformat:2 }}
                        </span>
                    </div>
                </div>
            </div>
            {% endif %}
        </section>

        <!-- –†–µ–∑—é–º–µ –æ—Ç AI -->
        {% if lesson_assessment.llm_summary or lesson_assessment.llm_recommendations %}
        <section class="content__section ai-summary">
            <h2 class="ai-summary__title">
                <svg class="ai-summary__icon" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                –ê–Ω–∞–ª–∏–∑ –æ—Ç AI-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞
            </h2>
            
            {% if lesson_assessment.llm_summary %}
            <div class="ai-summary__box">
                <h3 class="ai-summary__subtitle">–†–µ–∑—é–º–µ</h3>
                <p class="ai-summary__text">{{ lesson_assessment.llm_summary }}</p>
            </div>
            {% endif %}
            
            {% if lesson_assessment.llm_recommendations %}
            <div class="ai-summary__box ai-summary__box--recommendations">
                <h3 class="ai-summary__subtitle">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <ul class="ai-summary__recommendations">
                    {{ lesson_assessment.llm_recommendations }}
                    {% comment %} {% for rec in lesson_assessment.llm_recommendations %}
                        <li class="ai-summary__recommendation">‚Ä¢ {{ rec }}</li>
                    {% endfor %} {% endcomment %}
                </ul>
            </div>
            {% endif %}
        </section>
        {% endif %}

        <!-- –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏–π -->
        <section class="content__section tasks-details">
            <h2 class="tasks-details__title">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏–π</h2>
            <p class="tasks-details__subtitle">
                –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ completed_tasks_count }}/{{ total_tasks_count }} –∑–∞–¥–∞–Ω–∏–π
            </p>

            <div class="tasks-details__list">
                {% for task in tasks %}
                <div class="task-card 
                    {% if task.student_responses_for_enrollment %}task-card--completed
                    {% else %}task-card--pending{% endif %}">
                    <div class="task-card__header">
                        <div class="task-card__info">
                            <span class="task-card__type task-type task-type--{{ task.task_type }}">
                                {{ task.get_task_type_display }}
                            </span>
                            <span class="task-card__format">
                                {{ task.get_response_format_display }}
                            </span>
                        </div>
                        <div class="task-card__status">
                            {% if task.student_responses_for_enrollment %}
                                {% with response=task.student_responses_for_enrollment.0 assessment=response.assessment %}
                                    {% if assessment %}
                                        {% if assessment.is_correct != None %}
                                            {% if assessment.is_correct %}
                                                <span class="status-indicator status-indicator--correct">‚úì</span>
                                            {% else %}
                                                <span class="status-indicator status-indicator--incorrect">‚úó</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-indicator status-indicator--partial">~</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="status-indicator status-indicator--pending">?</span>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <span class="status-indicator status-indicator--locked">üîí</span>
                            {% endif %}
                        </div>
                    </div>

                    <h3 class="task-card__title">{{ task.content.prompt|truncatechars:80 }}</h3>

                    {% if task.student_responses_for_enrollment %}
                        {% with response=task.student_responses_for_enrollment.0 assessment=response.assessment %}
                            <div class="task-card__response">
                                <div class="task-card__response-header">
                                    <span class="task-card__response-label">–í–∞—à –æ—Ç–≤–µ—Ç:</span>
                                    <span class="task-card__submitted-at">
                                        {{ response.submitted_at|date:"d.m.Y H:i" }}
                                    </span>
                                </div>
                                <div class="task-card__response-content">
                                    {% if response.response_text %}
                                        <p>{{ response.response_text }}</p>
                                    {% elif response.transcript %}
                                        <p>{{ response.transcript }}</p>
                                    {% endif %}
                                </div>
                            </div>

                            {% if assessment %}
                                <div class="task-card__assessment">
                                    <div class="task-card__score">
                                        <span class="task-card__score-label">–û—Ü–µ–Ω–∫–∞:</span>
                                        <span class="task-card__score-value">
                                            {{ assessment.score|floatformat:0 }}%
                                        </span>
                                    </div>

                                    {% if assessment.feedback %}
                                        <div class="task-card__feedback">
                                            <span class="task-card__feedback-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span>
                                            <p class="task-card__feedback-text">{{ assessment.feedback }}</p>
                                        </div>
                                    {% endif %}

                                    {% if assessment.structured_feedback %}
                                        <div class="task-card__structured-feedback">
                                            <span class="task-card__feedback-label">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:</span>
                                            <ul class="task-card__feedback-list">
                                                {% for key, value in assessment.structured_feedback.items %}
                                                    <li class="task-card__feedback-item">
                                                        <strong>{{ key }}:</strong> {{ value }}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <div class="task-card__placeholder">
                            <p>–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- –£—á–µ–±–Ω—ã–µ —Ü–µ–ª–∏ -->
        {% if lesson.learning_objectives.all %}
        <section class="content__section learning-objectives">
            <h2 class="learning-objectives__title">–£—á–µ–±–Ω—ã–µ —Ü–µ–ª–∏ —É—Ä–æ–∫–∞</h2>
            <div class="learning-objectives__list">
                {% for objective in lesson.learning_objectives.all %}
                    <div class="learning-objective">
                        <span class="learning-objective__id">{{ objective.identifier }}</span>
                        <p class="learning-objective__name">{{ objective.name }}</p>
                    </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </main>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <footer class="lesson-history__actions actions-bar">
        <a href="#" class="actions-bar__btn actions-bar__btn--primary">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
        </a>
        <a href="#" class="actions-bar__btn actions-bar__btn--secondary">
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–∫
        </a>
        <a href="#" class="actions-bar__btn actions-bar__btn--outline">
            –ö –∫—É—Ä—Å—É
        </a>
    </footer>
</div>
{% endblock %}

