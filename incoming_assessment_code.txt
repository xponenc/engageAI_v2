E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\admin.py
from django.contrib import admin

# Register your models here.


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\apps.py
from django.apps import AppConfig


class AssessmentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'assessment'


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\forms.py
from django import forms

from .models import QuestionInstance


class QuestionAnswerForm(forms.Form):
    """
    –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å —Ç–µ—Å—Ç–∞.
    –í–∫–ª—é—á–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–µ session_id –∏ question_instance_id.
    Django —Å–∞–º –∑–∞—â–∏—Ç–∏—Ç —á–µ—Ä–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ clean().
    """

    session_id = forms.UUIDField(widget=forms.HiddenInput())
    question_instance_id = forms.UUIDField(widget=forms.HiddenInput())
    answer_text = forms.CharField(required=True)

    def clean(self):
        cleaned = super().clean()
        session_id = cleaned.get("session_id")
        qinst_id = cleaned.get("question_instance_id")

        if not session_id or not qinst_id:
            raise forms.ValidationError("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã.")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
        try:
            qinst = QuestionInstance.objects.select_related("session").get(id=qinst_id)
        except QuestionInstance.DoesNotExist:
            raise forms.ValidationError("–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–µ—Å—Å–∏–∏
        if qinst.session_id != session_id:
            raise forms.ValidationError("–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–æ–ø—Ä–æ—Å–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏.")

        cleaned["qinst"] = qinst  # –∫–ª–∞–¥—ë–º –≤ –∫—ç—à —Ñ–æ—Ä–º—ã
        return cleaned


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\mixins.py
from rest_framework import status
from rest_framework.response import Response

from assessment.models import TestSession, QuestionInstance
from engageai_core.mixins import core_api_logger


class AssessmentTestSessionMixin:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ TestSession –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç user."""

    def get_user_session(self, session_id, user, bot_tag):
        try:
            session = TestSession.objects.get(id=session_id, user=user)
            return session

        except TestSession.DoesNotExist:
            core_api_logger.error(
                f"{bot_tag} Session not found or does not belong to user | session_id={session_id}, user_id={user.id}"
            )

            return Response(
                data={"detail": f"Session '{session_id}' not found"},
                status=status.HTTP_404_NOT_FOUND,
            )


class QuestionInstanceMixin:
    def get_question_instance(self, qinst_id, session, bot_tag):
        try:
            return QuestionInstance.objects.get(id=qinst_id, session=session)

        except QuestionInstance.DoesNotExist:
            core_api_logger.error(
                f"{bot_tag} QuestionInstance not found | qinst_id={qinst_id}, session={session.id}"
            )
            return Response(
                data={"detail": f"QuestionInstance '{qinst_id}' not found"},
                status=status.HTTP_404_NOT_FOUND,
            )


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\models.py
# assessment/models.py
"""
–ú–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è assessment.
–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
"""
from datetime import timedelta

from django.contrib.auth.models import User
from django.db import models
from django.utils import timezone
from django.contrib.postgres.fields import ArrayField
import uuid

from users.models import CEFRLevel


class QuestionType(models.TextChoices):
    """–¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤."""
    MCQ = "mcq", "Multiple Choice"
    OPEN = "open", "Open Answer"
    READING = "reading", "Understanding Text"


class SessionSourceType(models.TextChoices):
    """–¢–∏–ø—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å–µ—Å—Å–∏–∏"""
    WEB = "web", "–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ"
    TELEGRAM = "tg", "–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞ –≤ –±–æ—Ç–µ"


class SourceType(models.TextChoices):
    """–ò—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–ø—Ä–æ—Å–∞."""
    CEFR = "cefr", "–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π CEFR –∏–∑ –±–∞–Ω–∫–∞"
    LLM = "llm", "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω LLM"


class CEFRQuestion(models.Model):
    """
    –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –±–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ (CEFR).
    –≠—Ç–æ –º–∞—Å—Ç–µ—Ä-—Ç–∞–±–ª–∏—Ü–∞ –≤–æ–ø—Ä–æ—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
    –í —Å–µ—Å—Å–∏—è—Ö —Ö—Ä–∞–Ω–∏–º –∫–ª–æ–Ω –≤–æ–ø—Ä–æ—Å–∞ –≤ QuestionInstance.question_json,
    —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    level = models.CharField(max_length=2, choices=CEFRLevel.choices, db_index=True)
    type = models.CharField(max_length=10, choices=QuestionType.choices, db_index=True)
    question_text = models.TextField()
    options = ArrayField(models.CharField(max_length=500), null=True, blank=True,
                         help_text="–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è MCQ (—Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫). –î–ª—è open = null")
    correct_answer = models.JSONField(null=True, blank=True,
                                      help_text='{"index": 0} –¥–ª—è MCQ –∏–ª–∏ {"text":"..."} –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏')
    explanation = models.TextField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    objects = models.Manager()

    class Meta:
        indexes = [
            models.Index(fields=["level", "type"]),
        ]
        ordering = ["level"]

    def __str__(self):
        return f"{self.level} | {self.type} | {self.question_text[:50]}"


class LLMGeneratedQuestion(models.Model):
    """
    –í–æ–ø—Ä–æ—Å—ã, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ LLM –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –•—Ä–∞–Ω–∏–º JSON, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    template_id = models.CharField(max_length=128, null=True, blank=True,
                                   help_text="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–º–ø—Ç–∞/—à–∞–±–ª–æ–Ω–∞")
    user_id = models.UUIDField(db_index=True, help_text="UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤–æ–ø—Ä–æ—Å")  # TODO FK?
    test_session_id = models.UUIDField(db_index=True, help_text="ID TestSession –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
    question_json = models.JSONField()
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        indexes = [
            models.Index(fields=["user_id"]),
            models.Index(fields=["test_session_id"])
        ]
        ordering = ["-created_at"]


class TestSession(models.Model):
    """
    –°–µ—Å—Å–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –û–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏.
      –õ–æ–≥–∏–∫–∞:
    - –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è.
    - time_limit: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä 30 –º–∏–Ω—É—Ç)
    - –ü—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª protocol_json
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    started_at = models.DateTimeField(auto_now_add=True)
    finished_at = models.DateTimeField(null=True, blank=True)
    # aborted_at = models.DateTimeField(null=True, blank=True)
    expired_at = models.DateTimeField(null=True, blank=True)

    time_limit_minutes = models.IntegerField(default=60, help_text="–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö")

    # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–µ—Å—Å–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ simultaneous access
    locked_by = models.CharField(max_length=32, choices=SessionSourceType.choices, default=SessionSourceType.WEB.value,
                                 help_text="–ö—Ç–æ –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π –º–æ–º–µ–Ω—Ç '–¥–µ—Ä–∂–∏—Ç' —Å–µ—Å—Å–∏—é (web/telegram)")

    estimated_level = models.CharField(max_length=2, choices=CEFRLevel.choices,
                                       null=True, blank=True, db_index=True)
    protocol_json = models.JSONField(null=True, blank=True)

    objects = models.Manager()

    class Meta:
        indexes = [
            models.Index(fields=["user_id", "started_at"]),
            models.Index(fields=["estimated_level"]),
        ]
        ordering = ["-started_at"]

    def is_active(self) -> bool:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞ (–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞)."""
        if self.finished_at or self.expired_at:
            return False
        return True

    def mark_expired(self):
        """–ü–æ–º–µ—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—É—é."""
        self.finished_at = timezone.now()
        self.expired_at = self.started_at + timedelta(minutes=self.time_limit_minutes)
        self.save(update_fields=["expired_at", "finished_at"])

    def __str__(self):
        return f"Session {self.id} user {self.user_id}"


class QuestionInstance(models.Model):
    """
    –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π (–∏–Ω—Å—Ç–∞–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) –≤–æ–ø—Ä–æ—Å, –≤—ã–¥–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ TestSession.
    –°–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é –≤–æ–ø—Ä–æ—Å–∞ –≤ question_json –¥–ª—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏–∏.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    session = models.ForeignKey(TestSession, on_delete=models.CASCADE, related_name="questions")
    source_type = models.CharField(max_length=10, choices=SourceType.choices, db_index=True)
    source_question_id = models.UUIDField(help_text="ID –≤ CEFRQuestion –∏–ª–∏ LLMGeneratedQuestion")
    question_json = models.JSONField()
    created_at = models.DateTimeField(auto_now_add=True)

    objects = models.Manager()

    class Meta:
        indexes = [
            models.Index(fields=["session", "created_at"]),
            models.Index(fields=["source_type"]),
        ]
        ordering = ["created_at"]


class TestAnswer(models.Model):
    """
    –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π QuestionInstance.
    –ü–æ–ª–µ ai_feedback —Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç LLM-–æ—Ü–µ–Ω–∫–∏ (–¥–ª—è open-–æ—Ç–≤–µ—Ç–æ–≤) –∏/–∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    question = models.OneToOneField(QuestionInstance, on_delete=models.CASCADE, related_name="answer", db_index=True)
    answer_text = models.TextField(null=True, blank=True)
    answer_audio_url = models.URLField(null=True, blank=True)
    recognized_text = models.TextField(null=True, blank=True, help_text="STT result –µ—Å–ª–∏ –±—ã–ª voice")
    score = models.FloatField(null=True, blank=True, help_text="–û—Ü–µ–Ω–∫–∞ 0.0‚Äì1.0")
    ai_feedback = models.JSONField(null=True, blank=True)
    answered_at = models.DateTimeField(auto_now_add=True)

    objects = models.Manager()

    class Meta:
        indexes = [
            models.Index(fields=["question", "answered_at"]),
        ]

    def __str__(self):
        return f"Answer {self.id} question {self.question_id}"


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\tasks.py


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\tests.py
from django.test import TestCase

# Create your tests here.


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\urls.py
from django.urls import path, include

from .views import StartAssessmentView, QuestionView, FinishView

app_name = "assessment"

urlpatterns = [
    path("start/", StartAssessmentView.as_view(), name="start_test"),
    path("session/<uuid:session_id>/question/", QuestionView.as_view(), name="question_view"),
    path("session/<uuid:session_id>/finish/", FinishView.as_view(), name="finish_view"),
]


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\urls_api.py
from django.urls import path, include

app_name = "assessment-api"

# API-–≤–µ—Ä—Å–∏—è
urlpatterns = [
    path("assessment/", include("assessment.api.urls")),
]

#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\views.py
from django.contrib.auth.mixins import LoginRequiredMixin
from django.views import View
from django.shortcuts import render, redirect, get_object_or_404
from django.urls import reverse, reverse_lazy

from utils.setup_logger import setup_logger
from .forms import QuestionAnswerForm
from .models import QuestionInstance, TestSession, SessionSourceType
from .services.assessment_service import start_assessment_for_user, get_next_question_for_session, submit_answer, \
    finish_assessment
from .services.test_flow import MAIN_QUESTIONS_LIMIT

assessment_logger = setup_logger(name=__file__, log_dir="logs/core/assessment", log_file="assessment.log")


class StartAssessmentView(LoginRequiredMixin, View):
    """–ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —è–∑—ã–∫–∞"""

    def get(self, request):
        return render(request, template_name="assessment/start.html", context={})

    def post(self, request):
        session, expired_flag = start_assessment_for_user(request.user)
        redirect_url = reverse_lazy(
            "assessment:question_view",
            kwargs={"session_id": session.id}
        )
        if expired_flag:
            redirect_url += "?expired_flag=True"
        return redirect(redirect_url)


class QuestionView(LoginRequiredMixin, View):
    """–í—ã–¥–∞—á–∞ –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –Ω–µ–≥–æ"""

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.presentation_service = QuestionPresentationService()
        self.progress_service = AssessmentProgressService()

    def get(self, request, session_id):
        session = get_object_or_404(TestSession, id=session_id, user_id=request.user.id)
        next_question, status = get_next_question_for_session(
            session=session,
            source_question_request=SessionSourceType.WEB
        )
        if status == "expired":
            return redirect(reverse("assessment:start_test"))
        if not next_question:
            return redirect(reverse("assessment:finish_view", args=[str(session.id)]))

        form = QuestionAnswerForm(initial={
            "session_id": session.id,
            "question_instance_id": next_question.id
        })

        formatted_question = self.presentation_service.format_for_web(next_question)
        question_number = self.progress_service.get_question_number(session)

        context = {
            "total_questions": MAIN_QUESTIONS_LIMIT,
            "question": next_question.question_json,
            "question_number": question_number,
            "session": session,
            "question_inst": next_question,
            "text_content": formatted_question["text_content"],
            "question_content": formatted_question["question_content"],
            "form": form
        }

        return render(request, "assessment/question.html", context)

    def post(self, request, session_id):
        form = QuestionAnswerForm(request.POST)
        if not form.is_valid():
            return render(request, "assessment/error.html", {"message": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞."})

        session = get_object_or_404(TestSession, id=session_id, user_id=request.user.id)
        qinst = form.cleaned_data["qinst"]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ —É–∂–µ –¥–∞–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
        if not self.progress_service.has_existing_answer(qinst):
            answer_text = form.cleaned_data["answer_text"]
            submit_answer(session, qinst, answer_text)

        return redirect(reverse("assessment:question_view", args=[str(session.id)]))

#
# class QuestionView(LoginRequiredMixin, View):
#     """–í—ã–¥–∞—á–∞ –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –Ω–µ–≥–æ"""
#
#     def get(self, request, session_id):
#         session = get_object_or_404(TestSession, id=session_id, user_id=request.user.id)
#         next_question, status = get_next_question_for_session(
#             session=session,
#             source_question_request=SessionSourceType.WEB
#         )
#
#         if status == "expired":
#             return redirect(reverse("assessment:start_test"))
#         if not next_question:
#             return redirect(reverse("assessment:finish_view", args=[str(session.id)]))
#
#         form = QuestionAnswerForm(initial={
#             "session_id": session.id,
#             "question_instance_id": next_question.id
#         })
#
#         question_text = next_question.question_json.get("question_text", "")
#         text_content = ""
#         question_content = question_text
#         if "Text:" in question_text and "Question:" in question_text:
#             try:
#                 text_part = question_text.split("Text:")[1]
#                 text_content = text_part.split("Question:")[0].strip()
#                 question_content = text_part.split("Question:")[1].strip()
#             except IndexError:
#                 pass
#
#         question_number = QuestionInstance.objects.filter(session=session).exclude(answer__isnull=True).count() + 1
#         return render(request, "assessment/question.html", {
#             "total_questions": MAIN_QUESTIONS_LIMIT,
#             "question": next_question.question_json,
#             "question_number": question_number,
#             "session": session,
#             "question_inst": next_question,
#             "text_content": text_content,
#             "question_content": question_content,
#             "form": form
#         })
#
#     def post(self, request, session_id):
#         form = QuestionAnswerForm(request.POST)
#         if not form.is_valid():
#             return render(request, "assessment/error.html", {"message": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞."})
#
#         session = get_object_or_404(TestSession, id=session_id, user_id=request.user.id)
#         qinst = form.cleaned_data["qinst"]
#         if not hasattr(qinst, "answer"):  # –≤–æ–ø—Ä–æ—Å —É–∂–µ –∏–º–µ–µ—Ç –æ—Ç–≤–µ—Ç - –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è web/tg
#             answer_text = form.cleaned_data["answer_text"]
#             submit_answer(session, qinst, answer_text)
#
#         return redirect(reverse("assessment:question_view", args=[str(session.id)]))


class FinishView(LoginRequiredMixin, View):
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞"""

    def get(self, request, session_id):
        test_session_qs = TestSession.objects.prefetch_related("questions__answer")
        session = get_object_or_404(test_session_qs, id=session_id, user_id=request.user.id)
        protocol = finish_assessment(session)

        return render(request, "assessment/finish.html", {"protocol": protocol, "session": session})


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\api\api_answer_sample.txt
# –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è —Å—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Core API

{
    "metadata": {
        "message_id": 12345,  # ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ core
        "conversation_id": "conv_abc123",
        "processing_time_ms": 245,
        "assistant_slug": "english_teacher_v2"
    },
    "content": {
        "type": "text",  # text, photo, document, audio, voice, video, media_group, sticker, location, contact, poll
        "text": "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?",  # –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        "caption": "",  # –ü–æ–¥–ø–∏—Å—å –∫ –º–µ–¥–∏–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
        "media": [
            {
                "type": "photo",
                "url": "https://example.com/image.jpg",
                "width": 800,
                "height": 600,
                "file_size": 120000
            }
        ],
        "keyboard": {
            "type": "inline",
            "buttons": [
                {
                    "text": "üìö –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ",
                    "callback_data": "menu:study"
                },
                {
                    "text": "üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç",
                    "callback_data": "menu:test"
                }
            ],
            "layout": [2]
        }
    },
    "effects": {
        "message_effect_id": "5046509860389126442",  # ID —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        "silent": false,  # –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –±–µ–∑ –∑–≤—É–∫–∞
        "pin": false  # –ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    },
    "context": {
        "conversation_state": "active",
        "session_data": {
            "last_topic": "grammar",
            "difficulty_level": "intermediate"
        }
    },
    "actions": {
        "save_to_history": true,
        "notify_admin": false,
        "trigger_event": "user_engaged"
    }
}

# –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç

{
    "metadata": {
        "message_id": 12346,
        "conversation_id": "conv_abc123"
    },
    "content": {
        "type": "text",
        "text": "–ü—Ä–∏–≤–µ—Ç! –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å. –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?"
    }
}

# –§–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é –∏ –∫–Ω–æ–ø–∫–∞–º–∏

{
    "metadata": {
        "message_id": 12347,
        "conversation_id": "conv_abc123"
    },
    "content": {
        "type": "photo",
        "text": "–í–æ—Ç –ø—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º—ë–Ω –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º:",
        "media": [
            {
                "type": "photo",
                "url": "https://example.com/tenses_chart.jpg",
                "width": 1200,
                "height": 800
            }
        ],
        "keyboard": {
            "type": "inline",
            "buttons": [
                {
                    "text": "–ï—â–µ –ø—Ä–∏–º–µ—Ä—ã",
                    "callback_data": "more_examples:tenses"
                },
                {
                    "text": "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
                    "callback_data": "ask_question"
                }
            ],
            "layout": [2]
        }
    }
}

# –ú–µ–¥–∏–∞-–≥—Ä—É–ø–ø–∞ (–∞–ª—å–±–æ–º)

{
    "metadata": {
        "message_id": 12348,
        "conversation_id": "conv_abc123"
    },
    "content": {
        "type": "media_group",
        "text": "–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞:",
        "media": [
            {
                "type": "photo",
                "url": "https://example.com/example1.jpg",
                "width": 800,
                "height": 600
            },
            {
                "type": "photo",
                "url": "https://example.com/example2.jpg",
                "width": 800,
                "height": 600
            },
            {
                "type": "video",
                "url": "https://example.com/explanation.mp4",
                "width": 1280,
                "height": 720,
                "duration": 45
            }
        ]
    }
}

# –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

{
    "metadata": {
        "message_id": 12349,
        "conversation_id": "conv_abc123"
    },
    "content": {
        "type": "voice",
        "text": "–ü–æ—Å–ª—É—à–∞–π—Ç–µ, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—Å—è —ç—Ç–æ —Å–ª–æ–≤–æ:",
        "media": [
            {
                "type": "voice",
                "url": "https://example.com/pronunciation.ogg",
                "duration": 3.5
            }
        ]
    }
}

#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\api\urls.py
from django.urls import path
from .views import StartAssessmentTestAPIView, AnswerAPIView

urlpatterns = [
    path("start/", StartAssessmentTestAPIView.as_view(), name="api-start-assessment-test"),
    path("session/<uuid:session_id>/<uuid:question_id>/answer/", AnswerAPIView.as_view(), name="api-assessment-answer"),
]


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\api\views.py
from rest_framework import status
from rest_framework.response import Response
from rest_framework.views import APIView
from django.conf import settings

from ai_assistant.models import AIAssistant
from chat.models import Chat, ChatPlatform, Message, MessageSource
from engageai_core.mixins import BotAuthenticationMixin, TelegramUserResolverMixin

from utils.setup_logger import setup_logger
from ..mixins import AssessmentTestSessionMixin, QuestionInstanceMixin
from ..models import QuestionInstance, SessionSourceType
from ..services.assessment_service import start_assessment_for_user, \
    get_next_question_for_session, submit_answer, finish_assessment
from ..services.presentation_service import AssessmentProgressService
from ..services.telegram_service import TelegramAssessmentService
from ..services.test_flow import MAIN_QUESTIONS_LIMIT


core_api_logger = setup_logger(name=__file__, log_dir="logs/core_api", log_file="core_api.log")

#
# class StartAssessmentAPI(BotAuthenticationMixin, TelegramUserResolverMixin, APIView):
#     """–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ API —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–ª—é—á–∞"""
#
#     def post(self, request):
#         bot = getattr(request, "internal_bot", None)
#         bot_tag = f"[bot:{bot}]"
#
#         user_resolve_result = self.resolve_telegram_user(request)
#         if isinstance(user_resolve_result, dict):
#             result = user_resolve_result
#             return Response(result["payload"], status=result["response_status"])
#         user = user_resolve_result
#
#         incoming_message_id = str(request.data.get("telegram_message_id")) if request.data.get(
#             "telegram_message_id") else None
#
#         core_api_logger.info(f"{bot_tag} Start TestSession for user={user.id}")
#
#         session, expired_flag = start_assessment_for_user(
#             user,
#             source=SessionSourceType.TELEGRAM
#         )
#
#         if expired_flag:
#             core_api_logger.info(
#                 f"{bot_tag} Previous session expired ‚Üí new created | user={user.id}"
#             )
#
#         # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
#         question, status_ = get_next_question_for_session(
#             session=session,
#             source_question_request=SessionSourceType.TELEGRAM
#         )
#
#         if not question:
#             core_api_logger.error(f"{bot_tag} Failed to generate first question | session={session.id}")
#             return Response(
#                 {"success": False, "detail": "Failed to generate question"},
#                 status=status.HTTP_500_INTERNAL_SERVER_ERROR
#             )
#         # TODO –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç –±–æ—Ç–∞ assistant_slug
#         assistant_slug = "main_orchestrator"
#         try:
#             assistant = AIAssistant.objects.get(slug=assistant_slug, is_active=True)
#         except AIAssistant.DoesNotExist:
#             return Response(
#                 {"success": False, "detail": f"Failed to find AIAssistant with slug={assistant_slug}"},
#                 status=500
#             )
#
#         chat, created = Chat.get_or_create_ai_chat(
#             user=user,
#             ai_assistant=assistant,
#             platform=ChatPlatform.TELEGRAM,
#         )
#
#         reply_to_msg = None
#
#         if incoming_message_id:
#             reply_to_msg = Message.objects.filter(
#                 source_type=MessageSource.TELEGRAM,
#                 metadata__telegram__message_id=incoming_message_id,
#                 chat=chat
#             ).first()
#         ai_message = Message.objects.create(
#             chat=chat,
#             content=question.question_json["question_text"],
#             is_ai=True,
#             source_type=MessageSource.TELEGRAM,
#             sender=None,
#             reply_to=reply_to_msg,
#             external_id=None,
#         )
#
#         question_number = QuestionInstance.objects.filter(session=session).exclude(answer__isnull=True).count() + 1
#
#         return Response(
#             {
#                 "expired_previous": expired_flag,
#                 "session_id": session.id,
#                 "question": {
#                     "id": question.id,
#                     "text": question.question_json["question_text"],
#                     "type": question.question_json["type"],
#                     "options": question.question_json.get("options"),
#                     "number": question_number,
#                     "total_questions": MAIN_QUESTIONS_LIMIT,
#                 },
#                 "core_message_id": ai_message.id
#             },
#             status=201
#         )


class StartAssessmentTestAPIView(BotAuthenticationMixin, TelegramUserResolverMixin, APIView):
    """–ó–∞–ø—É—Å–∫ TestSession"""

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.telegram_service = TelegramAssessmentService()
        self.progress_service = AssessmentProgressService()

    def post(self, request):
        bot = getattr(request, "internal_bot", None)
        bot_tag = f"[bot:{bot}]"

        # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_resolve_result = self.resolve_telegram_user(request)
        if isinstance(user_resolve_result, Response):
            response = user_resolve_result
            return response

        user = user_resolve_result

        incoming_message_id = str(request.data.get("telegram_message_id")) if request.data.get(
            "telegram_message_id") else None
        core_api_logger.info(f"{bot_tag} Start TestSession for user={user.id}")

        session, expired_flag = start_assessment_for_user(
            user,
            source=SessionSourceType.TELEGRAM
        )

        if expired_flag:
            core_api_logger.info(f"{bot_tag} Previous session expired ‚Üí new created | user={user.id}")

        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
        question, status_ = get_next_question_for_session(
            session=session,
            source_question_request=SessionSourceType.TELEGRAM
        )
        if not question:
            core_api_logger.error(f"{bot_tag} Failed to generate first question | session={session.id}")
            return Response(
                {"success": False, "detail": "Failed to generate question"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

        # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
        ai_message = self.telegram_service.create_question_message(
            user=user,
            session=session,
            question=question,
            incoming_message_id=incoming_message_id,
            bot=bot
        )

        if isinstance(ai_message, Response):
            return ai_message

        question_number = self.progress_service.get_question_number(session)

        return Response(
            {
                "expired_previous": expired_flag,
                "session_id": session.id,
                "question": {
                    "id": question.id,
                    "text": question.question_json["question_text"],
                    "type": question.question_json["type"],
                    "options": question.question_json.get("options"),
                    "number": question_number,
                    "total_questions": MAIN_QUESTIONS_LIMIT,
                },
                "core_answer": {
                    "core_message_id": ai_message.id,
                    "reply_to_message_id": incoming_message_id,
                },
            },
            status=201
        )
#
# class AnswerAPI(
#     BotAuthenticationMixin, TelegramUserResolverMixin, AssessmentTestSessionMixin,
#     QuestionInstanceMixin, APIView
# ):
#     def post(self, request, session_id, question_id):
#         bot = getattr(request, "internal_bot", None)
#         bot_tag = f"[bot:{bot}]"
#
#         telegram_id = request.data.get("telegram_id")
#         answer_text = request.data.get("answer_text")
#         if not answer_text:
#             return Response({"detail": "answer_text missing"}, status=400)
#
#         user = self.get_telegram_user(request)
#         if isinstance(user, dict):
#             return user
#
#         session = self.get_user_session(session_id, user, bot_tag)
#         if isinstance(session, dict):
#             return session
#
#         qinst = self.get_question_instance(question_id, session, bot_tag)
#         if isinstance(qinst, dict):
#             return qinst
#
#         if not hasattr(qinst, "answer"):  # –≤–æ–ø—Ä–æ—Å —É–∂–µ –∏–º–µ–µ—Ç –æ—Ç–≤–µ—Ç - –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è web/tg
#             submit_answer(session, qinst, answer_text)
#
#             core_api_logger.info(
#                 f"{bot_tag} Answer received | {session} qinst={qinst} text='{answer_text}'"
#             )
#         print("AnswerAPI")
#         print(request.data)
#         incoming_message_id = str(request.data.get("telegram_message_id")) if request.data.get(
#             "telegram_message_id") else None
#         reply_to_msg = None
#
#         # TODO –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç –±–æ—Ç–∞ assistant_slug
#         assistant_slug = "main_orchestrator"
#         try:
#             assistant = AIAssistant.objects.get(slug=assistant_slug, is_active=True)
#         except AIAssistant.DoesNotExist:
#             return Response(
#                 {"success": False, "detail": f"Failed to find AIAssistant with slug={assistant_slug}"},
#                 status=500
#             )
#         print(assistant)
#         chat, created = Chat.get_or_create_ai_chat(
#             user=user,
#             ai_assistant=assistant,
#             platform=ChatPlatform.TELEGRAM,
#         )
#         print(chat)
#
#         if incoming_message_id:
#             reply_to_msg = Message.objects.filter(
#                 source_type=MessageSource.TELEGRAM,
#                 metadata__telegram__message_id=incoming_message_id,
#                 chat=chat
#             ).first()
#         print("incoming_message_id", incoming_message_id)
#         print("reply_to_msg", reply_to_msg)
#         # –ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
#         next_q, status_ = get_next_question_for_session(
#             session=session,
#             source_question_request=SessionSourceType.TELEGRAM
#         )
#
#         if status_ == "expired":
#             return Response(
#                 {"success": False, "detail": "Session expired"},
#                 status=400
#             )
#
#         if not next_q:
#             # –∫–æ–Ω–µ—Ü —Ç–µ—Å—Ç–∞
#             protocol = finish_assessment(session)
#             level = protocol.get("estimated_level")
#
#             view_url = (
#                 f"{settings.SITE_URL}/assessment/result/{session.id}/"
#                 # f"http://127.0.0.1:8000/assessment/result/{session.id}/"
#             )
#
#             core_api_logger.info(
#                 f"{bot_tag} Test finished | session={session_id} user={user.id}"
#             )
#
#
#
#             msg = f"üéâ <b>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</b>\n\n"
#             f"–í–∞—à —É—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ: <b>{level}</b> üéØ\n\n"
#             f"–°–µ–π—á–∞—Å AI –≤—ã–ø–æ–ª–Ω–∏—Ç –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞—Å—Ç –ø–æ–ª–Ω—ã–π —Ä–∞–∑–±–æ—Ä, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.\n"
#             f"–ó–∞–≥–ª—è–Ω–∏—Ç–µ ‚Äî —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω–æ üëá\n"
#             print(reply_to_msg)
#             ai_message = Message.objects.create(
#                 chat=chat,
#                 content=msg,
#                 is_ai=True,
#                 source_type=MessageSource.TELEGRAM,
#                 sender=None,
#                 reply_to=reply_to_msg,
#                 external_id=None,
#             )
#
#             return Response(
#                 {
#                     "finished": True,
#                     "level": level,
#                     "session_id": str(session.id),
#                     "view_url": view_url,
#                     "ai_message_id": ai_message.id
#                 }
#             )
#
#         # TODO –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç –±–æ—Ç–∞ assistant_slug
#         assistant_slug = "main_orchestrator"
#         try:
#             assistant = AIAssistant.objects.get(slug=assistant_slug, is_active=True)
#         except AIAssistant.DoesNotExist:
#             return Response(
#                 {"success": False, "detail": f"Failed to find AIAssistant with slug={assistant_slug}"},
#                 status=500
#             )
#
#         chat, created = Chat.get_or_create_ai_chat(
#             user=user,
#             ai_assistant=assistant,
#             platform=ChatPlatform.TELEGRAM,
#         )
#
#         ai_message = Message.objects.create(
#             chat=chat,
#             content=next_q.question_json["question_text"],
#             is_ai=True,
#             source_type=MessageSource.TELEGRAM,
#             sender=None,
#             reply_to=reply_to_msg,
#             external_id=None,
#         )
#
#         question_number = QuestionInstance.objects.filter(session=session).exclude(answer__isnull=True).count() + 1
#
#         return Response(
#             {
#                 "success": True,
#                 "next_question": {
#                     "id": next_q.id,
#                     "text": next_q.question_json["question_text"],
#                     "type": next_q.question_json["type"],
#                     "options": next_q.question_json.get("options"),
#                     "number": question_number,
#                     "total_questions": MAIN_QUESTIONS_LIMIT,
#                 },
#                 "ai_message_id": ai_message.id
#             }
#         )


class AnswerAPIView(
    BotAuthenticationMixin, TelegramUserResolverMixin, AssessmentTestSessionMixin,
    QuestionInstanceMixin, APIView
):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –∏ –≤—ã–¥–∞—á–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.telegram_service = TelegramAssessmentService()
        self.progress_service = AssessmentProgressService()

    def post(self, request, session_id, question_id):
        bot = getattr(request, "internal_bot", None)
        bot_tag = f"[bot:{bot}]"
        answer_text = request.data.get("answer_text")

        if not answer_text:
            return Response({"detail": "answer_text missing"}, status=400)

        # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_resolve_result = self.resolve_telegram_user(request)
        if isinstance(user_resolve_result, Response):
            response = user_resolve_result
            return response

        user = user_resolve_result

        session = self.get_user_session(session_id, user, bot_tag)
        if isinstance(session, Response):
            return session

        qinst = self.get_question_instance(question_id, session, bot_tag)
        if isinstance(qinst, Response):
            return qinst

        incoming_message_id = str(request.data.get("telegram_message_id")) if request.data.get(
            "telegram_message_id") else None

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –±—ã–ª –¥–∞–Ω
        if not self.progress_service.has_existing_answer(qinst):
            submit_answer(session, qinst, answer_text)
            core_api_logger.info(
                f"{bot_tag} Answer received | {session} qinst={qinst} text='{answer_text}'"
            )

        # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        question, expired_flag = get_next_question_for_session(
            session=session,
            source_question_request=SessionSourceType.TELEGRAM
        )

        if expired_flag == "expired":  # TODO —Ç—É—Ç –Ω–µ —Å–æ–≤—Å–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            return Response(
                data={"success": False, "detail": "Session expired"},
                status=status.HTTP_400_BAD_REQUEST
            )

        # –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ—Ç, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ—Å—Ç
        if not question:
            protocol = finish_assessment(session)
            level = protocol.get("estimated_level")
            view_url = f"{settings.SITE_URL}/assessment/result/{session.id}/"

            core_api_logger.info(f"{bot_tag} Test finished | session={session_id} user={user.id}")

            ai_message = self.telegram_service.create_finish_message(
                user=user,
                session=session,
                level=level,
                view_url=view_url,
                incoming_message_id=incoming_message_id,
                bot=bot
            )

            if isinstance(ai_message, Response):
                return ai_message

            return Response(
                {
                    "finished": True,
                    "session_id": str(session.id),
                    "level": level,
                    "view_url": view_url,
                    "core_answer": {
                        "core_message_id": ai_message.id,
                        "reply_to_message_id": incoming_message_id,
                    }
                }
            )

        # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        ai_message = self.telegram_service.create_question_message(
            user=user,
            session=session,
            question=question,
            incoming_message_id=incoming_message_id,
            bot=bot
        )

        if isinstance(ai_message, Response):
            return ai_message

        question_number = self.progress_service.get_question_number(session)

        return Response(
            {
                "expired_previous": expired_flag,
                "session_id": session.id,
                "question": {
                    "id": question.id,
                    "text": question.question_json["question_text"],
                    "type": question.question_json["type"],
                    "options": question.question_json.get("options"),
                    "number": question_number,
                    "total_questions": MAIN_QUESTIONS_LIMIT,
                },
                "core_answer": {
                    "core_message_id": ai_message.id,
                    "reply_to_message_id": incoming_message_id,
                }
            },
            status=status.HTTP_200_OK
        )


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\management\commands\load_cefr_seed.py
import json
import os
from django.core.management.base import BaseCommand, CommandError
from django.conf import settings

from assessment.models import CEFRQuestion


class Command(BaseCommand):
    help = "Load CEFR question seed from fixtures/cefr_test_questions.json"

    def handle(self, *args, **options):
        # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞
        fixture_path = os.path.join(
            settings.BASE_DIR,
            "fixtures",
            "cefr_test_questions.json",
        )

        if not os.path.exists(fixture_path):
            raise CommandError(f"Fixture not found: {fixture_path}")

        # –ß–∏—Ç–∞–µ–º JSON
        try:
            with open(fixture_path, "r", encoding="utf-8") as f:
                data = json.load(f)
        except Exception as e:
            raise CommandError(f"Failed to load JSON: {e}")

        if not isinstance(data, list):
            raise CommandError("JSON root must be a list of question objects")

        created = 0

        for item in data:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if "question_text" not in item:
                self.stderr.write(self.style.WARNING("Skipped item without question_text"))
                continue

            CEFRQuestion.objects.create(
                level=item.get("level", "A1"),
                type=item.get("type", "open"),
                question_text=item["question_text"],
                options=item.get("options"),
                correct_answer=item.get("correct_answer"),
                explanation=item.get("explanation")
            )

            created += 1

        self.stdout.write(
            self.style.SUCCESS(f"Loaded {created} CEFR questions from seed")
        )


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\migrations\0001_initial.py
# Generated by Django 5.2.8 on 2026-01-20 15:44

import django.contrib.postgres.fields
import django.db.models.deletion
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='CEFRQuestion',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('level', models.CharField(choices=[('A1', 'Beginner (A1)'), ('A2', 'Elementary (A2)'), ('B1', 'Intermediate (B1)'), ('B2', 'Upper Intermediate (B2)'), ('C1', 'Advanced (C1)'), ('C2', 'Proficiency (C2)')], db_index=True, max_length=2)),
                ('type', models.CharField(choices=[('mcq', 'Multiple Choice'), ('open', 'Open Answer'), ('reading', 'Understanding Text')], db_index=True, max_length=10)),
                ('question_text', models.TextField()),
                ('options', django.contrib.postgres.fields.ArrayField(base_field=models.CharField(max_length=500), blank=True, help_text='–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è MCQ (—Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫). –î–ª—è open = null', null=True, size=None)),
                ('correct_answer', models.JSONField(blank=True, help_text='{"index": 0} –¥–ª—è MCQ –∏–ª–∏ {"text":"..."} –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏', null=True)),
                ('explanation', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'ordering': ['level'],
                'indexes': [models.Index(fields=['level', 'type'], name='assessment__level_35db11_idx')],
            },
        ),
        migrations.CreateModel(
            name='LLMGeneratedQuestion',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('template_id', models.CharField(blank=True, help_text='–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–º–ø—Ç–∞/—à–∞–±–ª–æ–Ω–∞', max_length=128, null=True)),
                ('user_id', models.UUIDField(db_index=True, help_text='UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤–æ–ø—Ä–æ—Å')),
                ('test_session_id', models.UUIDField(db_index=True, help_text='ID TestSession –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏')),
                ('question_json', models.JSONField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['user_id'], name='assessment__user_id_3ede3c_idx'), models.Index(fields=['test_session_id'], name='assessment__test_se_d80758_idx')],
            },
        ),
        migrations.CreateModel(
            name='TestSession',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('started_at', models.DateTimeField(auto_now_add=True)),
                ('finished_at', models.DateTimeField(blank=True, null=True)),
                ('expired_at', models.DateTimeField(blank=True, null=True)),
                ('time_limit_minutes', models.IntegerField(default=60, help_text='–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö')),
                ('locked_by', models.CharField(choices=[('web', '–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ'), ('tg', '–°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞ –≤ –±–æ—Ç–µ')], default='web', help_text="–ö—Ç–æ –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π –º–æ–º–µ–Ω—Ç '–¥–µ—Ä–∂–∏—Ç' —Å–µ—Å—Å–∏—é (web/telegram)", max_length=32)),
                ('estimated_level', models.CharField(blank=True, choices=[('A1', 'Beginner (A1)'), ('A2', 'Elementary (A2)'), ('B1', 'Intermediate (B1)'), ('B2', 'Upper Intermediate (B2)'), ('C1', 'Advanced (C1)'), ('C2', 'Proficiency (C2)')], db_index=True, max_length=2, null=True)),
                ('protocol_json', models.JSONField(blank=True, null=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-started_at'],
            },
        ),
        migrations.CreateModel(
            name='QuestionInstance',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('source_type', models.CharField(choices=[('cefr', '–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π CEFR –∏–∑ –±–∞–Ω–∫–∞'), ('llm', '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω LLM')], db_index=True, max_length=10)),
                ('source_question_id', models.UUIDField(help_text='ID –≤ CEFRQuestion –∏–ª–∏ LLMGeneratedQuestion')),
                ('question_json', models.JSONField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('session', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='questions', to='assessment.testsession')),
            ],
            options={
                'ordering': ['created_at'],
            },
        ),
        migrations.CreateModel(
            name='TestAnswer',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('answer_text', models.TextField(blank=True, null=True)),
                ('answer_audio_url', models.URLField(blank=True, null=True)),
                ('recognized_text', models.TextField(blank=True, help_text='STT result –µ—Å–ª–∏ –±—ã–ª voice', null=True)),
                ('score', models.FloatField(blank=True, help_text='–û—Ü–µ–Ω–∫–∞ 0.0‚Äì1.0', null=True)),
                ('ai_feedback', models.JSONField(blank=True, null=True)),
                ('answered_at', models.DateTimeField(auto_now_add=True)),
                ('question', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='answer', to='assessment.questioninstance')),
            ],
            options={
                'indexes': [models.Index(fields=['question', 'answered_at'], name='assessment__questio_445365_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='testsession',
            index=models.Index(fields=['user_id', 'started_at'], name='assessment__user_id_e98f75_idx'),
        ),
        migrations.AddIndex(
            model_name='testsession',
            index=models.Index(fields=['estimated_level'], name='assessment__estimat_ebcf72_idx'),
        ),
        migrations.AddIndex(
            model_name='questioninstance',
            index=models.Index(fields=['session', 'created_at'], name='assessment__session_2b5987_idx'),
        ),
        migrations.AddIndex(
            model_name='questioninstance',
            index=models.Index(fields=['source_type'], name='assessment__source__9b7fc5_idx'),
        ),
    ]


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\services\assessment_service.py
"""
–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –¥–ª—è —Ç–µ—Å—Ç–∞ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —è–∑—ã–∫–∞.
–°–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Å—Å–∏–∏, –≤—ã–¥–∞—á–∏ –≤–æ–ø—Ä–æ—Å–æ–≤, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏.
–ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –≤–µ–±-–≤—å—é, —Ç–∞–∫ –∏ DRF –∏–ª–∏ –±–æ—Ç–∞–º–∏.
"""

from django.utils import timezone

from users.models import Student, CEFRLevel
from utils.setup_logger import setup_logger
from ..models import TestSession, QuestionInstance, TestAnswer, SessionSourceType
from .test_flow import (
    create_diagnostic_questions,
    get_next_unanswered_question,
    determine_range_from_diagnostic,
    load_questions_for_range,
    can_generate_next_main_packet,
    finalize_session,
)
from .process_llm import evaluate_open_answer, generate_final_recommendations, task_evaluate_open_answer, \
    task_generate_final_report

assessment_logger = setup_logger(name=__file__, log_dir="logs/core/assessment", log_file="assessment.log")


def start_assessment_for_user(user, source=SessionSourceType.WEB):
    """
    –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é, –µ—Å–ª–∏ —Å—Ç–∞—Ä–∞—è –∏—Å—Ç–µ–∫–ª–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (session, expired_flag)
    """
    assessment_logger.debug(f"[assessment] –°—Ç–∞—Ä—Ç —Ç–µ—Å—Ç–∞ –¥–ª—è user={user.id}")

    expired_flag = False

    session = TestSession.objects.filter(user=user, finished_at__isnull=True).first()

    if session and session.is_active:
        expires_at = session.started_at + timezone.timedelta(minutes=session.time_limit_minutes)
        if timezone.now() > expires_at:
            assessment_logger.info(
                f"[assessment] TestSession {session.id} –∏—Å—Ç–µ–∫–ª–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏. "
                f"limit={session.time_limit_minutes}m user={user.id}"
            )
            session.mark_expired()
            expired_flag = True
            session = None

    if not session:
        session = TestSession.objects.create(user=user, locked_by=source)
        create_diagnostic_questions(session)
        assessment_logger.info(
            f"[assessment] –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è TestSession {session.id} –¥–ª—è user={user.id}"
        )

    return session, expired_flag


def get_next_question_for_session(session: TestSession, source_question_request: SessionSourceType ):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏ —Å—Ç–∞—Ç—É—Å (None –µ—Å–ª–∏ –Ω–µ—Ç)"""
    if session.is_active:
        expires_at = session.started_at + timezone.timedelta(minutes=session.time_limit_minutes)
        if timezone.now() > expires_at:

            assessment_logger.debug(f"TestSession {session.id} –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏—é"
                                    f" –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: {session.time_limit_minutes}")

            session.mark_expired()
            return None, "expired"

    next_question = get_next_unanswered_question(session)

    if session.locked_by != source_question_request:
        assessment_logger.debug(f"{session} locked_by={session.locked_by} –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø—Ä–∏—à–µ–ª –∏–∑ –¥—Ä—É–≥–æ–≥–æ "
                                f"–∏—Å—Ç–æ—á–Ω–∏–∫–∞ {source_question_request}")
    if not next_question and can_generate_next_main_packet(session):
        low, high = determine_range_from_diagnostic(session)
        load_questions_for_range(session, low, high)
        next_question = get_next_unanswered_question(session)

    assessment_logger.debug(f"TestSession {session.id} –≤—ã–¥–∞–Ω –≤–æ–ø—Ä–æ—Å {next_question}")

    return next_question, None


def submit_answer(session, qinst, answer_text):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –µ–≥–æ (MCQ –∏–ª–∏ open-–≤–æ–ø—Ä–æ—Å)"""
    answer_text = answer_text.strip()
    ans = TestAnswer.objects.create(question=qinst, answer_text=answer_text, answered_at=timezone.now())

    qj = qinst.question_json
    qtype = qj.get("type")
    if qtype == "mcq":
        options = qj.get("options") or []
        try:
            user_index = options.index(answer_text)
        except ValueError:
            user_index = None
        correct = qj.get("correct_answer", {}).get("index")
        if user_index is not None and correct is not None:
            ans.score = 1.0 if user_index == correct else 0.0
    else:
        # open-–≤–æ–ø—Ä–æ—Å: LLM –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç

        task_evaluate_open_answer.delay(str(ans.id))
        # eval_result = evaluate_open_answer(answer_text, qj)
        # assessment_logger.info(f"{session} LLM score for {ans}: {eval_result}")
        # ans.score = eval_result.get("score")
        # ans.ai_feedback = eval_result.get("feedback")

    ans.save()

    assessment_logger.info(f"{session} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –æ—Ç–≤–µ—Ç {ans}")

    return ans


def finish_assessment(session):
    """–§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Å—Å–∏—é –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ LLM"""
    if not session.finished_at:
        protocol = finalize_session(session)
        session.protocol_json = protocol
        session.finished_at = timezone.now()
        session.save(update_fields=["protocol_json", "finished_at"])

        estimated_level = protocol.get("estimated_level")

        if estimated_level in CEFRLevel.values:
            Student.objects.update_or_create(
                user=session.user,
                defaults={"english_level": estimated_level}
            )

        task_generate_final_report.delay(str(session.id))

    else:
        protocol = session.protocol_json
    return protocol


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\services\presentation_service.py
from django.db.models import Count
from assessment.models import QuestionInstance, TestSession


class QuestionPresentationService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º"""

    def format_for_web(self, question_instance):
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç question_json –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
        –†–∞–∑–¥–µ–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–∞–º –≤–æ–ø—Ä–æ—Å –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ "Text:" –∏ "Question:".
        """
        question_text = question_instance.question_json.get("question_text", "")
        text_content = ""
        question_content = question_text

        if "Text:" in question_text and "Question:" in question_text:
            try:
                text_part = question_text.split("Text:", 1)[1]
                parts = text_part.split("Question:", 1)
                text_content = parts[0].strip()
                question_content = parts[1].strip() if len(parts) > 1 else ""
            except (IndexError, ValueError):
                pass

        return {
            "full_text": question_text,
            "text_content": text_content,
            "question_content": question_content,
        }


class AssessmentProgressService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""

    def get_question_number(self, session: TestSession) -> int:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (1-–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π).
        –û—Å–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –≤ —Å–µ—Å—Å–∏–∏.
        """
        answered_count = QuestionInstance.objects.filter(
            session=session
        ).annotate(has_answer=Count("answer")).filter(has_answer__gt=0).count()
        return answered_count + 1

    def has_existing_answer(self, question_instance: QuestionInstance) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª –ª–∏ —É–∂–µ –¥–∞–Ω –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å.
        """
        return hasattr(question_instance, "answer") and question_instance.answer is not None


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\services\process_llm.py
import json
import os
import re
from typing import Optional, Dict, Any

from celery import shared_task
from django.utils import timezone
from dotenv import load_dotenv
from langchain_core.messages import SystemMessage, HumanMessage
from langchain_openai import ChatOpenAI

from users.models import Student
from utils.setup_logger import setup_logger
from ..models import TestSession, QuestionInstance, TestAnswer
from users.models import CEFRLevel

load_dotenv()

assessment_logger = setup_logger(name=__file__, log_dir="logs/core/assessment", log_file="assessment.log")


def _llm():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç ChatOpenAI.
    –ú–æ–¥–µ–ª—å: gpt-4o-mini
    """
    return ChatOpenAI(
        model="gpt-4o-mini",
        temperature=0.2,
        api_key=os.getenv("OPENAI_API_KEY")
    )

def extract_json_from_llm_response(text: str) -> Optional[Dict[str, Any]]:
    """
    –ü—ã—Ç–∞–µ—Ç—Å—è –∏–∑–≤–ª–µ—á—å –ø–µ—Ä–≤—ã–π –≤–∞–ª–∏–¥–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç (—Å–ª–æ–≤–∞—Ä—å) –∏–∑ —Ç–µ–∫—Å—Ç–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict –∏–ª–∏ None.
    """
    if not isinstance(text, str):
        return None

    text = text.strip()
    if not text:
        return None

    # 1. –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Å—ë –∫–∞–∫ –µ—Å—Ç—å
    try:
        parsed = json.loads(text)
        if isinstance(parsed, dict):
            return parsed
    except (json.JSONDecodeError, ValueError):
        pass

    # 2. –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ markdown-–±–ª–æ–∫–∏
    text = re.sub(r'^```(?:json)?\s*', '', text, flags=re.MULTILINE)
    text = re.sub(r'\s*```$', '', text, flags=re.MULTILINE)

    # 3. –ò—â–µ–º –±–ª–æ–∫–∏ {...} —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ–¥–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
    pattern = re.compile(r'\{(?:[^{}]|\{[^{}]*\})*\}', re.DOTALL)
    candidates = [m.group(0) for m in pattern.finditer(text)]

    # 4. Fallback: –æ—Ç –ø–µ—Ä–≤–æ–≥–æ { –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ }
    if not candidates:
        start = text.find('{')
        end = text.rfind('}')
        if start != -1 and end != -1 and start < end:
            candidates = [text[start:end + 1]]

    # 5. –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    for candidate in candidates:
        try:
            parsed = json.loads(candidate)
            if isinstance(parsed, dict):
                return parsed
        except (json.JSONDecodeError, ValueError):
            continue

    return None


def evaluate_open_answer(answer_text, question_json):
    """
    –û—Ü–µ–Ω–∫–∞ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
    –ù–∞ –æ—Å–Ω–æ–≤–µ LLM.
    """
    model = _llm()

    prompt = [
        ("system", "–¢—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ —É—Ä–æ–≤–Ω—è C2."),
        ("user", f"""
–û—Ü–µ–Ω–∏ –æ—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å. 
–î–∞–π —á–∏—Å–ª–æ–≤—É—é –æ—Ü–µ–Ω–∫—É 0.0‚Äì1.0, 
–∏ –∫—Ä–∞—Ç–∫–∏–π —Ñ–∏–¥–±—ç–∫.

–í–æ–ø—Ä–æ—Å:
{question_json.get("question_text")}

–û—Ç–≤–µ—Ç —É—á–µ–Ω–∏–∫–∞:
{answer_text}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
{{"score": float, "feedback": "text"}}
        """)
    ]

    response = model.invoke(prompt)
    # TODO –ø–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Ü–µ–Ω—ã, –∑–∞–ø–∏—Å—å –≤ –æ—Ç–≤–µ—Ç
    data = extract_json_from_llm_response(response.content)
    if data:
        return data

    return  {"score": 0.0, "feedback": "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏"}  # TODO 0 –∏–ª–∏ –í—ã—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫–æ–π —Ç–æ Alarm?


@shared_task(bind=True, max_retries=3)
def task_evaluate_open_answer(self, answer_id: str):
    """
    Celery-–∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
    –í—ã–∑—ã–≤–∞–µ—Ç LLM ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ TestAnswer.
    """
    from assessment.models import TestAnswer  # –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç

    try:
        answer = TestAnswer.objects.get(id=answer_id)
    except TestAnswer.DoesNotExist:
        assessment_logger.error(f"[LLM] answer {answer_id} not found")
        return

    qi = answer.question
    question_json = qi.question_json

    try:
        result = evaluate_open_answer(answer.answer_text, question_json)
    except Exception as exc:
        assessment_logger.exception(
            f"[LLM] error evaluating answer {answer_id}: {exc}"
        )
        raise self.retry(exc=exc, countdown=5)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    answer.score = float(result.get("score", 0.0))
    answer.ai_feedback = result.get("feedback")
    answer.save(update_fields=["score", "ai_feedback"])

    assessment_logger.info(
        f"[LLM] evaluated answer {answer_id} score={answer.score}"
    )

    return {"score": answer.score, "feedback": answer.ai_feedback}


def generate_final_recommendations(test_session_id: str) -> Dict[str, Any]:
    """
    –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è: —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏, —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–≥–∏–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç,
    –≤—ã–∑—ã–≤–∞–µ–º LLM —á–µ—Ä–µ–∑ LangChain ChatOpenAI, –ø–∞—Ä—Å–∏–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º –∏–ª–∏ fallback-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
    """

    # 1) –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é
    try:
        session = TestSession.objects.get(id=test_session_id)
    except TestSession.DoesNotExist:
        return {"error": "session_not_found", "session_id": str(test_session_id)}

    # 2) –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª (–¥–ª—è prompt)
    compact = _compact_protocol_for_prompt(session)

    # 3) –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ö–µ–º—É –æ—Ç–≤–µ—Ç–∞ (–∫–∞–∫ —Ç–µ–∫—Å—Ç) –∏ –ø—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ prompt
    schema_text = """
–û–ñ–ò–î–ê–ï–ú–´–ô –§–û–†–ú–ê–¢ JSON (—Å—Ç—Ä–æ–≥–æ!):
{
  "estimated_level": "A1|A2|B1|B2|C1|C2",
  "overall_score": 0.0,                     // —á–∏—Å–ª–æ 0.0-1.0
  "score_summary": {                        // —á–∏—Å–ª–∞ 0.0-1.0
     "grammar": 0.0,
     "vocabulary": 0.0,
     "listening": 0.0,
     "speaking": 0.0,
     "writing": 0.0
  },
  "strengths": ["...","..."],
  "weaknesses": ["...","..."],
  "recommendations": ["–∫–æ—Ä–æ—Ç–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ 1","–∫–æ—Ä–æ—Ç–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ 2"],
  "study_plan": ["–î–µ–Ω—å 1: ...","–î–µ–Ω—å 2: ...", "...", "–î–µ–Ω—å 7: ..."],  // —Ä–æ–≤–Ω–æ 7 —Å—Ç—Ä–æ–∫
  "confidence": 0.0,                        // 0.0-1.0
  "notes": "optional text",
  "raw_model_output": "optional full text for debug"
}
"""

    # 4) –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è LangChain
    system_msg = SystemMessage(content=(
        "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –∏ —ç–∫–∑–∞–º–µ–Ω–∞—Ç–æ—Ä. "
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON, "
        "—Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ. –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ JSON, "
        "–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"
    ))

    user_parts = [
        "–ù–∏–∂–µ ‚Äî –∫—Ä–∞—Ç–∫–∞—è –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –ø–∞—Ä ¬´–≤–æ–ø—Ä–æ—Å ‚Äî –æ—Ç–≤–µ—Ç¬ª (—Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è):",
        json.dumps(compact, ensure_ascii=False, indent=2),
        "",
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è overall_score -> CEFR:",
        "- overall_score >= 0.90 -> C2",
        "- 0.80 <= overall_score < 0.90 -> C1",
        "- 0.70 <= overall_score < 0.80 -> B2",
        "- 0.55 <= overall_score < 0.70 -> B1",
        "- 0.40 <= overall_score < 0.55 -> A2",
        "- overall_score < 0.40 -> A1",
        "",
        "–í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω JSON-–æ–±—ä–µ–∫—Ç, –∫–∞–∫ –≤ —Å—Ö–µ–º–µ –Ω–∏–∂–µ:",
        schema_text,
        "",
        "–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–ª–∏ –æ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, —Ç–æ –≤—ã—Å—Ç–∞–≤—å –æ—Ü–µ–Ω–∫–∏ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–≥–æ"
        " –∏—Å—Ö–æ–¥—è –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏ –≤–µ—Ä–Ω–∏ –ø–æ–ª–µ 'notes' —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–µ—Ä–Ω–∏ JSON."
        " –°—Ç–∞–≤—å –æ—Ü–µ–Ω–∫—É –Ω–æ–ª—å  - –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –≠–¢–û –í–ê–ñ–ù–û"
    ]
    user_msg = HumanMessage(content="\n".join(user_parts))

    # 5) –í—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
    try:
        model = _llm()
    except Exception as ex:
        return {"error": "llm_init_failed", "exception": str(ex)}

    try:
        response = model.invoke([system_msg, user_msg])  # –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç AIMessage –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–π –æ–±—ä–µ–∫—Ç
        model_output = getattr(response, "content", None) or getattr(response, "text", None) or str(response)
    except Exception as ex:
        return {"error": "llm_call_failed", "exception": str(ex)}

    # 6) –ü–∞—Ä—Å–∏–Ω–≥ JSON (—Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º json.loads –ø–æ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ, –∑–∞—Ç–µ–º _extract_json_from_text)
    parsed = extract_json_from_llm_response(response.content)

    if parsed:
        return parsed
    return {
            "estimated_level": None,
            "overall_score": None,
            "score_summary": {},
            "strengths": [],
            "weaknesses": [],
            "recommendations": [],
            "study_plan": [],
            "confidence": 0.0,
            "notes": "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON-–æ—Ç–≤–µ—Ç –æ—Ç LLM. –°–º. raw_model_output",
            "raw_model_output": model_output
        }


@shared_task(bind=True, max_retries=2)
def task_generate_final_report(self, session_id: str):
    """
    Celery-–∑–∞–¥–∞—á–∞ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ LLM.
    """

    try:
        session = TestSession.objects.get(id=session_id)
    except TestSession.DoesNotExist:
        return {"error": "not_found"}

    try:
        llm_result = generate_final_recommendations(session.id)
    except Exception as exc:
        assessment_logger.exception(
            f"[LLM] final report failed for session={session_id}: {exc}"
        )
        raise self.retry(exc=exc, countdown=10)

    if llm_result and "error" not in llm_result:
        try:
            # –ø—Ä–∏–≤–µ—Å—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –∫ –Ω—É–∂–Ω—ã–º —Ç–∏–ø–∞–º, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            if "overall_score" in llm_result:
                llm_result["overall_score"] = float(llm_result["overall_score"])
            if "confidence" in llm_result:
                llm_result["confidence"] = float(llm_result["confidence"])
            # –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ study_plan –∫–∞–∫ —Å–ø–∏—Å–∫–∞ –∏–∑ 7 —Å—Ç—Ä–æ–∫ (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–µ –ª–æ–º–∞–µ–º, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º)
            if "study_plan" in llm_result and isinstance(llm_result["study_plan"], list):
                pass
        except Exception as ex:
            assessment_logger.exception("generate_final_recommendations: normalization error: %s", str(ex))

        session.protocol_json["llm_report"] = llm_result
        session.protocol_json["analysis_generated_at"] = timezone.now().isoformat()
        session.save(update_fields=["protocol_json"])
        estimated_level = llm_result.get("estimated_level")

        if estimated_level in CEFRLevel.values:
            assessment_logger.info(
                f"[LLM] change level={estimated_level}"
            )

            sp, created = Student.objects.update_or_create(
                user=session.user,
                defaults={"english_level": estimated_level}
            )

            session.estimated_level = estimated_level
            session.save(update_fields=["estimated_level"])

    assessment_logger.info(
        f"[LLM] final report generated for session={session_id}"
    )

    return llm_result


def _compact_protocol_for_prompt(session: TestSession) -> Dict[str, Any]:
    """
    –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (–¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤),
    —Å–æ–¥–µ—Ä–∂–∞—â—É—é —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è: question_text, level, type, answer_text, score, ai_feedback.
    """
    compact = []
    q_instances = QuestionInstance.objects.filter(session=session).order_by("created_at")
    for qi in q_instances:
        main_answer = TestAnswer.objects.filter(question=qi).order_by("answered_at").first()
        qa = {
            "question_instance_id": str(qi.id),
            "level": qi.question_json.get("level"),
            "type": qi.question_json.get("type"),
            "question_text": qi.question_json.get("question_text"),
            "answer_text": main_answer.answer_text if main_answer else None,
            "score": float(main_answer.score) if main_answer and main_answer.score is not None else None,
            "ai_feedback": main_answer.ai_feedback if main_answer else None
        }
        compact.append(qa)
    return {"questions": compact, "questions_count": len(compact)}


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\services\telegram_service.py
from rest_framework import status
from rest_framework.response import Response
from django.conf import settings
from ai_assistant.models import AIAssistant
from chat.models import Chat, ChatPlatform, Message, MessageSource
from utils.setup_logger import setup_logger

core_api_logger = setup_logger(name=__name__, log_dir="logs/core_api", log_file="telegram_service.log")


class TelegramAssessmentService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ—Ü–µ–Ω–∫–∏ —É—Ä–æ–≤–Ω—è —Å Telegram-–±–æ—Ç–æ–º"""

    def __init__(self, assistant_slug="main_orchestrator"):
        self.assistant_slug = assistant_slug

    def _get_assistant(self):
        """–ü–æ–ª—É—á–∞–µ—Ç AIAssistant –ø–æ slug"""
        try:
            return AIAssistant.objects.get(slug=self.assistant_slug, is_active=True)
        except AIAssistant.DoesNotExist:
            core_api_logger.error(f"AIAssistant not found: slug={self.assistant_slug}")
            return None

    def _get_or_create_chat(self, user, assistant):
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç —á–∞—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞"""
        return Chat.get_or_create_ai_chat(
            user=user,
            ai_assistant=assistant,
            platform=ChatPlatform.TELEGRAM,
        )

    def _get_reply_message(self, chat, incoming_message_id):
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –ø–æ ID"""
        if not incoming_message_id:
            return None

        return Message.objects.filter(
            source_type=MessageSource.TELEGRAM,
            metadata__telegram__message_id=incoming_message_id,
            chat=chat
        ).first()

    def create_question_message(self, user, session, question, incoming_message_id=None, bot=None):
        """–°–æ–∑–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º –≤ —á–∞—Ç–µ"""
        bot_tag = f"[bot:{bot}]" if bot else ""

        assistant = self._get_assistant()
        if not assistant:
            core_api_logger.error(f"{bot_tag} Failed to find AIAssistant with slug={self.assistant_slug}")
            return Response(
                {"detail": f"Failed to find AIAssistant with slug={self.assistant_slug}"},
                status=status.HTTP_404_NOT_FOUND
            )

        chat, created = self._get_or_create_chat(user, assistant)
        reply_to_msg = self._get_reply_message(chat, incoming_message_id)

        ai_message = Message.objects.create(
            chat=chat,
            content=question.question_json["question_text"],  # TODO –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
            is_ai=True,
            source_type=MessageSource.TELEGRAM,
            sender=None,
            reply_to=reply_to_msg,
            external_id=None,
        )

        return ai_message

    def create_finish_message(self, user, session, level, view_url, incoming_message_id=None, bot=None):
        """–°–æ–∑–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞"""
        bot_tag = f"[bot:{bot}]" if bot else ""

        assistant = self._get_assistant()
        if not assistant:
            core_api_logger.error(f"{bot_tag} Failed to find AIAssistant with slug={self.assistant_slug}")
            return Response(
                {"success": False, "detail": f"Failed to find AIAssistant with slug={self.assistant_slug}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

        chat, created = self._get_or_create_chat(user, assistant)
        reply_to_msg = self._get_reply_message(chat, incoming_message_id)

        msg = (
            f"üéâ <b>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</b>\n"
            f"–í–∞—à —É—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ: <b>{level}</b> üéØ\n\n"
            f"–°–µ–π—á–∞—Å AI –≤—ã–ø–æ–ª–Ω–∏—Ç –∞–Ω–∞–ª–∏–∑ –∏ –¥–∞—Å—Ç –ø–æ–ª–Ω—ã–π —Ä–∞–∑–±–æ—Ä, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.\n"
            f"–ó–∞–≥–ª—è–Ω–∏—Ç–µ ‚Äî —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω–æ üëá\n"
            f"{view_url}"
        )

        ai_message = Message.objects.create(
            chat=chat,
            content=msg,
            is_ai=True,
            source_type=MessageSource.TELEGRAM,
            sender=None,
            reply_to=reply_to_msg,
            external_id=None,
        )

        return ai_message


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\services\test_flow.py
import logging
import uuid

from django.utils import timezone
import random

from assessment.models import CEFRQuestion, QuestionInstance, TestSession, TestAnswer, CEFRLevel, SourceType
from users.models import Student

from utils.setup_logger import setup_logger

logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
DIAGNOSTIC_ORDER = ["A1", "A2", "B1", "B2", "C1"]
DIAGNOSTIC_COUNT = len(DIAGNOSTIC_ORDER)

# –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–Ω–æ–º –ø–∞–∫–µ—Ç–µ
MAIN_QUESTIONS_PACKET_SIZE = 12
# –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–∫–µ—Ç–æ–≤ (–∏—Ç–µ—Ä–∞—Ü–∏–π)
MAIN_QUESTIONS_ITERATION_COUNTER = 0
# –æ–±—â–∏–π –º–∞–∫—Å–∏–º—É–º –≤–æ–ø—Ä–æ—Å–æ–≤
MAIN_QUESTIONS_LIMIT = DIAGNOSTIC_COUNT + MAIN_QUESTIONS_PACKET_SIZE * MAIN_QUESTIONS_ITERATION_COUNTER

assessment_logger = setup_logger(name=__file__, log_dir="logs/core/assessment", log_file="assessment.log")


# ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------

def pick_random_question(level: str) -> CEFRQuestion | None:
    """–í—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ —É—Ä–æ–≤–Ω—è"""
    qs = CEFRQuestion.objects.filter(level=level).values_list("id", flat=True)
    if not qs:
        return None
    qid = random.choice(list(qs))
    return CEFRQuestion.objects.get(id=qid)


def _clone_question_to_instance(session, source_obj, source_type="cefr"):
    """
    –°–æ–∑–¥–∞—ë—Ç QuestionInstance, –∫–æ–ø–∏—Ä—É—è question_json.
    source_obj –º–æ–∂–µ—Ç –±—ã—Ç—å CEFRQuestion –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç LLM (dict).
    """
    if source_type == "cefr":
        q = source_obj
        qi = QuestionInstance.objects.create(
            session=session,
            source_type="cefr",
            source_question_id=q.id,
            question_json={
                "id": str(q.id),
                "type": q.type,
                "level": q.level,
                "question_text": q.question_text,
                "options": q.options,
                "correct_answer": q.correct_answer,
                "explanation": q.explanation
            }
        )
        return qi
    else:
        # source_obj —É–∂–µ dict = question_json
        qi = QuestionInstance.objects.create(
            session=session,
            source_type="llm",
            source_question_id=source_obj.get("id") or uuid.uuid4(),
            question_json=source_obj
        )
        return qi


def can_generate_next_main_packet(session):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –ø–∞—Ä—Ç–∏—é –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
    """
    total_created = QuestionInstance.objects.filter(session=session).count()
    # 1) –¥–∞–∂–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
    if total_created < DIAGNOSTIC_COUNT:
        print("total_created < DIAGNOSTIC_COUNT", total_created < DIAGNOSTIC_COUNT)
        return False

    # 2) –≤—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —É–∂–µ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ
    main_created = total_created - DIAGNOSTIC_COUNT

    packets_done = main_created // MAIN_QUESTIONS_PACKET_SIZE
    print("packets_done < MAIN_QUESTIONS_ITERATION_COUNTER", packets_done < MAIN_QUESTIONS_ITERATION_COUNTER)

    return packets_done < MAIN_QUESTIONS_ITERATION_COUNTER


# ---------- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —ç—Ç–∞–ø ----------

def create_diagnostic_questions(session: TestSession):
    """
    –°–æ–∑–¥–∞—Å—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–∞–∫–µ—Ç –∏–∑ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —É—Ä–æ–≤–Ω—é
    –Ω–∞ –°2 –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
    """
    bulk_container = []
    for level in DIAGNOSTIC_ORDER:
        q = pick_random_question(level)
        if q:
            q_i = QuestionInstance(
                session=session,
                source_type="cefr",
                source_question_id=q.id,
                question_json={
                    "id": str(q.id),
                    "level": q.level,
                    "type": q.type,
                    "question_text": q.question_text,
                    "options": q.options,
                    "correct_answer": q.correct_answer,
                }
            )
            bulk_container.append(q_i)
    if bulk_container:
        qi_created = QuestionInstance.objects.bulk_create(bulk_container)

        assessment_logger.debug(f"–°–æ–∑–¥–∞–Ω –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø–∞–∫–µ—Ç –∏–∑ QuestionInstance"
                                f" –¥–ª—è TestSession {session.id}: [{qi_created}] ")
        return

    assessment_logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø–∞–∫–µ—Ç QuestionInstance –¥–ª—è TestSession {session.id}"
                            f" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º {DIAGNOSTIC_ORDER}")


# ---------- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–º –æ—Ç–≤–µ—Ç–∞–º ----------

def determine_range_from_diagnostic(session):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ –æ—Ü–µ–Ω–∫–∞–º —Ç–µ—Å—Ç–∞ –ø—Ä–∏–º–µ—Ä–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    # TODO –£–†–û–í–ù–ò –ü–†–ò–ú–ï–†–ù–´–ï –ù–£–ñ–ù–ê –ü–û–î–°–¢–†–û–ô–ö–ê –°–ü–ï–¶–ò–ê–õ–ò–°–¢–û–ú
    LEVEL_RANGES = [
        {"max": 1.5, "range": ("A1", "A2")},
        {"max": 2.5, "range": ("A2", "B1")},
        {"max": 3.5, "range": ("B1", "B2")},
        {"max": 4.5, "range": ("B2", "C1")},
    ]

    DEFAULT_RANGE = ("C1", "C2")

    answers = TestAnswer.objects.filter(question__session=session).order_by('answered_at')[:DIAGNOSTIC_COUNT]
    total = sum([a.score or 0 for a in answers])
    level_range = DEFAULT_RANGE

    for rule in LEVEL_RANGES:
        if total < rule["max"]:
            level_range = rule["range"]
            break
    assessment_logger.info(
        f"{session} –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è: score={total}, range={level_range}"
    )
    return level_range



# ---------- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ ----------

def load_questions_for_range(session, low, high, total=MAIN_QUESTIONS_PACKET_SIZE):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–∑—ã: –ø–æ–ª–æ–≤–∏–Ω–∞ lower, –ø–æ–ª–æ–≤–∏–Ω–∞ higher.
    –°–º–µ—à–∏–≤–∞–µ—Ç –∏—Ö –≤ —Å–ª—É—á–∞–π–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
    """
    # –ö–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≤ —Å–µ—Å—Å–∏–∏:
    used_cefr_ids = (
        QuestionInstance.objects.filter(
            session=session,
            source_type=SourceType.CEFR
        ).values_list("source_question_id", flat=True)
    )

    half = total // 2
    qs_low = list(
        CEFRQuestion.objects
        .filter(level=low)
        .exclude(id__in=used_cefr_ids)
        .order_by("?")[:half]
    )

    qs_high = list(
        CEFRQuestion.objects
        .filter(level=high)
        .exclude(id__in=used_cefr_ids)
        .order_by("?")[:total - half]
    )
    chosen = qs_low + qs_high
    random.shuffle(chosen)
    for q in chosen:
        _clone_question_to_instance(session, q, source_type="cefr")


# ---------- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ ----------

def get_next_unanswered_question(session):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π QuestionInstance –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ (first created order).
    """
    return QuestionInstance.objects.filter(session=session).exclude(answer__isnull=False).order_by(
        'created_at').first()


# ---------- –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –∏ —Ä–∞—Å—á—ë—Ç —É—Ä–æ–≤–Ω—è ----------

def finalize_session(session):
    """
    –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å.
    –°–æ—Ö—Ä–∞–Ω—è–µ–º protocol_json –∏ –æ—Ç–º–µ—á–∞–µ–º finished_at.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç protocol (dict).
    """
    answers = TestAnswer.objects.filter(question__session=session)
    total_questions = answers.count()
    total_score = sum([a.score or 0.0 for a in answers])
    ratio = (total_score / total_questions) if total_questions else 0.0

    # TODO –£–†–û–í–ù–ò –ü–†–ò–ú–ï–†–ù–´–ï –ù–£–ñ–ù–ê –ü–û–î–°–¢–†–û–ô–ö–ê –°–ü–ï–¶–ò–ê–õ–ò–°–¢–û–ú - —Ö–æ—Ç—è –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤—Å–µ –Ω–∞ –æ—Ü–µ–Ω–∫—É –≤ LLM
    if ratio < 0.4:
        level = CEFRLevel.A1
    elif ratio < 0.55:
        level = CEFRLevel.A2
    elif ratio < 0.7:
        level = CEFRLevel.B1
    elif ratio < 0.85:
        level = CEFRLevel.B2
    elif ratio < 0.95:
        level = CEFRLevel.C1
    else:
        level = CEFRLevel.C2

    protocol = {
        "total_questions": total_questions,
        "total_score": total_score,
        "ratio": round(ratio, 3),
        "estimated_level": level,
        "answers": []
    }

    for a in answers.select_related("question"):
        protocol["answers"].append({
            "question_id": str(a.question.source_question_id),
            "question": a.question.question_json,
            "answer_text": a.answer_text,
            "score": a.score,
            "ai_feedback": a.ai_feedback
        })

    session.estimated_level = level
    session.protocol_json = protocol
    session.finished_at = timezone.now()
    session.save(update_fields=["estimated_level", "protocol_json", "finished_at"])

    Student.objects.update_or_create(
        user=session.user,
        defaults={"english_level": level}
    )

    return protocol


#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\static\css\assessment.css
/* –°–¢–ò–õ–ò –°–¢–†–ê–ù–ò–¶–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø */

.test {
    padding: 40px 0;
    background: var(--color-bg);
    min-height: 100vh;
}

.test__container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    align-items: start;
}

/* –ü—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
.test__progress {
    grid-column: 1 / -1;
    margin-bottom: 20px;
}

.test-progress {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-sm);
}

.test-progress__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.test-progress__title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
}

.test-progress__stats {
    display: flex;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--color-text-muted);
}

.test-progress__current {
    font-weight: 600;
    color: var(--color-accent);
}

.test-progress__bar {
    height: 8px;
    background: var(--color-border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 12px;
}

.test-progress__fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-accent), var(--color-accent-dark));
    border-radius: 4px;
    transition: width 0.5s ease;
}

.test-progress__hint {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    text-align: center;
    padding: 8px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ */
.test__question {
    grid-column: 1;
}

.question {
    padding: 0;
}

.question__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 24px 16px;
    border-bottom: 1px solid var(--color-border);
}

.question-type-badge {
    padding: 6px 12px;
    background: var(--color-accent-soft);
    color: var(--color-accent-dark);
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.question__timer {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: var(--color-text-muted);
}

.timer__icon {
    font-size: 0.9rem;
}

.question__content {
    padding: 24px;
}

.question__text {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.4;
    margin-bottom: 16px;
}

.question__instruction {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-warning);
}

.instruction__icon {
    font-size: 1.2rem;
    flex-shrink: 0;
}

.instruction__text {
    font-size: 0.9rem;
    color: var(--color-text);
    line-height: 1.4;
    margin: 0;
}

/* –§–æ—Ä–º–∞ –≤–æ–ø—Ä–æ—Å–∞ */
.question__form {
    padding: 0 24px 24px;
}

/* –°–µ—Ç–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ */
.options-grid {
    display: grid;
    gap: 12px;
    margin-bottom: 24px;
}

.option-card {
    display: block;
    cursor: pointer;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: 0;
    background: var(--color-surface);
    transition: all 0.2s ease;
    position: relative;
}

.option-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.option-card--selected {
    border-color: var(--color-accent);
    background: var(--color-accent-soft);
}

.option-card__input {
    position: absolute;
    opacity: 0;
}

.option-card__content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
}

.option-card__text {
    flex: 1;
    font-size: 0.95rem;
    color: var(--color-text);
    line-height: 1.4;
}

.option-card__check {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-border);
    border-radius: 50%;
    flex-shrink: 0;
    margin-left: 12px;
    position: relative;
    transition: all 0.2s ease;
}

.option-card--selected .option-card__check {
    border-color: var(--color-accent);
    background: var(--color-accent);
}

.option-card--selected .option-card__check::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 0.7rem;
    font-weight: bold;
}

/* –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç */
.text-answer {
    margin-bottom: 24px;
}

.text-answer textarea {
    width: 100%;
    min-height: 120px;
    padding: 16px;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-surface);
    color: var(--color-text);
    font-size: 0.95rem;
    font-family: inherit;
    line-height: 1.5;
    resize: vertical;
    transition: border-color 0.2s ease;
}

.text-answer textarea:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-soft);
}

/* –î–µ–π—Å—Ç–≤–∏—è –≤–æ–ø—Ä–æ—Å–∞ */
.question__actions {
    text-align: center;
}

.question__submit {
    min-width: 200px;
}

/* –°–∞–π–¥–±–∞—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */
.test__sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: sticky;
    top: 100px;
}

.test-info,
.test-tips {
    padding: 20px;
}

.test-info__title,
.test-tips__title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--color-border);
}

.info-item {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.info-item:last-child {
    margin-bottom: 0;
}

.info-item__icon {
    width: 32px;
    height: 32px;
    background: var(--color-accent-soft);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.info-item__content {
    flex: 1;
}

.info-item__content strong {
    display: block;
    font-size: 0.9rem;
    color: var(--color-text);
    margin-bottom: 4px;
}

.info-item__content p {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin: 0;
    line-height: 1.4;
}

.test-tips__list {
    margin: 0;
    padding: 0;
    list-style: none;
}

.test-tips__item {
    padding: 8px 0;
    font-size: 0.85rem;
    color: var(--color-text);
    line-height: 1.4;
    border-bottom: 1px solid var(--color-border);
}

.test-tips__item:last-child {
    border-bottom: none;
}

/* –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã */
input[type="hidden"] {
    display: none;
}

/* ==================== */
/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
/* ==================== */

/* –ü–ª–∞–Ω—à–µ—Ç—ã (768px - 1024px) */
@media (max-width: 1024px) {
    .test__container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .test__sidebar {
        position: static;
        order: 3;
    }
    
    .test__question {
        order: 2;
    }
    
    .test__progress {
        order: 1;
    }
}

/* –ë–æ–ª—å—à–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ (576px - 768px) */
@media (max-width: 768px) {
    .test {
        padding: 20px 0;
    }
    
    .question__header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
    
    .question__text {
        font-size: 1.1rem;
    }
    
    .options-grid {
        grid-template-columns: 1fr;
    }
    
    .question__content,
    .question__form {
        padding: 20px;
    }
}

/* –°—Ä–µ–¥–Ω–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ (425px - 576px) */
@media (max-width: 576px) {
    .test-progress {
        padding: 20px;
    }
    
    .test-progress__header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .question__instruction {
        flex-direction: column;
        text-align: center;
        gap: 8px;
    }
    
    .option-card__content {
        padding: 12px 16px;
    }
    
    .question__submit {
        width: 100%;
    }
}

/* –ú–∞–ª–µ–Ω—å–∫–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ (–¥–æ 425px) */
@media (max-width: 425px) {
    .test__container {
        padding: 0 12px;
    }
    
    .test-progress__title {
        font-size: 1.3rem;
    }
    
    .question__text {
        font-size: 1rem;
    }
    
    .info-item {
        flex-direction: column;
        text-align: center;
        gap: 8px;
    }
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ */
@media (prefers-reduced-motion: reduce) {
    .option-card,
    .test-progress__fill {
        transition: none;
    }
}

/* –§–æ–∫—É—Å-—Å—Ç–∏–ª–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
.option-card__input:focus + .option-card__content {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
} */

/* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã—Å–æ–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
@media (prefers-contrast: high) {
    .option-card--selected {
        border-width: 3px;
    }
    
    .test-progress__fill {
        background: var(--color-accent-dark);
    }
}

#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\templates\assessment\finish.html
{% extends 'base.html' %}
{% load static %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è{% endblock title %}

{% block content %}

<section class="result">
  <div class="result__container container">

    <!-- HERO -->
    <div class="result__hero card">
        <h1 class="result__title">–í–∞—à —É—Ä–æ–≤–µ–Ω—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω!</h1>

        <div class="result__level-block">
            <div class="result__level">{{ session.estimated_level }}</div>
            <div class="result__level-label">–£—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è —è–∑—ã–∫–æ–º</div>
        </div>

        <p class="result__subtitle">
            –ù–∞—à –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.
        </p>

        <!-- CTA -->
        <div class="result__actions result__actions_top">
            <a href="/courses" class="btn btn_primary btn_lg">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</a>
            <a href="{% url 'users:profile' request.user.id %}" class="btn btn_outline btn_lg">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
            <a href="{% url 'assessment:start_test' %}" class="btn btn_ghost">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç —Å–Ω–æ–≤–∞</a>
        </div>
    </div>

    <!-- CARDS -->
    <div class="result__stats">
        <div class="result-card">
            <div class="result-card__value">{{ protocol.total_score|floatformat:2 }}
</div>
            <div class="result-card__label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</div>
        </div>

        <div class="result-card">
            <div class="result-card__value">{{ protocol.total_questions }}</div>
            <div class="result-card__label">–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤</div>
        </div>

        <div class="result-card">
            <div class="result-card__value">{{ protocol.ratio }}%</div>
            <div class="result-card__label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
        </div>

        <div class="result-card result-card_highlight">
            <div class="result-card__value">
                {{ protocol.estimated_level }}
            </div>
            <div class="result-card__label">–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</div>
        </div>
    </div>

    <!-- AI SUMMARY - –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–´–ô –ë–õ–û–ö -->
    <div class="result__ai card">
        <div class="result__ai-header">
            <div class="result__ai-title-wrapper">
                <h3 class="result__section-title">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—Ç –Ω–µ–π—Ä–æ-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞</h3>
                <div class="result__ai-confidence">
                    <span class="result__confidence-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞</span>
                    <div class="result__confidence-value">{{ protocol.llm_report.confidence }}%</div>
                </div>
            </div>
        </div>

        {% if protocol.llm_report %}
            <div class="result__ai-content">
                <!-- –í–≤–µ–¥–µ–Ω–∏–µ -->
                <div class="result__ai-section result__ai-intro">
                    <p class="result__ai-text">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º —É—Ä–æ–≤–Ω—è <strong class="result__highlight">{{ protocol.llm_report.estimated_level }}</strong>. 
                    –í–∞—à –æ–±—â–∏–π –±–∞–ª–ª: <strong>{{ protocol.llm_report.overall_score }}</strong>. –í—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ —Ö–æ—Ä–æ—à–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî –¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –µ–≥–æ –¥–∞–ª—å—à–µ!</p>
                </div>

                <!-- –ù–∞–≤—ã–∫–∏ -->
                <div class="result__ai-section">
                    <h4 class="result__subsection-title">–û—Ü–µ–Ω–∫–∞ –Ω–∞–≤—ã–∫–æ–≤</h4>
                    <div class="result__skills-grid">
                        <div class="skill-card">
                            <div class="skill-card__header">
                                <span class="skill-card__name">–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞</span>
                                <span class="skill-card__score">{{ protocol.llm_report.score_summary.grammar }}</span>
                            </div>
                            <div class="skill-card__progress">
                                <div class="skill-card__progress-bar" style="width: {{ protocol.llm_report.score_summary.grammar }}%"></div>
                            </div>
                        </div>
                        
                        <div class="skill-card">
                            <div class="skill-card__header">
                                <span class="skill-card__name">–°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å</span>
                                <span class="skill-card__score">{{ protocol.llm_report.score_summary.vocabulary }}</span>
                            </div>
                            <div class="skill-card__progress">
                                <div class="skill-card__progress-bar" style="width: {{ protocol.llm_report.score_summary.vocabulary }}%"></div>
                            </div>
                        </div>
                        
                        <div class="skill-card">
                            <div class="skill-card__header">
                                <span class="skill-card__name">–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ –Ω–∞ —Å–ª—É—Ö</span>
                                <span class="skill-card__score">{{ protocol.llm_report.score_summary.listening }}</span>
                            </div>
                            <div class="skill-card__progress">
                                <div class="skill-card__progress-bar" style="width: {{ protocol.llm_report.score_summary.listening }}%"></div>
                            </div>
                        </div>
                        
                        <div class="skill-card">
                            <div class="skill-card__header">
                                <span class="skill-card__name">–†–∞–∑–≥–æ–≤–æ—Ä–Ω–∞—è —Ä–µ—á—å</span>
                                <span class="skill-card__score">{{ protocol.llm_report.score_summary.speaking }}</span>
                            </div>
                            <div class="skill-card__progress">
                                <div class="skill-card__progress-bar" style="width: {{ protocol.llm_report.score_summary.speaking }}%"></div>
                            </div>
                        </div>
                        
                        <div class="skill-card">
                            <div class="skill-card__header">
                                <span class="skill-card__name">–ü–∏—Å—å–º–æ</span>
                                <span class="skill-card__score">{{ protocol.llm_report.score_summary.writing }}</span>
                            </div>
                            <div class="skill-card__progress">
                                <div class="skill-card__progress-bar" style="width: {{ protocol.llm_report.score_summary.writing }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ –æ–±–ª–∞—Å—Ç–∏ —Ä–æ—Å—Ç–∞ -->
                <div class="result__ai-columns">
                    <div class="result__ai-col">
                        <div class="result__ai-section">
                            <h4 class="result__subsection-title result__subsection-title--success">–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã</h4>
                            <ul class="result__list result__list--success">
                                {% for strength in protocol.llm_report.strengths %}
                                    <li class="result__list-item">{{ strength }}</li>
                                {% empty %}
                                    <li class="result__list-item">–ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω—è—Ç–∏—è, —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –≤–∞—à–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="result__ai-col">
                        <div class="result__ai-section">
                            <h4 class="result__subsection-title result__subsection-title--warning">–û–±–ª–∞—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è</h4>
                            <ul class="result__list result__list--warning">
                                {% for weakness in protocol.llm_report.weaknesses %}
                                    <li class="result__list-item">{{ weakness }}</li>
                                {% empty %}
                                    <li class="result__list-item">–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                <div class="result__ai-section">
                    <h4 class="result__subsection-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—É—á–µ–Ω–∏—é</h4>
                    <div class="result__recommendations">
                        {% for recommendation in protocol.llm_report.recommendations %}
                            <div class="recommendation-card">
                                <div class="recommendation-card__number">{% if forloop.counter < 10 %}0{% endif %}{{ forloop.counter }}</div>
                                <div class="recommendation-card__content">
                                    <p class="recommendation-card__text">{{ recommendation }}</p>
                                </div>
                            </div>
                        {% empty %}
                            <div class="recommendation-card">
                                <div class="recommendation-card__content">
                                    <p class="recommendation-card__text">–ò–∑—É—á–∏—Ç–µ –±–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- –£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω -->
                <div class="result__ai-section">
                    <h4 class="result__subsection-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ 7 –¥–Ω–µ–π</h4>
                    <div class="result__study-plan">
                        {% for day in protocol.llm_report.study_plan %}
                            <div class="study-day">
                                <div class="study-day__header">
                                    <span class="study-day__number">–î–µ–Ω—å {{ forloop.counter }}</span>
                                    <div class="study-day__status" aria-label="–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"></div>
                                </div>
                                <p class="study-day__task">{{ day }}</p>
                            </div>
                        {% empty %}
                            <div class="study-day">
                                <div class="study-day__header">
                                    <span class="study-day__number">–î–µ–Ω—å 1-7</span>
                                </div>
                                <p class="study-day__task">–ù–∞—á–Ω–∏—Ç–µ —Å –±–∞–∑–æ–≤—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- –ó–∞–º–µ—Ç–∫–∏ -->
                {% if protocol.llm_report %}
                <div class="result__ai-section">
                    <div class="result__notes">
                        <h4 class="result__subsection-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏</h4>
                        <p class="result__notes-text">{{ protocol.llm_report.notes }}</p>
                        
                        <details class="result__debug">
                            <summary class="result__debug-summary">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</summary>
                            <div class="debug-content">
                                <pre class="debug-json">{{ protocol.llm_report|pprint }}</pre>
                                
                                <div class="session-questions">
                                    <h5 class="session-questions__title">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤</h5>
                                    
                                    {% for question in session.questions.all %}
                                    <div class="question-card">
                                        <div class="question-card__header">
                                            <span class="question-card__number">–í–æ–ø—Ä–æ—Å {{ forloop.counter }}</span>
                                            <span class="question-card__type">{{ question.source_type }}</span>
                                        </div>
                                        
                                        <div class="question-card__content">
                                            <!-- –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ -->
                                            <div class="question-text">
                                                <h6 class="question-text__title">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</h6>
                                                <div class="question-text__content">
                                                    {% if question.question_json.text %}
                                                        {{ question.question_json.text }}
                                                    {% elif question.question_json.question_text %}
                                                        {{ question.question_json.question_text }}
                                                    {% else %}
                                                        <pre class="question-json">{{ question.question_json|pprint }}</pre>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                                            {{ question.question_json }}
                                            {% if question.question_json.options %}
                                            <div class="question-options">
                                                <h6 class="question-options__title">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:</h6>
                                                <ul class="options-list">
                                                    {% for option in question.question_json.options %}
                                                    <li class="options-list__item">{{ option }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- –û—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                                            <div class="question-answers">
                                                <h6 class="question-answers__title">–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h6>
                                                {% if question.answer %}
                                                <div class="answer-item">
                                                    <div class="answer-item__header">
                                                        {% if question.answer.score is not None %}
                                                        <span class="answer-item__score {% if question.answer.score >= 0.8 %}score-high{% elif question.answer.score >= 0.5 %}score-medium{% else %}score-low{% endif %}">
                                                            –û—Ü–µ–Ω–∫–∞: {{ question.answer.score|floatformat:2 }}
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="answer-item__content">
                                                        {% if question.answer.answer_text %}
                                                        <div class="answer-text">
                                                            <strong>–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:</strong> {{ question.answer.answer_text }}
                                                        </div>
                                                        {% endif %}
                                                        
                                                        {% if question.answer.recognized_text %}
                                                        <div class="answer-recognized">
                                                            <strong>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong> {{ question.answer.recognized_text }}
                                                        </div>
                                                        {% endif %}
                                                        
                                                        {% if question.answer.ai_feedback %}
                                                        <div class="answer-feedback">
                                                            <strong>AI Feedback:</strong>
                                                            <pre class="feedback-json">{{ question.answer.ai_feedback|pprint }}</pre>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="answer-item__meta">
                                                        <span class="answer-time">{{ question.answer.answered_at|date:"H:i:s" }}</span>
                                                    </div>
                                                </div>
                                                {% else %}
                                                <div class="no-answers">
                                                    <span class="no-answers__text">–ù–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                {% endif %}

                <!-- CTA -->
                <div class="result__ai-actions">
                    <a href="/courses" class="btn btn_primary btn_lg">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º—É –ø–ª–∞–Ω—É</a>
                </div>
            </div>

        {% else %}
            <div class="result__ai-empty">
                <div class="result__ai-empty-icon"></div>
                <h4 class="result__subsection-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
                <p class="result__ai-empty-text">–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –æ—Ç –Ω–µ–π—Ä–æ-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞</p>
                <a href="{% url 'assessment:start_test' %}" class="btn btn_outline">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
            </div>
        {% endif %}
    </div>

    <!-- AI SUMMARY -->
    <div class="result__ai card">
        <div class="result-ai">
            <!-- Header -->
            <div class="result-ai__header">
                <h3 class="result-ai__title">AI-–∞–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
                <p class="result-ai__subtitle">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ç–µ—Å—Ç</p>
            </div>

            {% if protocol.llm_report %}
            <!-- Intro: Score + Level + Confidence -->
            <div class="result-ai__intro">
                <div class="result-ai__score">
                    <span class="result-ai__score-value">{{ protocol.llm_report.overall_score }}%</span>
                    <span class="result-ai__score-label">–û–±—â–∏–π –±–∞–ª–ª</span>
                </div>
                
                <div class="result-ai__level">
                    <span class="result-ai__level-badge">{{ protocol.llm_report.estimated_level }}</span>
                </div>
                
                <div class="result-ai__confidence">
                    <div class="result-ai__confidence-label">
                        <span>–¢–æ—á–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞</span>
                        <span class="result-ai__confidence-value">{{ protocol.llm_report.confidence }}%</span>
                    </div>
                    <div class="result-ai__confidence-bar">
                        <div class="result-ai__confidence-fill" style="width: {{ protocol.llm_report.confidence }}%"></div>
                    </div>
                </div>
            </div>

            <!-- Skills Radar (grid) -->
            <div class="result-ai__skills">
                <h4 class="result-ai__section-title">–û—Ü–µ–Ω–∫–∞ –ø–æ –Ω–∞–≤—ã–∫–∞–º</h4>
                <div class="result-ai__skills-grid">
                    {% for skill_name, score in protocol.llm_report.score_summary.items %}
                    <div class="result-ai__skill">
                        <div class="result-ai__skill-header">
                            <span class="result-ai__skill-name">{{ skill_name|title }}</span>
                            <span class="result-ai__skill-score">{{ score }}%</span>
                        </div>
                        <div class="result-ai__skill-bar">
                            <div class="result-ai__skill-fill" style="width: {{ score }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Strengths -->
            <div class="result-ai__section result-ai__section--strengths">
                <h4 class="result-ai__section-title">
                    <span class="result-ai__section-icon result-ai__section-icon--success"></span>
                    –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
                </h4>
                <ul class="result-ai__list">
                    {% for strength in protocol.llm_report.strengths %}
                    <li class="result-ai__list-item result-ai__list-item--success">
                        {{ strength }}
                    </li>
                    {% empty %}
                    <li class="result-ai__list-item result-ai__list-item--empty">AI –æ—Ç–º–µ—Ç–∏—Ç —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Growth Areas -->
            <div class="result-ai__section result-ai__section--growth">
                <h4 class="result-ai__section-title">
                    <span class="result-ai__section-icon result-ai__section-icon--growth"></span>
                    –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —Ä–æ—Å—Ç–∞
                </h4>
                <ul class="result-ai__list">
                    {% for weakness in protocol.llm_report.weaknesses %}
                    <li class="result-ai__list-item result-ai__list-item--growth">
                        {{ weakness }}
                    </li>
                    {% empty %}
                    <li class="result-ai__list-item result-ai__list-item--empty">–í—Å–µ –Ω–∞–≤—ã–∫–∏ –Ω–∞ –¥–æ—Å—Ç–æ–π–Ω–æ–º —É—Ä–æ–≤–Ω–µ</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Recommendations -->
            <div class="result-ai__section">
                <h4 class="result-ai__section-title">
                    <span class="result-ai__section-icon result-ai__section-icon--rec"></span>
                    –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                </h4>
                <ul class="result-ai__list result-ai__list--recommendations">
                    {% for rec in protocol.llm_report.recommendations %}
                    <li class="result-ai__list-item result-ai__list-item--rec">
                        {{ rec }}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- 7-Day Study Plan -->
            <div class="result-ai__section">
                <h4 class="result-ai__section-title">
                    <span class="result-ai__section-icon result-ai__section-icon--plan"></span>
                    7-–¥–Ω–µ–≤–Ω—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è
                </h4>
                <ol class="result-ai__plan">
                    {% for day in protocol.llm_report.study_plan %}
                    <li class="result-ai__plan-item">
                        <div class="result-ai__plan-day">{{ forloop.counter }}</div>
                        <div class="result-ai__plan-content">
                            <p class="result-ai__plan-text">{{ day }}</p>
                            <div class="result-ai__plan-progress">
                                <div class="result-ai__plan-progress-bar">
                                    <div class="result-ai__plan-progress-fill" style="width: 0%"></div>
                                </div>
                                <span class="result-ai__plan-progress-label">0%</span>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ol>
            </div>

            <!-- CTA Button -->
            <div class="result-ai__cta">
                <a href="/courses" class="btn btn_primary result-ai__btn">
                    <span class="result-ai__btn-main">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</span>
                    <span class="result-ai__btn-sub">–ü—Ä–æ—Ö–æ–¥–∏—Ç–µ —É—Ä–æ–∫–∏ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                </a>
            </div>

            {% else %}
            <!-- Fallback state -->
            <div class="result-ai__empty">
                <p class="result-ai__empty-text">AI-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –≥–æ—Ç–æ–≤–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç...</p>
                <div class="result-ai__empty-loader"></div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- PROGRESSION -->
    <div class="result__progress card">
        <h3 class="result__section-title">–ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞–∑–≤–∏—Ç–∏—è</h3>
        <p class="result__progress-text">
            –ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å –æ–±—É—á–µ–Ω–∏—è.
        </p>

        <div class="result__progress-bar">
            <div class="result__progress-filled" style="width: {{ protocol.ratio }}%"></div>
        </div>
    </div>

    <!-- CTA #2 -->
    <div class="result__actions result__actions_bottom">
        <a href="/courses" class="btn btn_primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—É—á–µ–Ω–∏—é</a>
        <a href="{% url 'assessment:start_test' %}" class="btn btn_outline">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç —Å–Ω–æ–≤–∞</a>
    </div>

  </div>
</section>

{% endblock content %}

#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\templates\assessment\question.html
{% extends 'base.html' %}
{% load static %}

{% block title %}–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ | EngageAI{% endblock title %}

{% block css %}
<link href="{% static 'css/index.css' %}" rel="stylesheet">
<link href="{% static 'css/assessment.css' %}" rel="stylesheet">
<link href="{% static 'css/users/user.css' %}" rel="stylesheet">
<link href="{% static 'css/users/auth.css' %}" rel="stylesheet">
{% endblock css %}


{% block content %}
<section class="test">
    <div class="test__container container">
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="test__progress">
            <div class="test-progress">
                <div class="test-progress__header">
                    <h2 class="test-progress__title">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è CEFR</h2>
                    <div class="test-progress__stats">
                        <span class="test-progress__current">–í–æ–ø—Ä–æ—Å {{ question_number|default:1 }}</span>
                        <span class="test-progress__total">–∏–∑ {{ total_questions|default:20 }}</span>
                    </div>
                </div>
                
                <div class="test-progress__bar">
                    <div class="test-progress__fill" 
                         style="width: {% widthratio question_number|default:1 total_questions|default:20 100 %}%">
                    </div>
                </div>
                
                <div class="test-progress__hint">
                    üéØ –¢–µ—Å—Ç –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ -->
        <div class="test__question card">
            <div class="question">
                <div class="question__header">
                    <div class="question__type">
                        {% if question.options %}
                            <span class="question-type-badge">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç</span>
                        {% else %}
                            <span class="question-type-badge">–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç</span>
                        {% endif %}
                    </div>
                    <div class="question__timer" id="question-timer">
                        <span class="timer__icon">‚è±Ô∏è</span>
                        <span class="timer__text">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 2 –º–∏–Ω—É—Ç—ã</span>
                    </div>
                </div>

                <div class="question__content">
                    {% if text_content %}
                      <div class="reading-passage">
                        <div class="reading-passage__header">
                          <h4 class="reading-passage__title">–¢–µ–∫—Å—Ç:</h4>
                        </div>
                        <div class="reading-passage__content">
                          {{ text_content|linebreaks }}
                        </div>
                      </div>
                      
                      <div class="reading-question">
                        <div class="reading-question__header">
                          <h4 class="reading-question__title">–í–æ–ø—Ä–æ—Å:</h4>
                        </div>
                        <h3 class="question__text">{{ question_content }}</h3>
                      </div>
                    {% else %}
                      <h3 class="question__text">{{ question.question_text }}</h3>
                    {% endif %}
                    
                    {% if question.instruction %}
                    <div class="question__instruction">
                        <div class="instruction__icon">üí°</div>
                        <div class="instruction__text">{{ question.instruction }}</div>
                    </div>
                    {% endif %}
                    {{ question }}
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
                <div class="question__form">
                    {% if question.options %}
                        <!-- –í–æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ -->
                        <form method="post" action="{% url 'assessment:question_view' session.id %}" class="options-form">
                            {% csrf_token %}
                            {{ form.session_id }}
                            {{ form.question_instance_id }}
                            
                            <div class="options-grid">
                                {% for opt in question.options %}
                                    <label class="option-card">
                                        <input type="radio" name="answer_text" value="{{ opt }}" required class="option-card__input">
                                        <div class="option-card__content">
                                            <div class="option-card__text">{{ opt }}</div>
                                            <div class="option-card__check"></div>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                            
                            <div class="question__actions">
                                <button type="submit" class="btn btn_primary btn_lg question__submit">
                                    <span class="btn__icon">üöÄ</span>
                                    –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å -->
                        <form method="post" action="{% url 'assessment:question_view' session.id %}" class="text-form">
                            {% csrf_token %}
                            {{ form.session_id }}
                            {{ form.question_instance_id }}
                            
                            <div class="text-answer">
                                <div class="form-field">
                                    <label for="{{ form.answer_text.id_for_label }}" class="form-field__label">
                                        –í–∞—à –æ—Ç–≤–µ—Ç
                                    </label>
                                    <div class="input-wrapper">
                                        {{ form.answer_text }}
                                    </div>
                                    {% if form.answer_text.errors %}
                                    <div class="form-field__errors">
                                        {{ form.answer_text.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="question__actions">
                                <button type="submit" class="btn btn_primary btn_lg question__submit">
                                    <span class="btn__icon">üìù</span>
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                                </button>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="test__sidebar">
            <div class="test-info card">
                <h4 class="test-info__title">–û —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h4>
                <div class="test-info__content">
                    <div class="info-item">
                        <div class="info-item__icon">üéØ</div>
                        <div class="info-item__content">
                            <strong>–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç</strong>
                            <p>–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤ –º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤</p>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-item__icon">üìä</div>
                        <div class="info-item__content">
                            <strong>4 –Ω–∞–≤—ã–∫–∞</strong>
                            <p>–¢–µ—Å—Ç–∏—Ä—É–µ–º –≥—Ä–∞–º–º–∞—Ç–∏–∫—É, —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å, –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–∏—Å—å–º–æ</p>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-item__icon">‚è±Ô∏è</div>
                        <div class="info-item__content">
                            <strong>15-20 –º–∏–Ω—É—Ç</strong>
                            <p>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ–≥–æ —Ç–µ—Å—Ç–∞</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="test-tips card">
                <h4 class="test-tips__title">–°–æ–≤–µ—Ç—ã</h4>
                <ul class="test-tips__list">
                    <li class="test-tips__item">‚úÖ –û—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ, –Ω–µ —É–≥–∞–¥—ã–≤–∞–π—Ç–µ</li>
                    <li class="test-tips__item">‚úÖ –ù–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ—Å—å –¥–æ–ª–≥–æ –Ω–∞ –æ–¥–Ω–æ–º –≤–æ–ø—Ä–æ—Å–µ</li>
                    <li class="test-tips__item">‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è</li>
                    <li class="test-tips__item">‚úÖ –†–∞—Å—Å–ª–∞–±—å—Ç–µ—Å—å - —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç üòä</li>
                </ul>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –¢–∞–π–º–µ—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    let timeSpent = 0;
    const timerElement = document.getElementById('question-timer');
    
    if (timerElement) {
        setInterval(function() {
            timeSpent++;
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            // timerElement.querySelector('.timer__text').textContent = 
            //     `–í—Ä–µ–º—è: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
    const optionCards = document.querySelectorAll('.option-card');
    optionCards.forEach(card => {
        card.addEventListener('click', function() {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            optionCards.forEach(c => c.classList.remove('option-card--selected'));
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            this.classList.add('option-card--selected');
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫—É
            this.querySelector('.option-card__input').checked = true;
        });
    });
    
    // –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    const textAnswer = document.querySelector('.text-answer textarea');
    if (textAnswer) {
        textAnswer.focus();
    }
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const forms = document.querySelectorAll('.options-form, .text-form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('.question__submit');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="btn__icon">‚è≥</span>–û—Ç–ø—Ä–∞–≤–∫–∞...';
            }
        });
    });
});
</script>
{% endblock script %}

#######

E:\ML\ML_projects\Practic\engageAI_v2\engageai_core\assessment\templates\assessment\start.html
{% extends 'base.html' %}
{% load static %}

{% block title %}–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è CEFR | NeuroTutor{% endblock title %}

{% block content %}
<section class="test-start">
    <div class="test-start__container container">
        
        <!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è -->
        <div class="test-start__hero card">
            <div class="test-hero">
                <div class="test-hero__icon">
                    <div class="test-icon">
                        <div class="test-icon__main">üéØ</div>
                        <div class="test-icon__ring"></div>
                    </div>
                </div>
                
                <div class="test-hero__content">
                    <h1 class="test-hero__title">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è CEFR</h1>
                    <p class="test-hero__subtitle">
                        –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –ø–æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —à–∫–∞–ª–µ 
                        –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –æ–±—É—á–µ–Ω–∏—è
                    </p>
                    
                    <div class="test-hero__features">
                        <div class="test-feature">
                            <div class="test-feature__icon">üìä</div>
                            <div class="test-feature__text">–¢–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ 4 –Ω–∞–≤—ã–∫–æ–≤</div>
                        </div>
                        <div class="test-feature">
                            <div class="test-feature__icon">‚ö°</div>
                            <div class="test-feature__text">15-20 –º–∏–Ω—É—Ç</div>
                        </div>
                        <div class="test-feature">
                            <div class="test-feature__icon">ü§ñ</div>
                            <div class="test-feature__text">AI-–∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="test-start__content">
            <div class="test-start__main">
                <!-- –§–æ—Ä–º–∞ –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞ -->
                <div class="test-form card">
                    <div class="test-form__header">
                        <h2 class="test-form__title">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                        <p class="test-form__subtitle">
                            –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
                        </p>
                    </div>

                    <form method="post" class="test-form__form">
                        {% csrf_token %}
                        
                        <div class="form-fields">
                            {% for field in form %}
                            <div class="form-field">
                                <label for="{{ field.id_for_label }}" class="form-field__label">
                                    {{ field.label }}
                                    {% if field.field.required %}
                                        <span class="form-field__required">*</span>
                                    {% endif %}
                                </label>
                                
                                <div class="input-wrapper">
                                    {% if field.name == 'email' %}
                                        <div class="input-icon">üìß</div>
                                    {% elif field.name == 'first_name' %}
                                        <div class="input-icon">üë§</div>
                                    {% elif field.name == 'last_name' %}
                                        <div class="input-icon">üë•</div>
                                    {% endif %}
                                    
                                    {{ field }}
                                </div>
                                
                                {% if field.help_text %}
                                <div class="form-field__hint">
                                    {{ field.help_text }}
                                </div>
                                {% endif %}
                                
                                {% if field.errors %}
                                <div class="form-field__errors">
                                    {{ field.errors }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <div class="test-form__actions">
                            <button type="submit" class="btn btn_primary btn_lg test-start__btn">
                                <span class="btn__icon">üöÄ</span>
                                –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="test-start__sidebar">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ -->
                <div class="test-info card">
                    <h3 class="test-info__title">–û —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h3>
                    
                    <div class="test-info__content">
                        <div class="info-section">
                            <h4 class="info-section__title">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h4>
                            <ul class="info-section__list">
                                <li class="info-section__item">‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</li>
                                <li class="info-section__item">‚úÖ 4 —è–∑—ã–∫–æ–≤—ã—Ö –Ω–∞–≤—ã–∫–∞</li>
                                <li class="info-section__item">‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</li>
                                <li class="info-section__item">‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</li>
                            </ul>
                        </div>
                        
                        <div class="info-section">
                            <h4 class="info-section__title">–£—Ä–æ–≤–Ω–∏ CEFR</h4>
                            <div class="cefr-levels">
                                <div class="cefr-level">
                                    <span class="cefr-level__name">A1-A2</span>
                                    <span class="cefr-level__desc">–ù–∞—á–∞–ª—å–Ω—ã–π</span>
                                </div>
                                <div class="cefr-level">
                                    <span class="cefr-level__name">B1-B2</span>
                                    <span class="cefr-level__desc">–°—Ä–µ–¥–Ω–∏–π</span>
                                </div>
                                <div class="cefr-level">
                                    <span class="cefr-level__name">C1-C2</span>
                                    <span class="cefr-level__desc">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—é -->
                <div class="test-tips card">
                    <h3 class="test-tips__title">–°–æ–≤–µ—Ç—ã –¥–ª—è —É—Å–ø–µ—Ö–∞</h3>
                    
                    <div class="test-tips__list">
                        <div class="test-tip">
                            <div class="test-tip__icon">üí°</div>
                            <div class="test-tip__content">
                                <strong>–û—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ</strong>
                                <p>–ù–µ —É–≥–∞–¥—ã–≤–∞–π—Ç–µ - —ç—Ç–æ –∏—Å–∫–∞–∑–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
                            </div>
                        </div>
                        
                        <div class="test-tip">
                            <div class="test-tip__icon">‚è±Ô∏è</div>
                            <div class="test-tip__content">
                                <strong>–ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å</strong>
                                <p>–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã</p>
                            </div>
                        </div>
                        
                        <div class="test-tip">
                            <div class="test-tip__icon">üéØ</div>
                            <div class="test-tip__content">
                                <strong>–†–∞—Å—Å–ª–∞–±—å—Ç–µ—Å—å</strong>
                                <p>–≠—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç, –∞ –Ω–µ —ç–∫–∑–∞–º–µ–Ω</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="test-stats card">
                    <h3 class="test-stats__title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    
                    <div class="test-stats__content">
                        <div class="stat-item">
                            <div class="stat-item__value">2,847+</div>
                            <div class="stat-item__label">—É—á–µ–Ω–∏–∫–æ–≤ –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-item__value">94%</div>
                            <div class="stat-item__label">–ø–æ–ª—É—á–∏–ª–∏ —Ç–æ—á–Ω—É—é –æ—Ü–µ–Ω–∫—É</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏ —Ç–µ—Å—Ç–∞
    const testIcon = document.querySelector('.test-icon');
    if (testIcon) {
        const ring = testIcon.querySelector('.test-icon__ring');
        let rotation = 0;
        
        function animateRing() {
            rotation += 0.2;
            ring.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            requestAnimationFrame(animateRing);
        }
        
        animateRing();
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–∫—É—Å-—Å—Ç–∏–ª–∏ –∫ –ø–æ–ª—è–º –≤–≤–æ–¥–∞
    const inputs = document.querySelectorAll('.input-wrapper input, .input-wrapper textarea, .input-wrapper select');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('input-wrapper--focused');
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('input-wrapper--focused');
        });
    });
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    const form = document.querySelector('.test-form__form');
    const submitBtn = document.querySelector('.test-start__btn');
    
    if (form && submitBtn) {
        form.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="btn__icon">‚è≥</span>–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞...';
        });
    }
    
    // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, observerOptions);

    document.querySelectorAll('.card').forEach(card => {
        observer.observe(card);
    });
});
</script>

<style>
/* –°–¢–ò–õ–ò –°–¢–†–ê–ù–ò–¶–´ –ù–ê–ß–ê–õ–ê –¢–ï–°–¢–ê */
.test-start {
    padding: 40px 0;
    background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-surface-alt) 100%);
    min-height: 100vh;
}

.test-start__container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 30px;
}

/* –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è */
.test-start__hero {
    padding: 40px;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

.test-hero {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 40px;
    align-items: center;
    position: relative;
    z-index: 2;
}

.test-hero__icon {
    flex-shrink: 0;
}

.test-icon {
    position: relative;
    display: inline-block;
}

.test-icon__main {
    font-size: 4rem;
    position: relative;
    z-index: 2;
}

.test-icon__ring {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: rgba(255,255,255,0.8);
}

.test-hero__title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 16px;
    line-height: 1.2;
}

.test-hero__subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
    line-height: 1.6;
    margin-bottom: 24px;
}

.test-hero__features {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.test-feature {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
.test-start__content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    align-items: start;
}

/* –§–æ—Ä–º–∞ —Ç–µ—Å—Ç–∞ */
.test-form {
    padding: 40px;
}

.test-form__header {
    text-align: center;
    margin-bottom: 32px;
}

.test-form__title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: 8px;
}

.test-form__subtitle {
    font-size: 1.1rem;
    color: var(--color-text-muted);
    line-height: 1.5;
    margin: 0;
}

.form-fields {
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-bottom: 32px;
}

.test-form__actions {
    text-align: center;
}

/* –°–∞–π–¥–±–∞—Ä */
.test-start__sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: sticky;
    top: 100px;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ */
.test-info__content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.info-section__title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 12px;
}

.info-section__list {
    margin: 0;
    padding: 0;
    list-style: none;
}

.info-section__item {
    padding: 6px 0;
    font-size: 0.9rem;
    color: var(--color-text);
}

.cefr-levels {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.cefr-level {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-accent);
}

.cefr-level__name {
    font-weight: 600;
    color: var(--color-text);
}

.cefr-level__desc {
    font-size: 0.8rem;
    color: var(--color-text-muted);
}

/* –°–æ–≤–µ—Ç—ã */
.test-tips__list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.test-tip {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.test-tip__icon {
    font-size: 1.2rem;
    flex-shrink: 0;
    margin-top: 2px;
}

.test-tip__content strong {
    display: block;
    font-size: 0.9rem;
    color: var(--color-text);
    margin-bottom: 4px;
}

.test-tip__content p {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin: 0;
    line-height: 1.4;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.test-stats__content {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.stat-item {
    text-align: center;
    padding: 16px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-md);
}

.stat-item__value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-accent);
    margin-bottom: 4px;
}

.stat-item__label {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.3;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
.card {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s ease;
}

.card.animate-in {
    opacity: 1;
    transform: translateY(0);
}

/* ==================== */
/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
/* ==================== */

@media (max-width: 1024px) {
    .test-start__content {
        grid-template-columns: 1fr;
        gap: 24px;
    }
    
    .test-start__sidebar {
        position: static;
    }
}

@media (max-width: 768px) {
    .test-hero {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 24px;
    }
    
    .test-hero__features {
        justify-content: center;
    }
    
    .test-form {
        padding: 30px 20px;
    }
    
    .test-start__hero {
        padding: 30px 20px;
    }
}

@media (max-width: 576px) {
    .test-hero__title {
        font-size: 2rem;
    }
    
    .test-form__title {
        font-size: 1.6rem;
    }
    
    .test-hero__features {
        flex-direction: column;
        align-items: center;
    }
}

@media (prefers-reduced-motion: reduce) {
    .test-icon__ring,
    .card {
        transition: none;
        animation: none;
    }
}
</style>
{% endblock script %}

#######

