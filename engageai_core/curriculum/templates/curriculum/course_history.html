{% extends "base.html" %}
{% load static %}

{% block title %}История курса: {{ course.title }}{% endblock %}

{% block content %}
<section class="course-history">
    <div class="course-history__layout">

        <!-- Main -->
        <main class="course-history__main">
            <article class="course-history-card">
                <header class="course-history-card__header">
                    <h1 class="course-history-card__title">
                        История курса: {{ course.title }}
                    </h1>
                    <span class="course-history-card__progress">
                        {{ overall_progress }}%
                    </span>
                </header>

                <div class="course-history-card__body">
                    <p class="course-history-card__description">
                        {{ course.description }}
                    </p>

                    {% if completed_lessons %}
                        <ul class="lesson-history-list">
                            {% for item in completed_lessons %}
                                <li class="lesson-history-item">
                                    <a href="{% url 'curriculum:lesson_history' enrollment.id item.lesson.id %}"
                                       class="lesson-history-item__link">

                                        <div class="lesson-history-item__header">
                                            <h3 class="lesson-history-item__title">
                                                {{ item.lesson.order }}. {{ item.lesson.title }}
                                            </h3>
                                            <time class="lesson-history-item__date">
                                                {{ item.last_response_date|date:"d.m.Y" }}
                                            </time>
                                        </div>

                                        <p class="lesson-history-item__description">
                                            {{ item.lesson.description|truncatechars:100 }}
                                        </p>

                                        <div class="lesson-history-item__progress">
                                            <div class="progress">
                                                <div class="progress__bar"
                                                     style="width: {{ item.completion_percent }}%">
                                                    {{ item.completion_percent }}%
                                                </div>
                                            </div>
                                        </div>

                                        <div class="lesson-history-item__meta">
                                            Завершено {{ item.completed_tasks }} из {{ item.total_tasks }} заданий
                                        </div>

                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="course-history__empty">
                            Вы еще не завершили ни одного урока в этом курсе.
                        </div>
                    {% endif %}
                </div>
            </article>
        </main>

        <!-- Sidebar -->
        <aside class="course-history__sidebar">
            <section class="course-summary">
                <h2 class="course-summary__title">Общий прогресс</h2>

                <div class="course-summary__progress">
                    <div class="progress">
                        <div class="progress__bar"
                             style="width: {{ overall_progress }}%">
                            {{ overall_progress }}%
                        </div>
                    </div>
                    <div class="course-summary__caption">
                        Завершено {{ completed_lessons|length }}
                        из {{ course.lessons.filter.is_active.count }} уроков
                    </div>
                </div>

                <ul class="course-summary__stats">
                    <li>
                        <strong>Уровень:</strong>
                        {{ enrollment.student.english_level|default:"A1" }}
                    </li>
                    <li>
                        <strong>Всего заданий:</strong>
                        {{ course.lessons.aggregate(total=Sum('tasks_count'))|default:0 }}
                    </li>
                    <li>
                        <strong>Длительность:</strong>
                        ~{{ course.estimated_duration }} мин
                    </li>
                </ul>

                <div class="course-summary__actions">
                    <a href="{% url 'curriculum:learning_session' enrollment.id %}"
                       class="btn btn_primary">
                        Продолжить обучение
                    </a>
                    <a href="{% url 'curriculum:course_list' %}"
                       class="btn btn_outline">
                        Все курсы
                    </a>
                </div>
            </section>
        </aside>

    </div>
</section>
{% endblock %}
