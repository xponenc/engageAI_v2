{% extends 'base.html' %}
{% load static %}

{% block css %}
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
<link rel="stylesheet" href="{% static 'css/lesson-event-log.css' %}">
{% endblock %}

{% block title %}
Логи событий уроков
{% endblock %}

{% block content %}
<div class="container container_wide lesson-event-list">

    <!-- HEADER -->
    <header class="lesson-event-list__header">
        <h2 class="lesson-event-list__title">Логи событий уроков</h2>
        <div class="lesson-event-list__subtitle">
            История взаимодействия студентов с уроками
        </div>
    </header>

    <div class="lesson-event-log__grid">
        <div class="lesson-event-log__main">
            
            <!-- STATS -->
            <section class="lesson-event-stats">
                <div>
                    <span>Всего событий</span>
                    <strong>{{ total_events }}</strong>
                </div>
                <div>
                    <span>Общая длительность</span>
                    <strong>{{ total_duration|floatformat:0 }} мин</strong>
                </div>
                <div>
                    <span>Средняя длительность</span>
                    <strong>{{ avg_duration }} мин</strong>
                </div>
                <div>
                    <span>Completion rate</span>
                    <strong>{{ completion_rate }}%</strong>
                </div>
            </section>

            <!-- TABLE -->
            <section class="lesson-event-table-wrap">
                <table class="lesson-event-table">
                    <thead>
                        <tr>
                            <th class="lesson-event-table__th">
                                <span>Студент</span>
                                <span>Время</span>
                            </th>
                            <th class="lesson-event-table__th">
                                <span>Урок / Курс</span>
                                <span>Тип события</span>
                            </th>
                            <th class="lesson-event-table__th">
                                <span>Канал</span>
                                <span>Длительность</span>
                            </th>
                            <th class="lesson-event-table__th">
                                <span>Метаданные</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="events-table-body">
                        {% include 'curriculum/include/_event_table_rows.html' %}
                    </tbody>
                </table>
            </section>

            <!-- PAGINATION -->
            <footer class="lesson-event-pagination">
                {% if page_obj.has_previous %}
                    <a class="lesson-event-pagination__btn"
                    href="?page=1{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                        «
                    </a>

                    <a class="lesson-event-pagination__btn"
                    href="?page={{ page_obj.previous_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                        ‹
                    </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
                        {% if num == page_obj.number %}
                            <span class="lesson-event-pagination__page lesson-event-pagination__page--active">
                                {{ num }}
                            </span>
                        {% else %}
                            <a class="lesson-event-pagination__page"
                            href="?page={{ num }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a class="lesson-event-pagination__btn"
                    href="?page={{ page_obj.next_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                        ›
                    </a>

                    <a class="lesson-event-pagination__btn"
                    href="?page={{ page_obj.paginator.num_pages }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">
                        »
                    </a>
                {% endif %}
            </footer>

        </div>
        
        <div class="lesson-event-log__aside">
            <!-- FILTERS -->
            <form method="get" class="lesson-event-filters">
                <div class="lesson-event-field">
                    <label class="lesson-event-field__label">
                        <span>Тип события</span>
                        <select class="lesson-event-field__input" name="event_type">
                            <option value="ALL">Все</option>
                            {% for value, label in event_types %}
                                <option value="{{ value }}"
                                    {% if current_filters.event_type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <div class="lesson-event-field">
                    <label class="lesson-event-field__label">
                        <span>Канал</span>
                        <select class="lesson-event-field__input" name="channel">
                            <option value="ALL">Все</option>
                            {% for value, label in channels %}
                                <option value="{{ value }}"
                                    {% if current_filters.channel == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                <div class="lesson-event-field">
                    <label class="lesson-event-field__label">
                        <span>Студент (ID)</span>
                        <input class="lesson-event-field__input" type="number" name="student_id"
                               placeholder="ID студента"
                               value="{{ current_filters.student_id }}">
                    </label>
                </div>

                <div class="lesson-event-field">
                    <label class="lesson-event-field__label">
                        <span>Период</span>
                        <select class="lesson-event-field__input" name="period">
                            <option value="all" {% if current_filters.period == 'all' %}selected{% endif %}>Все</option>
                            <option value="day" {% if current_filters.period == 'day' %}selected{% endif %}>День</option>
                            <option value="week" {% if current_filters.period == 'week' %}selected{% endif %}>Неделя</option>
                            <option value="month" {% if current_filters.period == 'month' %}selected{% endif %}>Месяц</option>
                        </select>
                    </label>
                </div>

                <div class="lesson-event-field lesson-event-field--wide">
                    <label class="lesson-event-field__label">
                        <span>Поиск</span>
                        <input class="lesson-event-field__input" type="text" name="search"
                               placeholder="Студент, урок, метаданные"
                               value="{{ current_filters.search }}">
                    </label>
                </div>

                <div class="lesson-event-field lesson-event-field--action">
                    <button class="btn btn_reset btn_primary" type="submit">Применить</button>
                </div>
            </form>
        </div>
    </div>

</div>

{% endblock %}

{% block script %}
<script>
// Бесконечная прокрутка (опционально)
let loading = false;
window.addEventListener('scroll', function() {
    if (loading) return;
    
    const pagination = document.querySelector('.lesson-event-pagination');
    if (!pagination) return;
    
    const rect = pagination.getBoundingClientRect();
    if (rect.top < window.innerHeight + 200) {
        // Можно добавить подгрузку через AJAX
    }
});
</script>
{% endblock script %}