{% extends 'extended/assistant_layout.html' %}
{% load static %}
{% load form_extras %}


{% block title %}–û–±—É—á–µ–Ω–∏–µ ¬∑ {{ enrollment.course.title }}{% endblock %}


{% block assistant_css %}
<link href="{% static 'css/learning-session.css' %}" rel="stylesheet">
{% endblock %}


{% block assistant_content %}
<section class="learning-session">
    <div class="learning-session__container">

        <!-- Header -->
        <header class="learning-header">
            <h1 class="learning-header__title">
                {{ enrollment.course.title }}
            </h1>
            <h2 class="learning-header__subtitle">
                {{ learning_state.current_lesson.title }}
            </h2>
            <div class="learning-header__meta">
                –£—Ä–æ–∫ {{ learning_state.current_lesson.order }}
                –∏–∑ {{ progress_details.total_lessons }}
            </div>
            <article class="progress-card mb-3">
                <div class="progress-card__title">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                <div class="progress-bar">
                    <div class="progress-bar__value"
                            style="width: {{ progress_details.progress_percent|floatformat:0 }}%"></div>
                </div>
                <div class="progress-card__percent">
                    {{ progress_details.progress_percent|floatformat:0 }}%
                </div>
            </article>
        </header>


        <!-- Main -->
        <main class="learning-main">
            {% if lesson_blocked %}
                <section class="lesson-blocked">
                    <div class="lesson-blocked__icon">üå±</div>

                    <div class="lesson-blocked__content">
                        <h3 class="lesson-blocked__title">
                            <span>–£—Ä–æ–∫ –ø–æ–∫–∞ –∑–∞–∫—Ä—ã—Ç</span>
                            <span>–ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–¥–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É—Ä–æ–∫–∞. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ –≤—ã —Å—Ä–∞–∑—É —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ.</span>
                        </h3>

                        <p class="lesson-blocked__message">
                            {{ block_message }}
                        </p>

                        <p class="lesson-blocked__meta">
                            –û—Ü–µ–Ω–∫–∞ –Ω–∞—á–∞—Ç–∞:
                            {{ assessment_started_at|date:"d.m.Y H:i" }}
                        </p>

                        <a href="{% url 'curriculum:course_detail' enrollment.course.id %}"
                           class="lesson-blocked__action">
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å—É
                        </a>
                    </div>
                </section>
                <input type="hidden" id="enrollment-id" value="{{ enrollment.id }}">
                <input type="hidden" id="assessment-job-id" value="{{ enrollment.assessment_job_id }}">
            {% else %}

                {% if lesson_theory %}
                <section class="lesson-theory">
                    <h3 class="lesson-theory__title">–¢–µ–æ—Ä–∏—è —É—Ä–æ–∫–∞</h3>
                    <div class="lesson-theory__content">
                        {{ lesson_theory|safe }}
                    </div>
                </section>
                {% endif %}

                <section class="lesson-tasks">
                    <h3 class="lesson-tasks__title">
                        –ó–∞–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞
                        <span class="lesson-tasks__count">
                            {{ lesson_tasks|length }}
                        </span>
                    </h3>

                    <form class="lesson-tasks__form"
                            method="post"
                            action="{% url 'curriculum:learning_session' enrollment.id %}"
                            enctype="multipart/form-data">
                        {% csrf_token %}


                        {% if lesson_form.errors %}
                            <div class="alert alert-danger">
                                {{ lesson_form.non_field_errors }}
                            </div>
                        {% endif %}

                        {% comment %} {% for field in lesson_form %}
                            <div class="lesson-task">
                                <div class="lesson-task__prompt">
                                    {{ task.content.prompt|safe }}
                                </div>
                                <label>{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    <div class="error">{{ field.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        {% endfor %} {% endcomment %}

                        {% for task in lesson_tasks %}
                            {{ task.content }}
                            {% with field=lesson_form|field_for_task:task.id %}
                                <article class="lesson-task {% if task.id in completed_tasks %}lesson-task--completed{% endif %}">
                                    <header class="lesson-task__header">
                                        <h4 class="lesson-task__title">–ó–∞–¥–∞–Ω–∏–µ ‚Ññ {{ task.order }}</h4>
                                        {% if task.id in completed_tasks %}
                                            <span class="lesson-task__status">‚úì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                                        {% endif %}
                                    </header>

                                    <div class="lesson-task__prompt">
                                        {{ task.content.prompt|safe }}
                                    </div>

                                    <div class="lesson-task__response">
                                        {% if task.id in completed_tasks %}
                                            {# === –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ === #}
                                            {% if task.student_answer.response_text %}
                                                <div class="student-answer student-answer--text">
                                                    {{ task.student_answer.response_text|linebreaks }}
                                                </div>
                                            {% endif %}

                                            {% if task.student_answer.audio_file %}
                                                <div class="student-answer student-answer--audio">
                                                    <audio controls class="task__audio">
                                                        <source src="{{ task.student_answer.audio_file.url }}" type="audio/mpeg">
                                                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                                                    </audio>
                                                    <p><small>–ê—É–¥–∏–æ –æ—Ç–≤–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω</small></p>
                                                </div>
                                            {% endif %}

                                            {# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–∫–∞–∑–∞—Ç—å –æ—Ü–µ–Ω–∫—É #}
                                            {% if task.student_answer.assessment %}
                                                <div class="task-feedback">
                                                    {{ task.student_answer.assessment.structured_feedback.summary.text }}
                                                </div>
                                            {% endif %}

                                        {% else %}
                                            {% if task.response_format == 'audio' %}
                                                {# –í—Ä—É—á–Ω—É—é —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ input —Ñ–∞–π–ª–∞ #}
                                                <input type="file"
                                                    name="task_{{ task.id }}_audio"
                                                    accept="audio/*"
                                                    class="task-file"
                                                    data-task-audio-input="{{ task.id }}"
                                                    {% if field.field.required %}required{% endif %}>

                                                <div class="task-audio">
                                                    <button type="button"
                                                            class="task-audio__record-btn btn btn_outline"
                                                            data-task-record="{{ task.id }}">
                                                        –ó–∞–ø–∏—Å–∞—Ç—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                                                    </button>

                                                    <div class="task-audio__preview"
                                                        data-task-audio-preview="{{ task.id }}"
                                                        hidden>
                                                        <audio controls></audio>
                                                        <div class="task-audio__meta">–ê—É–¥–∏–æ –∑–∞–ø–∏—Å–∞–Ω–æ</div>
                                                    </div>
                                                </div>

                                                {% if field.errors %}
                                                    <div class="error">{{ field.errors|join:", " }}</div>
                                                {% endif %}

                                            {% else %}
                                                {# –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä #}
                                                {{ field }}
                                                {% if field.errors %}
                                                    <div class="error">{{ field.errors|join:", " }}</div>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </article>
                            {% endwith %}
                        {% endfor %}

                        {% comment %} {% for task in lesson_tasks %}
                        {{task.content}}
                        
                        <article class="lesson-task
                            {% if task.id in completed_tasks %}
                                lesson-task--completed
                            {% endif %}">
                            
                            <header class="lesson-task__header">
                                <h4 class="lesson-task__title">
                                    –ó–∞–¥–∞–Ω–∏–µ ‚Ññ {{ task.order }}
                                </h4>

                                {% if task.id in completed_tasks %}
                                <span class="lesson-task__status">
                                    ‚úì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                                </span>
                                {% endif %}
                            </header>

                            <div class="lesson-task__prompt">
                                {{ task.content.prompt|safe }}
                            </div>

                            <div class="lesson-task__response">
                                {% if task.response_format == 'single_choice' %}
                                    {% for option in task.content.options %}
                                    <label class="task-option">
                                        <input type="radio"
                                            name="task_{{ task.id }}"
                                            value="{{ option }}"
                                            {% if task.id in completed_tasks %}disabled{% endif %}>
                                            <span>{{ option }}</span>
                                    </label>
                                    {% endfor %}

                                {% elif task.response_format == 'multiple_choice' %}
                                    {% for option in task.content.options %}
                                    <label class="task-option">
                                        <input type="checkbox"
                                                name="task_{{ task.id }}"
                                                value="{{ option }}"
                                                {% if task.id in completed_tasks %}disabled{% endif %}>
                                        <span>{{ option }}</span>
                                    </label>
                                    {% endfor %}

                                {% if task.response_format == 'short_text' %}
                                    <input class="task-input"
                                            type="text"
                                            name="task_{{ task.id }}"
                                            maxlength="100"
                                            value=""
                                            {% if task.id in completed_tasks %}disabled{% endif %}>

                                {% elif task.response_format == 'free_text' %}
                                    <textarea class="task-textarea"
                                                name="task_{{ task.id }}"
                                                rows="3"
                                                {% if task.id in completed_tasks %}disabled{% endif %}></textarea>

                                {% elif task.response_format == 'audio' %}
                                    {% if task.id in completed_tasks %}
                                        <div class="task-audio__done">
                                            –ê—É–¥–∏–æ –æ—Ç–≤–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω
                                        </div>
                                    {% else %}
                                        <div class="task-audio">

                                            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                                            <input
                                                class="task-file"
                                                type="file"
                                                name="task_{{ task.id }}_audio"
                                                accept="audio/*"
                                                data-task-audio-input="{{ task.id }}"
                                            >

                                            <!-- –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ -->
                                            <button
                                                type="button"
                                                class="task-audio__record-btn"
                                                data-task-record="{{ task.id }}"
                                            >
                                                üé§ –ó–∞–ø–∏—Å–∞—Ç—å
                                            </button>

                                            <!-- –ü—Ä–µ–≤—å—é –∑–∞–ø–∏—Å–∏ -->
                                            <div
                                                class="task-audio__preview"
                                                data-task-audio-preview="{{ task.id }}"
                                                hidden
                                            >
                                                <audio controls></audio>
                                                <div class="task-audio__meta">
                                                    –ê—É–¥–∏–æ –∑–∞–ø–∏—Å–∞–Ω–æ
                                                </div>
                                            </div>

                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% if task.student_answer %}
                            <div>
                                {% if task.student_answer.response_text %}{{ task.student_answer.response_text }}{% endif %}
                                {% if task.student_answer.audio_file %}
                                    <audio controls class="task__audio">
                                        <source src="{{ task.student_answer.audio_file.url }}">
                                    </audio>
                                    <a href="{{ task.student_answer.audio_file.url }}">{{ task.student_answer.audio_file }}</a>
                                {% endif %}
                            </div>
                                {% if task.student_answer.assessment %}
                                    {{ task.student_answer.assessment.structured_feedback }}
                                {% endif %}
                            {% endif %}
                        </article>
                        {% endfor %} {% endcomment %}

                        <button class="lesson-tasks__submit btn btn_primary" type="submit">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
                        </button>
                    </form>
                </section>

            {% endif %}
        </main>
    </div>
</section>
{% endblock %}

{% block assistant_script %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ø–æ task_id
const audioRecorders = {};

document.addEventListener('DOMContentLoaded', () => {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏
    document.querySelectorAll('[data-task-record]').forEach(button => {
        const taskId = button.dataset.taskRecord;

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏
        const recordBtn = button;
        const previewDiv = document.querySelector(`[data-task-audio-preview="${taskId}"]`);
        const audioElement = previewDiv.querySelector('audio');
        const metaDiv = previewDiv.querySelector('.task-audio__meta');
        const fileInput = document.querySelector(`[data-task-audio-input="${taskId}"]`);

        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;
        let seconds = 0;

        const updateTimer = () => {
            seconds++;
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            recordBtn.textContent = `üé§ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å... ${mins}:${secs}`;
        };

        const startRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    audioElement.src = audioUrl;
                    previewDiv.hidden = false;

                    // –°–æ–∑–¥–∞—ë–º File –∏ –∫–ª–∞–¥—ë–º –≤ hidden input –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å —Ñ–æ—Ä–º–æ–π
                    const file = new File([audioBlob], `task_${taskId}_recording.webm`, { type: 'audio/webm' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    const duration = seconds;
                    const mins = String(Math.floor(duration / 60)).padStart(2, '0');
                    const secs = String(duration % 60).padStart(2, '0');
                    metaDiv.textContent = `–ê—É–¥–∏–æ –∑–∞–ø–∏—Å–∞–Ω–æ (${mins}:${secs})`;

                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–∫–∏ –ø–æ—Ç–æ–∫–∞
                    stream.getTracks().forEach(track => track.stop());

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    audioRecorders[taskId] = { recorded: true, blob: audioBlob, duration: seconds };
                };

                mediaRecorder.start();

                // UI: –º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É
                recordBtn.textContent = `üé§ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å... 00:00`;
                recordBtn.classList.add('recording');
                seconds = 0;
                timerInterval = setInterval(updateTimer, 1000);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º recorder
                audioRecorders[taskId] = { mediaRecorder, stream };

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
                recordBtn.textContent = 'üé§ –ó–∞–ø–∏—Å–∞—Ç—å';
            }
        };

        const stopRecording = () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            recordBtn.textContent = 'üé§ –ó–∞–ø–∏—Å–∞—Ç—å –∑–∞–Ω–æ–≤–æ';
            recordBtn.classList.remove('recording');
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
        recordBtn.addEventListener('click', () => {
            if (!audioRecorders[taskId]?.mediaRecorder || audioRecorders[taskId].mediaRecorder.state === 'inactive') {
                // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                startRecording();
            } else {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é
                stopRecording();
            }
        });

        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å (–∫–ª–∏–∫ –ø–æ –ø—Ä–µ–≤—å—é –∏–ª–∏ –∫–Ω–æ–ø–∫–µ "–∑–∞–Ω–æ–≤–æ")
        // –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "–ó–∞–ø–∏—Å–∞—Ç—å –∑–∞–Ω–æ–≤–æ"
    });
});
</script>


{% endblock %}


