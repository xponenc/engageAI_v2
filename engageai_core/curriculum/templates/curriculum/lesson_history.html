{% extends 'extended/assistant_layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}История урока · {{ course.title }}{% endblock %}

{% block assistant_css %}
<link href="{% static 'css/learning-session.css' %}" rel="stylesheet">
<link href="{% static 'css/lesson-history.css' %}" rel="stylesheet">
{% endblock %}

{% block assistant_content %}
<section class="lesson-history">

    <!-- ===== Заголовок урока ===== -->
    <header class="lesson-history__header">
        <h1 class="lesson-history__title">
            {{ lesson_history.lesson.title }}
        </h1>

        <div class="lesson-history__progress">
            <div class="lesson-history__progress-bar">
                <div
                    class="lesson-history__progress-fill"
                    style="width: {{ lesson_history.progress_percent }}%;"
                ></div>
            </div>
            <span class="lesson-history__progress-text">
                {{ lesson_history.progress_percent|floatformat:0 }}%
            </span>
        </div>

        {% if lesson_history.is_completed %}
            <div class="lesson-history__status lesson-history__status--completed">
                {% trans "Урок завершён" %}
            </div>
        {% else %}
            <div class="lesson-history__status lesson-history__status--in-progress">
                {% trans "Урок в процессе" %}
            </div>
        {% endif %}
    </header>

    <!-- ===== Задания ===== -->
    <section class="lesson-history__tasks">
        <h2 class="lesson-history__section-title">
            {% trans "Задания" %}
        </h2>

        <ul class="task-list">
            {{  lesson_history }}
            {% for item in lesson_history.tasks %}
                <li class="task-list__item
                    {% if item.is_completed %}
                        task-list__item--completed
                    {% else %}
                        task-list__item--pending
                    {% endif %}
                ">
                    <div class="task-list__header">
                        <span class="task-list__title">
                            {{ item.task.title }}
                        </span>

                        {% if item.is_completed %}
                            <span class="task-list__score">
                                {{ item.best_score|floatformat:2 }}
                            </span>
                        {% else %}
                            <span class="task-list__score task-list__score--empty">
                                —
                            </span>
                        {% endif %}
                    </div>

                    <div class="task-list__meta">
                        {% if item.is_completed %}
                            <span>
                                {% trans "Попыток" %}: {{ item.attempts_count }}
                            </span>
                            <span>
                                {% trans "Время" %}:
                                {{ item.time_spent }}
                            </span>
                        {% else %}
                            <span>{% trans "Не выполнено" %}</span>
                        {% endif %}
                    </div>

                    {% if item.last_assessment %}
                        {% with skills=item.last_assessment.structured_feedback.skill_evaluation %}
                            <div class="task-list__skills">
                                {% for skill, data in skills.items %}
                                    {% if data.score != None %}
                                        <div class="task-list__skill">
                                            <span class="task-list__skill-name">
                                                {{ skill|capfirst }}
                                            </span>
                                            <span class="task-list__skill-score">
                                                {{ data.score|floatformat:2 }}
                                            </span>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endwith %}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </section>

    <!-- ===== Статистика ===== -->
    <section class="lesson-history__statistics">
        <h2 class="lesson-history__section-title">
            {% trans "Статистика" %}
        </h2>

        <div class="lesson-stats">
            <div class="lesson-stats__item">
                <span class="lesson-stats__label">{% trans "Средняя оценка" %}</span>
                <span class="lesson-stats__value">
                    {{ lesson_history.statistics.average_score|floatformat:2 }}
                </span>
            </div>

            <div class="lesson-stats__item">
                <span class="lesson-stats__label">{% trans "Общее время" %}</span>
                <span class="lesson-stats__value">
                    {{ lesson_history.statistics.total_time_spent }}
                </span>
            </div>

            <div class="lesson-stats__item">
                <span class="lesson-stats__label">{% trans "Выполнено" %}</span>
                <span class="lesson-stats__value">
                    {{ lesson_history.statistics.completion_rate|floatformat:2 }}
                </span>
            </div>
        </div>
    </section>

    <!-- ===== Прогресс навыков ===== -->
    <section class="lesson-history__skills">
        <h2 class="lesson-history__section-title">
            {% trans "Навыки" %}
        </h2>

        <ul class="skill-progress">
            {% for skill, data in lesson_history.skill_progress.items %}
                <li class="skill-progress__item">
                    <span class="skill-progress__name">
                        {{ skill|capfirst }}
                    </span>
                    <span class="skill-progress__value">
                        {{ data.before|floatformat:2 }}
                        →
                        {{ data.after|floatformat:2 }}
                    </span>
                    <span class="skill-progress__delta
                        {% if data.delta > 0 %}
                            skill-progress__delta--positive
                        {% elif data.delta < 0 %}
                            skill-progress__delta--negative
                        {% endif %}
                    ">
                        {{ data.delta|floatformat:2 }}
                    </span>
                </li>
            {% endfor %}
        </ul>
    </section>

    <!-- ===== Рекомендации ===== -->
    {% if lesson_history.recommendations %}
        <section class="lesson-history__recommendations">
            <h2 class="lesson-history__section-title">
                {% trans "Рекомендации" %}
            </h2>

            <ul class="recommendation-list">
                {% for rec in lesson_history.recommendations %}
                    <li class="recommendation-list__item
                        recommendation-list__item--priority-{{ rec.priority }}">
                        <span class="recommendation-list__skill">
                            {{ rec.skill|capfirst }}
                        </span>
                        <p class="recommendation-list__message">
                            {{ rec.message }}
                        </p>
                    </li>
                {% endfor %}
            </ul>
        </section>
    {% endif %}

</section>
{% endblock %}

