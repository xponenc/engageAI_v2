{% extends 'base.html' %}
{% load static %}

{% block css %}
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
{% endblock %}

{% block title %}
–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #{{ user_id }}
{% endblock title %}

{% block content %}
<div class="container container--fluid">
    <header class="header _mb-half">
        <h1 class="header__title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #{{ user_id }}</h1>
        <p class="header__subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º –∏ —Ä–∞—Å—Ö–æ–¥–∞–º</p>
    </header>

    <!-- –õ–æ–∫–∞–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar--local _mb">
        <ul class="navbar__list">
            <li class="navbar__item">
                <a href="{% url 'llm_logger:analytics'  %}" class="navbar__link">
                    <i class="fas fa-user navbar__link-icon"></i>
                    <span class="navbar__link-text">–û–±—â–∞—è</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="{% url 'llm_logger:analytics-user' %}?user_id=2"
                class="navbar__link is-active">
                    <i class="fas fa-user navbar__link-icon"></i>
                    <span class="navbar__link-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                </a>
            </li>
            <li class="navbar__item">
                <a href="{% url 'llm_logger:analytics-cost' %}" class="navbar__link">
                    <i class="fas fa-coins navbar__link-icon"></i>
                    <span class="navbar__link-text">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="metrics _mb">
        <div class="metrics__grid">
            <div class="metric-card metric-card--primary">
                <div class="metric-card__icon"><i class="fas fa-bolt"></i></div>
                <div class="metric-card__content">
                    <h3 class="metric-card__title">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
                    <div class="metric-card__value">{{ total_requests }}</div>
                </div>
            </div>

            <div class="metric-card metric-card--secondary">
                <div class="metric-card__icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="metric-card__content">
                    <h3 class="metric-card__title">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                    <div class="metric-card__value">${{ total_cost|floatformat:5 }}</div>
                </div>
            </div>

            <div class="metric-card metric-card--accent">
                <div class="metric-card__icon"><i class="fas fa-calculator"></i></div>
                <div class="metric-card__content">
                    <h3 class="metric-card__title">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                    <div class="metric-card__value">${{ avg_cost_per_request|floatformat:6 }}</div>
                </div>
            </div>

            <div class="metric-card {% if success_rate >= 95 %}metric-card--success{% elif success_rate >= 80 %}metric-card--warning{% else %}metric-card--danger{% endif %}">
                <div class="metric-card__icon"><i class="fas fa-check-circle"></i></div>
                <div class="metric-card__content">
                    <h3 class="metric-card__title">Success Rate</h3>
                    <div class="metric-card__value">{{ success_rate }}%</div>
                    <div class="metric-card__subtitle">
                        {% if success_rate >= 95 %}–û—Ç–ª–∏—á–Ω–æ{% elif success_rate >= 80 %}–ù–æ—Ä–º–∞–ª—å–Ω–æ{% else %}–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è{% endif %}
                    </div>
                </div>
            </div>

            <div class="metric-card metric-card--info">
                <div class="metric-card__icon"><i class="fas fa-clock"></i></div>
                <div class="metric-card__content">
                    <h3 class="metric-card__title">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
                    <div class="metric-card__value">{{ avg_duration|floatformat:2 }} —Å–µ–∫</div>
                    <div class="metric-card__subtitle">–Ω–∞ –∑–∞–ø—Ä–æ—Å</div>
                </div>
            </div>

            <div class="metric-card {% if anomaly_detected %}metric-card--danger{% else %}metric-card--success{% endif %}">
                <div class="metric-card__icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="metric-card__content">
                    <h3 class="metric-card__title">–ê–Ω–æ–º–∞–ª–∏—è</h3>
                    <div class="metric-card__value">{% if anomaly_detected %}–î–ê{% else %}–ù–ï–¢{% endif %}</div>
                </div>
            </div>
        </div>
    </div>

    {% if anomalies.detected %}
        <section class="analytics-section analytics-layout__recommendations">
            <div class="analytics-section__header">
                <h2 class="analytics-section__title">
                    <i class="fas fa-lightbulb"></i>
                    –ê–Ω–æ–º–∞–ª–∏–∏
                </h2>
            </div>
                    
            <div class="recommendations">
                {% for detail in anomalies.details %}
                    <div class="recommendation-card recommendation-card--warning">
                        <div class="recommendation-card__icon">
                            {% if detail.severity == 'HIGH' %}
                                <i class="fas fa-fire"></i> –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø
                            {% elif detail.severity == 'MEDIUM' %}
                                <i class="fas fa-exclamation-circle"></i> –°–†–ï–î–ù–Ø–Ø
                            {% else %}
                                <i class="fas fa-info-circle"></i> –ù–ò–ó–ö–ê–Ø
                            {% endif %}
                        </div>
                        <div class="recommendation-card__content">
                            <p>{{ detail.message }}</p>
                            <p><i class="fas fa-lightbulb"></i> <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> {{ detail.recommendation }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}
            

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º -->
    <section class="analytics-section _mb">
        <div class="analytics-section__header">
            <h2 class="analytics-section__title">
                <i class="fas fa-chart-pie"></i> –ü–æ —Ç–∏–ø–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤
            </h2>
        </div>

        <div class="analytics-table">
            <table class="analytics-table__table">
                <thead class="analytics-table__header">
                    <tr>
                        <th class="analytics-table__cell analytics-table__cell--header">–¢–∏–ø</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–ó–∞–ø—Ä–æ—Å–æ–≤</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–°—Ä–µ–¥–Ω—è—è</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–î–æ–ª—è</th>
                    </tr>
                </thead>
                <tbody class="analytics-table__body">
                    {% for stat in type_breakdown %}
                    <tr class="analytics-table__row">
                        <td class="analytics-table__cell">{{ stat.request_type }}</td>
                        <td class="analytics-table__cell analytics-table__cell--number">{{ stat.count }}</td>
                        <td class="analytics-table__cell analytics-table__cell--currency">${{ stat.cost|floatformat:5 }}</td>
                        <td class="analytics-table__cell analytics-table__cell--currency">${{ stat.avg_cost|floatformat:6 }}</td>
                        <td class="analytics-table__cell">
                            <div class="progress-bar">
                                <div class="progress-bar__fill" style="width: {{ stat.cost_percentage|floatformat:0 }}%"></div>
                                <span class="progress-bar__label" style="left: {{ stat.cost_percentage|floatformat:0 }}%;">
                                    {{ stat.cost_percentage|floatformat:0 }}%
                                </span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>


    <!-- –ß–∞—Å–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (24 —á–∞—Å–∞) -->

    <section class="analytics-section _mb">
        <div class="analytics-section__header">
            <h2 class="analytics-section__title"><i class="fas fa-list"></i> –ß–∞—Å–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞)</h2>
        </div>
        <div class="analytics-table">
            <table class="analytics-table__table">
                <thead class="analytics-table__header">
                    <tr>
                        <th class="analytics-table__cell analytics-table__cell--header">–ß–∞—Å</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–ó–∞–ø—Ä–æ—Å–æ–≤</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody class="analytics-table__body">
                    {% for hour in hourly_activity %}
                        <tr class="analytics-table__row {% if hour.requests > 50 %}table-danger{% elif hour.requests > 20 %}table-warning{% endif %}">
                            <td class="analytics-table__cell">{{ hour.hour|date:"Y-m-d H:00" }}</td>
                            <td class="analytics-table__cell">
                                <span class="badge {% if hour.requests > 50 %}bg-danger{% elif hour.requests > 20 %}bg-warning{% else %}bg-success{% endif %}">
                                    {{ hour.requests }}
                                </span>
                            </td>
                            <td class="analytics-table__cell">
                                {% if hour.requests > 50 %}
                                    <span class="badge bg-danger">–ê–ù–û–ú–ê–õ–ò–Ø</span>
                                {% elif hour.requests > 20 %}
                                    <span class="badge bg-warning">–í—ã—Å–æ–∫–∞—è</span>
                                {% else %}
                                    <span class="badge bg-success">–ù–æ—Ä–º–∞</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- –¢–æ–ø-5 —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ -->

    <section class="analytics-section _mb">
        <div class="analytics-section__header">
            <h2 class="analytics-section__title"><i class="fas fa-list"></i> –¢–æ–ø-5 —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</h2>
        </div>
        <div class="analytics-table">
            <table class="analytics-table__table">
                <thead class="analytics-table__header">
                    <tr>
                        <th class="analytics-table__cell analytics-table__cell--header">–í—Ä–µ–º—è</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–¢–∏–ø</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–ú–æ–¥–µ–ª—å</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–ö—É—Ä—Å/–£—Ä–æ–∫</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    </tr>
                </thead>
                <tbody class="analytics-table__body">
                    {% for req in expensive_requests %}
                    <tr class="analytics-table__row">
                        <td class="analytics-table__cell">{{ req.request_time|date:"Y-m-d H:i:s" }}</td>
                        <td class="analytics-table__cell"><span class="badge bg-info">{{ req.request_type }}</td>
                        <td class="analytics-table__cell">{{ req.model_name }}</td>
                        <td class="analytics-table__cell">
                            {% if req.course %}
                                <span class="badge bg-secondary">{{ req.course.title|truncatechars:30 }}</span>
                            {% elif req.lesson %}
                                <span class="badge bg-secondary">{{ req.lesson.title|truncatechars:30 }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="analytics-table__cell analytics-table__cell--currency">${{ req.cost_total|floatformat:6 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    
    
    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ -->
    <section class="analytics-section _mb">
        <div class="analytics-section__header">
            <h2 class="analytics-section__title"><i class="fas fa-list"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
        </div>
        <div class="analytics-table">
            <table class="analytics-table__table">
                <thead class="analytics-table__header">
                    <tr>
                        <th class="analytics-table__cell analytics-table__cell--header">–í—Ä–µ–º—è</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–¢–∏–ø</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–ú–æ–¥–µ–ª—å</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th class="analytics-table__cell analytics-table__cell--header">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody class="analytics-table__body">
                    {% for log in user_logs %}
                    <tr class="analytics-table__row">
                        <td class="analytics-table__cell">{{ log.request_time|date:"Y-m-d H:i:s" }}</td>
                        <td class="analytics-table__cell">{{ log.get_request_type_display }}</td>
                        <td class="analytics-table__cell">{{ log.model_name }}</td>
                        <td class="analytics-table__cell analytics-table__cell--currency">${{ log.cost_total|floatformat:6 }}</td>
                        <td class="analytics-table__cell">
                            <span class="badge bg-{% if log.status == 'SUCCESS' %}success{% elif log.status == 'ERROR' %}danger{% else %}warning{% endif %}">
                                {{ log.status }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock content %}
