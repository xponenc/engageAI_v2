{% extends 'extended/assistant_layout.html' %}
{% load static %}

{% block title %}Оценка урока · {{ enrollment.course.title }}{% endblock %}

{% block assistant_css %}
<link href="{% static 'css/learning-session.css' %}" rel="stylesheet">
{% endblock %}

{% block assistant_content %}
<section class="assessment">
    <div class="assessment__container" data-enrollment-id="{{ enrollment.id }}">

        <header class="assessment__header">
            <h1 class="assessment__course">{{ course.title }}</h1>
            <h2 class="assessment__lesson">{{ current_lesson.title }}</h2>
            <div class="assessment__meta">
                Урок {{ course_progress.current_lesson_number }} из {{ course_progress.total_lessons }} (пройдено {{ course_progress.course_progress.total_lessons }})
            </div>
        </header>

        <main class="assessment__content">
            {% if assessment_status.status == 'PENDING_ASSESSMENT' %}
                {% include 'curriculum/include/assessment_pending.html' %}
            {% elif assessment_status.status == 'COMPLETED' %}
                {% include 'curriculum/include/assessment_completed.html' %}
            {% elif assessment_status.status == 'ERROR' %}
                {% include 'curriculum/include/assessment_error.html' %}
            {% endif %}
        </main>

    </div>
</section>
{% endblock %}

{% block assistant_script %}
{% comment %} <script src="{% static 'js/assessment-progress.js' %}"></script> {% endcomment %}
<script src="{% static 'celery_progress/celery_progress.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const bar = document.querySelector("#progress-bar");
        if (bar) {
            var progressUrl = "{% url 'celery_progress:task_status' task_id %}";
            
            // Формируем целевой URL для редиректа после успеха
            var historyUrl = "{{ lesson_report_url }}";

            CeleryProgressBar.initProgressBar(progressUrl, {
                pollInterval: 1000,
                onSuccess: function() {
                    // Опционально: небольшая задержка для отображения "100%" или сообщения
                    setTimeout(function() {
                        window.location.href = historyUrl;
                    }, 1000);
                }
            });
        }
    });
</script>
{% endblock %}
