┌─────────────────────────────────────────────┐
│          EXTERNAL / ORCHESTRATION           │
│                                             │
│  (Chat, UI, Agent, Orchestrator, API)       │
│                                             │
│  decides WHEN to start learning flow        │
└───────────────────────┬─────────────────────┘
                        │
                        │ calls
                        │
┌───────────────────────▼─────────────────────┐
│              LearningService                │
│                                             │
│  Entry point учебного процесса              │
│                                             │
│  handle_response(enrollment, response)      │
└───────────────────────┬─────────────────────┘
                        │
                        │ sequential orchestration
                        │
        ┌───────────────┼───────────────────────────┐
        │               │                           │
        ▼               ▼                           ▼
┌──────────────┐ ┌──────────────┐         ┌─────────────────┐
│AssessmentSvc │ │SkillUpdateSvc│         │DecisionService  │
│              │ │              │         │                 │
│ response →   │ │ assessment → │         │ assessment +    │
│ Assessment   │ │ SkillSnapshot│         │ trajectories →  │
└──────┬───────┘ │              │         │ decision_code   │
       │         └──────┬───────┘         └────────┬────────┘
       │                │                            │
       ▼                ▼                            ▼
┌──────────────┐  ┌──────────────────┐      ┌──────────────────┐
│ Assessment   │  │ SkillSnapshot    │      │ decision_code    │
│ (immutable)  │  │ (immutable)      │      │ (string)         │
└──────────────┘  └──────────────────┘      └──────────────────┘
                        │
                        │ updates
                        ▼
              ┌─────────────────────────┐
              │ SkillTrajectoryUpdater  │
              │                         │
              │ snapshot → trajectory   │
              └───────────┬─────────────┘
                          │
                          ▼
                ┌─────────────────────┐
                │ SkillTrajectory     │
                │ (aggregated state)  │
                └─────────────────────┘
                        │
                        │ interprets decision
                        ▼
┌─────────────────────────────────────────────┐
│           ProgressionService                │
│                                             │
│ decision_code → next lesson / task          │
└───────────────────────┬─────────────────────┘
                        │
                        │ records fact
                        ▼
┌─────────────────────────────────────────────┐
│           TransitionRecorder                │
│                                             │
│ creates LessonTransition (audit fact)       │
└───────────────────────┬─────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────┐
│           LessonTransition                  │
│           (immutable, audit)                │
└─────────────────────────────────────────────┘

## СХЕМА ВЗАИМОДЕЙСТВИЯ СЕРВИСОВ: ПОДРОБНОЕ ОПИСАНИЕ

### Внешний контекст (External/Orchestration)
**Назначение:** инициация учебного процесса
**Ответственность:**
- определение момента запуска обучения
- интеграция с внешними системами (UI, чат-боты)
- управление сессиями
**Инварианты:**
- не содержит бизнес-логики обучения
- работает через LearningService API

Этот уровень полностью отделен от бизнес-логики, что позволяет легко менять UI или интегрировать систему с различными внешними сервисами.

### LearningService (входная точка)
**Назначение:** координация полного цикла учебного шага
**Ключевые операции:**
- получение текущего состояния обучения
- обработка ответа студента
- координация всех downstream сервисов
**Инварианты:**
- не хранит состояние между вызовами
- не принимает решений
- возвращает структурированный результат

LearningService выступает как фасад для всего процесса обучения, инкапсулируя сложность взаимодействия других сервисов.

### AssessmentService
**Назначение:** оценка ответа студента
**Стратегии:**
- автоматическая оценка для закрытых заданий
- интеграция с LLM для открытых заданий
- гибридная оценка
**Инварианты:**
- всегда создает immutable Assessment
- не изменяет состояние студента

AssessmentService абстрагирует детали оценки и обеспечивает единый интерфейс для разных типов заданий и методов оценки.

### SkillUpdateService
**Назначение:** обновление состояния навыков студента
**Ключевые действия:**
- вычисление дельт по навыкам
- создание SkillSnapshot
- запуск обновления SkillTrajectory
**Инварианты:**
- атомарное обновление всех связанных сущностей
- сохранение истории изменений

SkillUpdateService гарантирует целостность данных о навыках студента и обеспечивает отслеживание динамики прогресса.

### DecisionService
**Назначение:** принятие решения о следующем шаге обучения
**Входные данные:**
- Assessment
- SkillTrajectory
- контекст (professional tags, etc.)
**Стратегии:**
- простые правила для MVP
- ML-модели для production
- переопределение преподавателем
**Инварианты:**
- решение основано только на фактах
- не знает о реализации переходов

DecisionService содержит сложную бизнес-логику адаптации и изолирован от деталей реализации прогресса.

### SkillTrajectoryUpdater
**Назначение:** агрегация истории навыков в метрики
**Метрики:**
- trend (тренды)
- stability (стабильность)
- plateau (плато)
**Инварианты:**
- вычисления идут только по историческим данным
- один trajectory на (студент, навык)

SkillTrajectoryUpdater преобразует сырые данные в аналитически полезные метрики, которые используются для принятия решений.

### ProgressionService
**Назначение:** интерпретация decision_code в действия
**Поддерживаемые решения:**
- ADVANCE_TASK
- ADVANCE_LESSON
- REPEAT_TASK
- REPEAT_LESSON
- STOP
**Инварианты:**
- изменяет только состояние Enrollment
- не принимает решений

ProgressionService реализует механику перемещения по учебному контенту без знания о том, почему эти решения были приняты.

### TransitionRecorder
**Назначение:** фиксация фактов переходов в обучении
**Что сохраняет:**
- решение системы
- контекст (assessment, snapshot)
- переопределения преподавателя
**Инварианты:**
- запись происходит один раз
- объект неизменяем после создания

TransitionRecorder обеспечивает полную аудиторскую историю обучения для объяснений, дебага и аналитики.

## КЛЮЧЕВЫЕ АРХИТЕКТУРНЫЕ ПРИНЦИПЫ

### Четкое разделение ответственности
Каждый сервис имеет строго определенную область ответственности, что минимизирует сложность и упрощает поддержку.

### Неизменяемость критических объектов
Assessment, SkillSnapshot, LessonTransition неизменяемы после создания, что гарантирует воспроизводимость и аудит.

### Отказоустойчивость
Каждый сервис изолирован и может обрабатывать ошибки без остановки всего учебного процесса.

### Тестируемость
Сервисы не имеют состояния и легко тестируются в изоляции с использованием mock-объектов.

### Масштабируемость
Архитектура позволяет легко распараллеливать обработку и распределять нагрузку между разными экземплярами сервисов.