# prompts/templates.py
"""
Templates:

–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∞–≥–µ–Ω—Ç–∞
–ß–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è LLM –ø–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –æ—Ç–≤–µ—Ç–æ–≤
–í–∞–ª–∏–¥–∞—Ü–∏—é –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JSON-–æ—Ç–≤–µ—Ç–æ–≤
–ê–¥–∞–ø—Ç–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (Telegram, –≤–µ–±)
–ü–æ–¥–¥–µ—Ä–∂–∫—É –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
"""
import json
from datetime import datetime
from typing import Dict, Any


# engageai_core/ai/prompts/templates.py
def format_platform_message(platform: str, message_data: dict) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

    Args:
        platform: –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (telegram, web)
        message_data: –î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–≥–µ–Ω—Ç–∞

    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    """
    if platform == "telegram":
        return format_telegram_message(message_data)
    elif platform == "web":
        return format_web_message(message_data)
    else:
        return message_data.get("message", "")


def format_telegram_message(message_data: dict) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Markdown
    """
    message = message_data["message"]

    # –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –≤ Telegram
    if "agent_state" in message_data:
        agent_state = message_data["agent_state"]

        # –ï—Å–ª–∏ –µ—Å—Ç—å —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –µ–≥–æ –∫—Ä–∞—Å–∏–≤–æ
        if "learning_plan" in agent_state and agent_state["learning_plan"]:
            plan = agent_state["learning_plan"]
            message += "\n\nüìÖ **–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è:**\n"

            for i, lesson in enumerate(plan, 1):
                message += f"\n{i}. **{lesson['title']}**\n"
                message += f"‚è±Ô∏è {lesson['duration']} –º–∏–Ω—É—Ç | üéØ {lesson['type'].capitalize()}\n"
                message += f"üí¨ {lesson['description']}\n"
                if "personalization" in lesson and lesson["personalization"]:
                    message += f"‚ú® *–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:* {lesson['personalization']}\n"

        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫
        if "corrections" in agent_state and agent_state["corrections"]:
            message += "\n\n‚úèÔ∏è **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**\n"
            for corr in agent_state["corrections"]:
                message += f"‚ùå `{corr['original']}` ‚Üí ‚úÖ `{corr['corrected']}`\n"
                message += f"‚ÑπÔ∏è {corr['explanation']}\n\n"

        # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        if "progress_report" in agent_state and agent_state["progress_report"]:
            report = agent_state["progress_report"]
            message += "\n\nüìä **–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:**\n"
            message += f"üìà –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: {report['overall']}%\n"
            message += f"üî§ –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: {report['grammar']}%\n"
            message += f"üìñ –°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å: {report['vocabulary']}%\n"
            message += f"üó£Ô∏è –°–≤–æ–±–æ–¥–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ: {report['fluency']}%\n"

    return message


def format_web_message(message_data: dict) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

    TODO: –î–æ–±–∞–≤–∏—Ç—å HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    """
    return message_data.get("message", "")


def diagnostic_response_template(context: Dict[str, Any]) -> str:
    """
    –®–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞-–¥–∏–∞–≥–Ω–æ—Å—Ç–∞
    """
    return f"""
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
{{
    "message": "–í–∞—à –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç—É. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π. –ù–µ –±–æ–ª–µ–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.",
    "agent_state": {{
        "estimated_level": "A1/A2/B1/B2/C1/C2 –∏–ª–∏ null (–µ—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)",
        "confidence": "1-10 (–≤–∞—à–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –æ—Ü–µ–Ω–∫–µ —É—Ä–æ–≤–Ω—è)",
        "engagement_change": "-1/0/1 (–∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)",
        "new_goals": ["goal1", "goal2"] –∏–ª–∏ [] (–Ω–æ–≤—ã–µ —Ü–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã)",
        "profession": "–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏–ª–∏ '' (–µ—Å–ª–∏ –≤—ã—è–≤–ª–µ–Ω–∞)",
        "available_time": 180 –∏–ª–∏ null (–¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö –≤ –Ω–µ–¥–µ–ª—é, –µ—Å–ª–∏ –≤—ã—è–≤–ª–µ–Ω–æ)",
        "challenges": ["challenge1", "challenge2"] –∏–ª–∏ [] (—Å–ª–æ–∂–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã, –µ—Å–ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã)"
    }}
}}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:
1. message –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–º —Ç–æ–Ω–µ
2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
3. –ï—Å–ª–∏ –≤—ã —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –¥–∏–∞–ª–æ–≥ - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏ –∑–∞–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
4. –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –¥–∞–ª –æ—Ç–≤–µ—Ç - –∑–∞–¥–∞–≤–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –ª–æ–≥–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π—Ç–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ
5. –ù–µ –∑–∞–¥–∞–≤–∞–π—Ç–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑
6. –ï—Å–ª–∏ –≤—ã —É–≤–µ—Ä–µ–Ω—ã –≤ —É—Ä–æ–≤–Ω–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ (confidence >= 7) - –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –ø–ª–∞–Ω–∞

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:
- ID: {context.get('user_id', '–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}
- –£—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏: {context.get('engagement_level', 5)}
- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: {len(context.get('history', []))} —Å–æ–æ–±—â–µ–Ω–∏–π
"""


def curator_response_template(context: Dict[str, Any]) -> str:
    """
    –®–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞-–∫—É—Ä–∞—Ç–æ—Ä–∞
    """
    return f"""
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
{{
    "message": "–í–∞—à –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç—É. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º, —á–µ—Ç–∫–∏–º, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑—É. –ù–µ –±–æ–ª–µ–µ 3-4 –∞–±–∑–∞—Ü–µ–≤.",
    "agent_state": {{
        "engagement_change": "-1/0/1/2 (–∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞)",
        "learning_plan": [
            {{
                "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞",
                "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –∏ –µ–≥–æ –ø–æ–ª—å–∑—ã",
                "duration": 15,  // –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö
                "type": "grammar/vocabulary/speaking/listening/writing",
                "personalization": "–ö–∞–∫ —ç—Ç–æ—Ç —É—Ä–æ–∫ —Å–≤—è–∑–∞–Ω —Å —Ü–µ–ª—è–º–∏/–ø—Ä–æ—Ñ–µ—Å—Å–∏–µ–π —Å—Ç—É–¥–µ–Ω—Ç–∞"
            }}
        ] –∏–ª–∏ null (–µ—Å–ª–∏ –ø–ª–∞–Ω –µ—â–µ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω),
        "estimated_completion_time": "2 –Ω–µ–¥–µ–ª–∏" –∏–ª–∏ null (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫—É—Ä—Å–∞)
    }}
}}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:
1. message –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–µ–º —Ç–æ–Ω–µ
2. –ï—Å–ª–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç–µ —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω - –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –≤–∏–¥–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–∫–∞
3. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–≤—è–∂–∏—Ç–µ –ø–ª–∞–Ω —Å —Ü–µ–ª—è–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–≠—Ç–æ—Ç –ø–ª–∞–Ω –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –¥–æ—Å—Ç–∏—á—å –≤–∞—à–µ–π —Ü–µ–ª–∏ - —Å–≤–æ–±–æ–¥–Ω–æ –æ–±—â–∞—Ç—å—Å—è –Ω–∞ IT-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è—Ö")
4. –í –∫–æ–Ω—Ü–µ –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π—Ç–µ Call to Action (CTA) - –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–Ω—Ü–∏–ø SPV (–°–≤–æ–π—Å—Ç–≤–æ ‚Üí –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ ‚Üí –í—ã–≥–æ–¥–∞) –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —É—Ä–æ–∫–æ–≤
6. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:
- –£—Ä–æ–≤–µ–Ω—å: {context.get('english_level', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
- –¶–µ–ª–∏: {', '.join(context.get('learning_goals', ['–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã']))}
- –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {context.get('profession', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}
- –î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è: {context.get('available_time_per_week', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')} –º–∏–Ω—É—Ç –≤ –Ω–µ–¥–µ–ª—é
- –£—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏: {context.get('engagement_level', 5)}
"""


def teacher_response_template(context: Dict[str, Any]) -> str:
    """
    –®–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞-–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    """
    return f"""
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
{{
    "message": "–í–∞—à –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç—É. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—á–µ–±–Ω—ã–º, –Ω–æ –∂–∏–≤—ã–º, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏. –ù–µ –±–æ–ª–µ–µ 4 –∞–±–∑–∞—Ü–µ–≤.",
    "agent_state": {{
        "engagement_change": "-1/0/1/2 (–∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞)",
        "lesson_completed": true/false (–±—ã–ª –ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Ä–æ–∫)",
        "next_lesson_suggestion": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞ –∏–ª–∏ null",
        "corrections": [
            {{
                "original": "–æ—à–∏–±–∫–∞ –≤ —Ç–µ–∫—Å—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞",
                "corrected": "–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç",
                "explanation": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º"
            }}
        ] –∏–ª–∏ [] (–µ—Å–ª–∏ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫)
    }}
}}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:
1. message –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–º —É—á–µ–±–Ω–æ–º —Ç–æ–Ω–µ
2. –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–∏–ª —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ - —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Ö–≤–∞–ª–∏—Ç–µ –∑–∞ —É—Å–∏–ª–∏—è, –∑–∞—Ç–µ–º –¥–∞–π—Ç–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
3. –ü—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ - –±—É–¥—å—Ç–µ —Ç–∞–∫—Ç–∏—á–Ω—ã, –æ–±—ä—è—Å–Ω—è–π—Ç–µ –ø–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞ –∏ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. –í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ —É—Ä–æ–∫ —á–µ—Ç–∫–∏–º –≤—ã–≤–æ–¥–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥—ã –æ–±—É—á–µ–Ω–∏—è: Spaced_Repetition, Contextual_Learning, Error_Analysis, Fluency_Building, Vocabulary_Boosting
6. –°–≤—è–∑—ã–≤–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏ –∏–∑ –∂–∏–∑–Ω–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–ª–∏ –µ–≥–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä—ã

–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞:
- –¢–µ–∫—É—â–∏–π —É—Ä–æ–∫: {context.get('current_lesson_title', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
- –¢–∏–ø —É—Ä–æ–∫–∞: {context.get('lesson_type', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
- –£—Ä–æ–≤–µ–Ω—å —Å—Ç—É–¥–µ–Ω—Ç–∞: {context.get('english_level', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
- –ü—Ä–æ—Ñ–µ—Å—Å–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞: {context.get('profession', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}
- –£—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏: {context.get('engagement_level', 5)}
"""


def motivator_response_template(context: Dict[str, Any]) -> str:
    """
    –®–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞-–º–æ—Ç–∏–≤–∞—Ç–æ—Ä–∞
    """
    return f"""
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
{{
    "message": "–í–∞—à –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç—É. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ù–µ –±–æ–ª–µ–µ 2-3 –∞–±–∑–∞—Ü–µ–≤.",
    "agent_state": {{
        "engagement_change": "0/1/2/3 (–∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞)",
        "reward_granted": {{
            "type": "badge/points/achievement",
            "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã",
            "points": 50
        }} –∏–ª–∏ null (–µ—Å–ª–∏ –Ω–∞–≥—Ä–∞–¥–∞ –±—ã–ª–∞ –≤—ã–¥–∞–Ω–∞),
        "reminder_set": {{
            "time": "2024-01-15T10:00:00",
            "message": "–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"
        }} –∏–ª–∏ null (–µ—Å–ª–∏ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ)
    }}
}}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:
1. message –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –≤ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–º, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–µ–º —Ç–æ–Ω–µ
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–∫—Ä–æ-—Ç—Ä–∏–≥–≥–µ—Ä—ã –º–æ—Ç–∏–≤–∞—Ü–∏–∏: FOMO, –∫–æ–Ω—Ç—Ä–∞—Å—Ç, —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –æ–±—Ä–∞–∑
3. –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –ø—Ä–æ–ø—É—Å—Ç–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π - –Ω–∞–ø–æ–º–Ω–∏—Ç–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∏ –º–æ—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è
4. –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –¥–æ—Å—Ç–∏–≥ —Ä—É–±–µ–∂–∞ (7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥, –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å) - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–º–µ—Ç—å—Ç–µ —ç—Ç–æ –∏ –≤—Ä—É—á–∏—Ç–µ –Ω–∞–≥—Ä–∞–¥—É
5. –í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–π—Ç–µ Call to Action (CTA) - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
6. –ù–µ –¥–∞–≤–∏—Ç–µ –Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞, –±—É–¥—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º–∏ –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ö

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∑–∞–Ω—è—Ç–∏–µ: {context.get('last_lesson_date', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
- –î–Ω–µ–π –ø–æ–¥—Ä—è–¥: {context.get('streak_days', 0)}
- –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: {context.get('overall_progress', 0)}%
- –ë–∞–ª–ª—ã: {context.get('points', 0)}
- –ë–µ–π–¥–∂–∏: {', '.join(context.get('badges', [])) or '–Ω–µ—Ç'}
- –£—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏: {context.get('engagement_level', 5)}
- –¶–µ–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞: {', '.join(context.get('learning_goals', ['–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã']))}
"""


def analyst_response_template(context: Dict[str, Any]) -> str:
    """
    –®–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞
    """
    return f"""
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
{{
    "message": "–í–∞—à –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç—É. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º, —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ù–µ –±–æ–ª–µ–µ 3-4 –∞–±–∑–∞—Ü–µ–≤.",
    "agent_state": {{
        "engagement_change": "-1/0/1/2 (–∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞)",
        "progress_report": {{
            "grammar": 75,
            "vocabulary": 82,
            "fluency": 68,
            "pronunciation": 70,
            "overall": 74
        }} –∏–ª–∏ null (–µ—Å–ª–∏ –æ—Ç—á–µ—Ç –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω),
        "recommendations": [
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1",
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2"
        ] –∏–ª–∏ [] (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é)
    }}
}}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:
1. message –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–º, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–º —Ç–æ–Ω–µ
2. –ü–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–∏–∑—É–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã ("–í–∞—à —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –≤—ã—Ä–æ—Å –Ω–∞ 18% - —ç—Ç–æ –∫–∞–∫ –≤—ã—É—á–∏—Ç—å 42 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤–∞!")
3. –í—ã–¥–µ–ª—è–π—Ç–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞
4. –î–∞–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
5. –°–≤—è–∑—ã–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å —Å —Ü–µ–ª—è–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ ("–í—ã –Ω–∞ 32% –±–ª–∏–∂–µ –∫ —Ü–µ–ª–∏ - —Å–≤–æ–±–æ–¥–Ω–æ —á–∏—Ç–∞—Ç—å IT-—Å—Ç–∞—Ç—å–∏ –±–µ–∑ —Å–ª–æ–≤–∞—Ä—è")
6. –í –∫–æ–Ω—Ü–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ —É—Ä–æ–∫

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:
- –£—Ä–æ–≤–µ–Ω—å: {context.get('english_level', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')}
- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—Ä–æ–≤–Ω—è–º: {context.get('level_progress', '0%')}
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é:
  * –£—Ä–æ–∫–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: {context.get('lessons_completed_week', 0)}
  * –í—Ä–µ–º–µ–Ω–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: {context.get('time_spent_week', 0)} –º–∏–Ω—É—Ç
  * –û—à–∏–±–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: {context.get('errors_corrected_week', 0)}
- –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: {', '.join(context.get('strengths', [])) or '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã'}
- –°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞: {', '.join(context.get('weak_areas', [])) or '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã'}
- –¶–µ–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞: {', '.join(context.get('learning_goals', ['–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã']))}
"""


def default_response_template(context: Dict[str, Any]) -> str:
    """
    –®–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
    """
    return f"""
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
{{
    "message": "–í–∞—à –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç—É. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º.",
    "agent_state": {{
        "engagement_change": "-1/0/1 (–∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞)"
    }}
}}

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:
1. message –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –ë—É–¥—å—Ç–µ –ø–æ–ª–µ–∑–Ω—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏
3. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
4. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã –≤ –æ—Ç–≤–µ—Ç–µ - –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –ø–æ–º–æ—â—å –∏–ª–∏ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:
- –£—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏: {context.get('engagement_level', 5)}
"""


def format_json_response(raw_response: str) -> Dict[str, Any]:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç LLM –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON
    """
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
        start_idx = raw_response.find('{')
        end_idx = raw_response.rfind('}') + 1

        if start_idx == -1 or end_idx == 0:
            raise ValueError("No JSON structure found in response")

        json_str = raw_response[start_idx:end_idx]
        parsed = json.loads(json_str)

        # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if "message" not in parsed:
            parsed["message"] = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞."

        if "agent_state" not in parsed:
            parsed["agent_state"] = {"engagement_change": 0}

        return parsed
    except json.JSONDecodeError as e:
        print(f"JSON decode error: {e}")
        return {
            "message": "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å.",
            "agent_state": {"engagement_change": -1}
        }
    except Exception as e:
        print(f"Error formatting response: {e}")
        return {
            "message": "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ú–æ–∂–µ—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å?",
            "agent_state": {"engagement_change": 0}
        }


def get_platform_template(platform: str, message_data: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    """
    if platform == "telegram":
        return format_telegram_message(message_data)
    elif platform == "web":
        return format_web_message(message_data)
    else:
        return message_data.get("message", "")


def format_telegram_message(message_data: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Markdown
    """
    message = message_data["message"]

    # –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –≤ Telegram
    if "agent_state" in message_data:
        agent_state = message_data["agent_state"]

        # –ï—Å–ª–∏ –µ—Å—Ç—å —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω - —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –µ–≥–æ –∫—Ä–∞—Å–∏–≤–æ
        if "learning_plan" in agent_state and agent_state["learning_plan"]:
            plan = agent_state["learning_plan"]
            message += "\n\nüìÖ **–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è:**\n"

            for i, lesson in enumerate(plan, 1):
                message += f"\n{i}. **{lesson['title']}**\n"
                message += f"‚è±Ô∏è {lesson['duration']} –º–∏–Ω—É—Ç | üéØ {lesson['type'].capitalize()}\n"
                message += f"üí¨ {lesson['description']}\n"
                if "personalization" in lesson and lesson["personalization"]:
                    message += f"‚ú® *–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:* {lesson['personalization']}\n"

        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫
        if "corrections" in agent_state and agent_state["corrections"]:
            message += "\n\n‚úèÔ∏è **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**\n"
            for corr in agent_state["corrections"]:
                message += f"‚ùå `{corr['original']}` ‚Üí ‚úÖ `{corr['corrected']}`\n"
                message += f"‚ÑπÔ∏è {corr['explanation']}\n\n"

        # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        if "progress_report" in agent_state and agent_state["progress_report"]:
            report = agent_state["progress_report"]
            message += "\n\nüìä **–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:**\n"
            message += f"üìà –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: {report['overall']}%\n"
            message += f"üî§ –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: {report['grammar']}%\n"
            message += f"üìñ –°–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å: {report['vocabulary']}%\n"
            message += f"üó£Ô∏è –°–≤–æ–±–æ–¥–Ω–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ: {report['fluency']}%\n"

    return message


def format_web_message(message_data: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    """
    # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    # —Å HTML-—Ç–µ–≥–∞–º–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    return message_data.get("message", "")